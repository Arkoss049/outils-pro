<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Onglet Courrier ‚Äì G√©n√©rateur de lettres (Plus v4)</title>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" />
<style>
  :root { --bg:#0b1020; --fg:#e9eef7; --muted:#a9b4c4; --card:#121a33; --accent:#4da3ff; --border:#223156; }
  html,body {height:100%;}
  body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Helvetica Neue",sans-serif; background:var(--bg); color:var(--fg); }
  .wrap {max-width:1200px; margin:auto; padding:24px;}
  h1 {font-size:20px; margin:0 0 16px;}
  .grid {display:grid; gap:16px; grid-template-columns:380px 1fr;}
  .card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; }
  .card h2 {font-size:16px; margin:0 0 12px; color:var(--fg);}
  label {display:block; font-size:12px; color:var(--muted); margin:10px 0 6px;}
  input,select,textarea { width:100%; box-sizing:border-box; background:#0e1630; color:var(--fg); border:1px solid var(--border); border-radius:10px; padding:10px; font:inherit; }
  textarea {min-height:84px; resize:vertical;}
  .row {display:grid; gap:10px; grid-template-columns:1fr 1fr;}
  .btns {display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
  button { border:1px solid var(--border); background:#122043; color:var(--fg); border-radius:999px; padding:10px 14px; cursor:pointer; }
  button.primary { background:var(--accent); color:#04162b; border-color:#3d7fcc; font-weight:600; }
  .muted {color:var(--muted); font-size:12px;}
  .preview { background:#fff; color:#111; border-radius:12px; overflow:hidden; border:1px solid #e6e6e6; }
  .sheet { width:210mm; min-height:297mm; padding:20mm; box-sizing:border-box; margin:auto; background:#ffffff; color:#111; }
  .letterhead {display:flex; justify-content:space-between; font-size:12px; color:#333;}
  .letterhead strong {font-weight:700;}
  .block {margin-top:12px;}
  .subject {margin-top:12px; font-weight:700;}
  .body p {margin:0 0 10px; line-height:1.5;}
  .footer {margin-top:24px; font-size:12px; color:#555;}
  .chips {display:flex; flex-wrap:wrap; gap:6px; margin:8px 0 0;}
  .chip {font-size:11px; padding:6px 10px; border-radius:999px; background:#eef3ff; color:#0a1d3b; border:1px solid #cddfff;}
  .sticky {position:sticky; top:16px;}
  .row-3 {display:grid; gap:10px; grid-template-columns:1fr 1fr 1fr;}
  .kbd {font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; font-size:12px;}
  .note {background:#0e1630; border:1px dashed var(--border); border-radius:12px; padding:10px; color:var(--muted);}
  .help {font-size:12px; color:#99a5b7; margin-top:6px;}
  .taghint {font-size:11px; color:#a7b3c6;}
  @media (max-width:980px){ .grid{grid-template-columns:1fr;} .sticky{position:static;} }
  @media print { body{background:#fff; color:#000;} .wrap,.card{padding:0; border:none; background:#fff;} .grid{display:block;} .no-print{display:none !important;} .sheet{width:auto; min-height:auto; padding:0; margin:0;} }
  .pill-danger{background:#4b1e1e; border-color:#7a2b2b;}
</style>
</head>
<body>
<div class="wrap">
  <h1>‚úâÔ∏è G√©n√©rateur de courriers ‚Äì Harmonie (Plus v4)</h1>
  <div class="grid">
    <div class="card sticky">
      <h2>Mod√®le & variables</h2>
      <label for="templateSelect">Mod√®le de courrier</label>
      <select id="templateSelect"></select>
      <div id="templateInfo" class="muted" style="margin-top:6px;"></div>
      <div class="chips" id="chips"></div>

      <div class="btns" style="margin-top:8px;">
        <button id="btnNew">Nouveau mod√®le</button>
        <button id="btnEdit">√âditer</button>
        <button id="btnClone">Cloner ‚Üí perso</button>
      </div>
      <div class="btns" style="margin-top:6px;">
        <button id="btnRemove" class="pill-danger">üóëÔ∏è Supprimer ce mod√®le (d√©finitif)</button>
      </div>
      <div class="btns" style="margin-top:6px;">
        <button id="btnExport">Exporter mes mod√®les</button>
        <button id="btnImport">Importer</button>
      </div>
      <div class="help">Utilisez des variables entre doubles accolades, ex. <span class="kbd">{{Contrat_Numero}}</span>, <span class="kbd">{{Date_Echeance}}</span>.</div>

      <div class="row" style="margin-top:12px;">
        <div><label for="ville">Ville</label><input id="ville" placeholder="ex. Nantes" /></div>
        <div><label for="dateAuto">Date</label><input id="dateAuto" /></div>
      </div>

      <h2 style="margin-top:18px;">Exp√©diteur</h2>
      <label for="expNom">Nom & fonction</label><input id="expNom" placeholder="Pr√©nom NOM ‚Äì Fonction" />
      <label for="expOrg">Organisation</label><input id="expOrg" placeholder="Harmonie Mutuelle" />
      <label for="expAdr">Adresse</label><textarea id="expAdr" placeholder="Adresse (lignes)"></textarea>
      <div class="row">
        <div><label for="expTel">T√©l√©phone</label><input id="expTel" placeholder="+33 ..." /></div>
        <div><label for="expMail">E-mail</label><input id="expMail" placeholder="prenom.nom@..." /></div>
      </div>

      <h2 style="margin-top:18px;">Destinataire</h2>
      <label for="destNom">Soci√©t√© / Service</label><input id="destNom" placeholder="Pacifica / Service r√©siliation" />
      <label for="destAttention">√Ä l‚Äôattention de</label><input id="destAttention" placeholder="Madame / Monsieur ..." />
      <label for="destAdr">Adresse</label><textarea id="destAdr" placeholder="Adresse (lignes)"></textarea>

      <div id="dynamicFields"></div>

      <div class="btns">
        <button class="primary" id="btnPreview">Mettre √† jour l‚Äôaper√ßu</button>
        <button id="btnCopy">Copier le texte</button>
        <button id="btnPDF">T√©l√©charger en PDF</button>
        <button id="btnReset" class="no-print">R√©initialiser</button>
      </div>
      <div class="muted" style="margin-top:6px;">Coordonn√©es & mod√®les perso/retir√©s stock√©s en local (localStorage).</div>
    </div>

    <div class="card">
      <h2>Aper√ßu</h2>
      <div class="preview" id="preview"><div class="sheet" id="sheet"></div></div>

      <div class="card" id="editorCard" style="margin-top:16px; display:none;">
        <h2>√âditeur de mod√®le</h2>
        <div class="note">Cr√©ez vos mod√®les avec variables <span class="kbd">{{Nom_Variable}}</span>.</div>
        <div class="row-3" style="margin-top:12px;">
          <div><label for="mdl_name">Nom du mod√®le</label><input id="mdl_name" placeholder="ex. Relance J+7 Devis sant√©"/></div>
          <div><label for="mdl_tags">Tags (virgules)</label><input id="mdl_tags" placeholder="sant√©, relance, devis"/></div>
          <div><label for="mdl_id">ID</label><input id="mdl_id" placeholder="auto" disabled /></div>
        </div>
        <label for="mdl_desc">Description</label><textarea id="mdl_desc" placeholder="Courte description du mod√®le"></textarea>
        <label for="mdl_subject">Sujet (objet du courrier)</label><input id="mdl_subject" placeholder="Objet : ..." />
        <label for="mdl_body">Corps</label><textarea id="mdl_body" style="min-height:160px;" placeholder="Texte du courrier..."></textarea>
        <div class="btns">
          <button id="mdl_save" class="primary">Enregistrer</button>
          <button id="mdl_cancel">Annuler</button>
          <button id="mdl_delete" style="display:none;">Supprimer</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- PDF libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ===== Mod√®les int√©gr√©s (5 d'origine + 10 nouveaux) ===== */
const BUILTIN_TEMPLATES = [
  /* originaux */
  { id:"resiliation_etranger", label:"R√©siliation ‚Äì D√©part √† l‚Äô√©tranger (compl√©mentaire sant√©)", tags:["sant√©","r√©siliation","LRAR"], description:"Fin du contrat sant√© pour changement de situation (d√©part durable √† l‚Äô√©tranger).", subject:"Demande de r√©siliation de contrat ‚Äì D√©part √† l‚Äô√©tranger ‚Äì {{Contrat_Numero}}", body:`Madame, Monsieur,

Je vous informe de mon d√©part √† l‚Äô√©tranger √† compter du {{Date_Depart}} (pays : {{Pays}}), situation entra√Ænant la fin de mon affiliation fran√ßaise et un changement durable de situation.
En cons√©quence, je vous demande la r√©siliation de mon contrat de compl√©mentaire sant√© n¬∞ {{Contrat_Numero}}, au plus t√¥t √† compter de la r√©ception de la pr√©sente.

Je joins un justificatif (copie de billet d‚Äôavion / attestation d‚Äôinstallation).
Je vous remercie de m‚Äôadresser un courrier confirmant la date de r√©siliation et le solde √©ventuel.

Veuillez agr√©er, Madame, Monsieur, l‚Äôexpression de mes salutations distingu√©es.` },
  { id:"resiliation_echeance", label:"R√©siliation √† l‚Äô√©ch√©ance (compl√©mentaire sant√©)", tags:["sant√©","r√©siliation","√©ch√©ance"], description:"Demande de non-reconduction √† la date anniversaire.", subject:"R√©siliation √† l‚Äô√©ch√©ance ‚Äì Contrat n¬∞ {{Contrat_Numero}} ‚Äì √âch√©ance du {{Date_Echeance}}", body:`Madame, Monsieur,

Par la pr√©sente, je vous informe de ma volont√© de ne pas reconduire mon contrat de compl√©mentaire sant√© n¬∞ {{Contrat_Numero}} √† son √©ch√©ance du {{Date_Echeance}}.

Je vous remercie de m‚Äôadresser un √©crit confirmant la date de r√©siliation et l‚Äôarr√™t des pr√©l√®vements √† compter de cette √©ch√©ance.

Veuillez agr√©er, Madame, Monsieur, mes salutations distingu√©es.` },
  { id:"renonciation_gav", label:"Renonciation ‚Äì Garantie Accidents de la Vie (GAV)", tags:["pr√©voyance","GAV","renonciation"], description:"Exercice du droit de renonciation dans le d√©lai l√©gal apr√®s souscription √† distance / hors √©tablissement.", subject:"Renonciation au contrat GAV n¬∞ {{Contrat_Numero}} (souscrit le {{Date_Souscription}})", body:`Madame, Monsieur,

Je vous informe exercer mon droit de renonciation au contrat Garantie Accidents de la Vie n¬∞ {{Contrat_Numero}}, souscrit le {{Date_Souscription}}.
Cette renonciation intervient dans le d√©lai l√©gal. Je vous remercie d‚Äôen accuser r√©ception, d‚Äôannuler le contrat et de proc√©der au remboursement des sommes √©ventuellement per√ßues.

Veuillez agr√©er, Madame, Monsieur, l‚Äôassurance de ma consid√©ration distingu√©e.` },
  { id:"mise_en_demeure_remb", label:"Mise en demeure ‚Äì Remboursement apr√®s r√©siliation (Habitation)", tags:["habitation","mise en demeure","remboursement"], description:"LRAR pour obtenir le remboursement des pr√©l√®vements post-r√©siliation.", subject:"Mise en demeure de rembourser ‚Äì Contrat n¬∞ {{Contrat_Numero}} ‚Äì R√©siliation effective le {{Date_Resiliation}}", body:`Madame, Monsieur,

Malgr√© ma r√©siliation re√ßue par vos services le {{Date_AR}} (accus√© de r√©ception joint) pour le contrat n¬∞ {{Contrat_Numero}}, des pr√©l√®vements ont √©t√© effectu√©s les {{Dates_Prelevements}}.

Par la pr√©sente, je vous mets en demeure de rembourser la somme totale de {{Montant_Total}} ‚Ç¨ sous huit (8) jours √† compter de la r√©ception de ce courrier, par virement sur le RIB ci-joint, et de confirmer par √©crit la cl√¥ture du contrat et l‚Äôarr√™t d√©finitif de tout pr√©l√®vement.

√Ä d√©faut, je me verrai contraint d‚Äôengager les d√©marches n√©cessaires.

Veuillez agr√©er, Madame, Monsieur, mes salutations distingu√©es.` },
  { id:"attestation_sans_kbis", label:"Attestation ‚Äì Micro-entreprise sans K-bis (r√©ponse gestion)", tags:["attestation","pro","micro-entreprise"], description:"R√©ponse type expliquant l‚Äôabsence de K-bis pour micro-entreprise.", subject:"Attestation relative √† l‚Äôimmatriculation ‚Äì Micro-entreprise", body:`Madame, Monsieur,

Je soussign√©(e) {{Nom_Complet}}, micro-entrepreneur(se) exer√ßant l‚Äôactivit√© {{Activite}}, N¬∞ SIREN/SIRET {{SIREN}}, atteste ne pas √™tre immatricul√©(e) au Registre du Commerce et des Soci√©t√©s.

√Ä ce titre, aucun extrait K-bis ne peut √™tre produit. Je vous transmets en pi√®ces jointes l‚Äôextrait d‚Äôimmatriculation au r√©pertoire (INSEE) et toute attestation utile.

Je reste √† votre disposition pour toute information compl√©mentaire et vous prie d‚Äôagr√©er, Madame, Monsieur, mes salutations distingu√©es.` },

  /* nouveaux (pack) */
  { id:"changement_beneficiaire_av", label:"Changement / suppression de b√©n√©ficiaire ‚Äì Assurance vie / D√©c√®s", tags:["assurance vie","d√©c√®s","b√©n√©ficiaire"], description:"Demande d‚Äôavenant pour modifier ou supprimer la clause b√©n√©ficiaire.", subject:"Modification de clause b√©n√©ficiaire ‚Äì Contrat n¬∞ {{Contrat_Numero}}", body:`Madame, Monsieur,

Je vous demande la modification de la clause b√©n√©ficiaire du contrat n¬∞ {{Contrat_Numero}} √† compter du {{Date_Souhaitee}}.

Clause actuelle : {{Clause_Actuelle}}
Nouvelle clause : {{Clause_Nouvelle}} (ou : suppression de {{Beneficiaire_Supprime}}).

Je joins les justificatifs n√©cessaires (pi√®ce d‚Äôidentit√©, livret de famille le cas √©ch√©ant). Merci de me transmettre l‚Äôavenant √† signer et la confirmation √©crite.

Veuillez agr√©er, Madame, Monsieur, mes salutations distingu√©es.` },
  { id:"resiliation_collectif_obligatoire", label:"R√©siliation ‚Äì Contrat collectif d‚Äôentreprise obligatoire", tags:["sant√©","r√©siliation","collectif obligatoire"], description:"R√©siliation du contrat sant√© individuel suite √† l‚Äôadh√©sion √† une mutuelle d‚Äôentreprise obligatoire.", subject:"R√©siliation pour adh√©sion √† une mutuelle d‚Äôentreprise ‚Äì Contrat n¬∞ {{Contrat_Numero}}", body:`Madame, Monsieur,

Je vous informe de mon adh√©sion au contrat collectif obligatoire de mon employeur {{Employeur}} √† compter du {{Date_Adhesion_Collectif}}.

Conform√©ment √† la r√©glementation, je vous demande la r√©siliation de mon contrat de compl√©mentaire sant√© individuel n¬∞ {{Contrat_Numero}}, √† effet du {{Date_Effet_Resiliation}} ou, √† d√©faut, √† la date de r√©ception du pr√©sent courrier.

Veuillez trouver jointe l‚Äôattestation de mon employeur. Merci de confirmer par √©crit la date de fin de garantie et l‚Äôarr√™t des pr√©l√®vements.

Veuillez agr√©er, Madame, Monsieur, mes salutations distingu√©es.` },
  { id:"rachat_partiel_assurance_vie", label:"Demande de rachat partiel ‚Äì Assurance vie", tags:["assurance vie","rachat","√©pargne"], description:"Demande de rachat partiel avec modalit√©s de fiscalit√© et de versement.", subject:"Demande de rachat partiel ‚Äì Contrat n¬∞ {{Contrat_Numero}} ‚Äì {{Montant}} ‚Ç¨", body:`Madame, Monsieur,

Je vous prie d‚Äôeffectuer un rachat partiel sur mon contrat n¬∞ {{Contrat_Numero}} pour un montant de {{Montant}} ‚Ç¨ (en lettres : {{Montant_En_Lettres}}).

Modalit√©s souhait√©es : {{Modalites_Rachat}} (ex. prorata des supports / en priorit√© fonds en euros).
Option fiscale : {{Option_Fiscale}} (PFU/pr√©l√®vement forfaitaire ou bar√®me IR).
Merci de virer les fonds sur l‚ÄôIBAN suivant : {{IBAN}} (titulaire : {{Titulaire_Compte}}).

Je reste √† votre disposition pour tout compl√©ment et vous remercie de m‚Äôadresser un avenant/relev√© apr√®s op√©ration.

Veuillez agr√©er, Madame, Monsieur, mes salutations distingu√©es.` },
  { id:"avance_assurance_vie", label:"Demande d‚Äôavance sur contrat ‚Äì Assurance vie", tags:["assurance vie","avance","√©pargne"], description:"Demande d‚Äôavance avec montant, dur√©e et modalit√©s de restitution.", subject:"Demande d‚Äôavance ‚Äì Contrat n¬∞ {{Contrat_Numero}} ‚Äì {{Montant}} ‚Ç¨", body:`Madame, Monsieur,

Je sollicite une avance sur mon contrat d‚Äôassurance vie n¬∞ {{Contrat_Numero}} d‚Äôun montant de {{Montant}} ‚Ç¨ pour une dur√©e souhait√©e de {{Duree_Mois}} mois.

Je prends acte des conditions financi√®res applicables (taux, frais, modalit√©s de remboursement). Merci de me transmettre le dossier et l‚Äô√©ch√©ancier, et de proc√©der au versement sur l‚ÄôIBAN : {{IBAN}}.

Veuillez agr√©er, Madame, Monsieur, mes salutations distingu√©es.` },
  { id:"transfert_per_sortant", label:"Transfert sortant ‚Äì PER (vers un autre organisme)", tags:["PER","transfert","√©pargne retraite"], description:"Demande de transfert sortant du PER vers un organisme r√©cepteur.", subject:"Demande de transfert sortant PER n¬∞ {{PER_Numero}} vers {{Organisme_Reception}}", body:`Madame, Monsieur,

Je souhaite proc√©der au transfert de mon Plan d‚Äô√âpargne Retraite n¬∞ {{PER_Numero}} vers l‚Äôorganisme r√©cepteur {{Organisme_Reception}} (coordonn√©es : {{Coordonnees_Organisme}}).

Merci d‚Äôadresser la valeur de transfert et les √©l√©ments n√©cessaires √† l‚Äôorganisme r√©cepteur, et de m‚Äôinformer de la date pr√©visionnelle d‚Äôex√©cution. Je joins les pi√®ces utiles (relev√© d‚Äôinformations, RIB, formulaire r√©cepteur, etc.).

Veuillez agr√©er, Madame, Monsieur, mes salutations distingu√©es.` },
  { id:"versement_libre_exceptionnel", label:"Versement libre (AV ou PER) + instruction d‚Äôarbitrage", tags:["assurance vie","PER","versement"], description:"Courrier d‚Äôaccompagnement d‚Äôun virement avec r√©partition des supports.", subject:"Versement libre de {{Montant}} ‚Ç¨ sur contrat n¬∞ {{Contrat_Numero}}", body:`Madame, Monsieur,

Je vous informe avoir proc√©d√© √† un versement de {{Montant}} ‚Ç¨ en date du {{Date_Versement}} sur le contrat n¬∞ {{Contrat_Numero}} (r√©f√©rence virement : {{Reference_Virement}}).

R√©partition/arbitrage souhait√© : {{Arbitrage_Souhaite}}.
Je vous remercie de me transmettre la confirmation d‚Äôop√©ration et la mise √† jour de la situation du contrat.

Veuillez agr√©er, Madame, Monsieur, mes salutations distingu√©es.` },
  { id:"changement_rib_sepa", label:"Changement de RIB / mandat SEPA", tags:["administratif","SEPA","pr√©l√®vements"], description:"Mise √† jour des coordonn√©es bancaires et du mandat de pr√©l√®vement.", subject:"Mise √† jour RIB et mandat SEPA ‚Äì Contrat n¬∞ {{Contrat_Numero}}", body:`Madame, Monsieur,

Merci de mettre √† jour mes coordonn√©es bancaires pour les pr√©l√®vements du contrat n¬∞ {{Contrat_Numero}} √† compter du {{Date_Effet}}.

Nouveau RIB (IBAN) : {{IBAN}} ‚Äì Titulaire : {{Titulaire_Compte}}.
Je vous prie d‚Äô√©tablir le mandat SEPA correspondant et de me confirmer la prise en compte.

Veuillez agr√©er, Madame, Monsieur, mes salutations distingu√©es.` },
  { id:"ajout_supp_ayant_droit_sante", label:"Ajout / Suppression d‚Äôayant droit ‚Äì Contrat sant√©", tags:["sant√©","ayant droit","famille"], description:"Demande de mise √† jour des ayants droit (conjoint/enfant).", subject:"{{Type_Action}} d‚Äôayant droit ‚Äì Contrat n¬∞ {{Contrat_Numero}} ‚Äì {{Nom_Ayant_Droit}}", body:`Madame, Monsieur,

Je vous demande le {{Type_Action}} d‚Äôayant droit sur mon contrat n¬∞ {{Contrat_Numero}}.

Identit√© : {{Nom_Ayant_Droit}} ‚Äì n√©(e) le {{Date_Naissance}} ‚Äì lien : {{Lien_Parente}}.
√âv√©nement d√©clencheur : {{Evenement}} (date : {{Date_Evenement}}).
Je joins les justificatifs utiles (acte de naissance, attestation, etc.).

Merci de me confirmer la prise en compte et la date d‚Äôeffet.

Veuillez agr√©er, Madame, Monsieur, mes salutations distingu√©es.` },
  { id:"maj_adresse_etat_civil", label:"Mise √† jour d‚Äôadresse / √©tat civil", tags:["administratif","adresse","√©tat civil"], description:"Signalement de changement d‚Äôadresse et/ou d‚Äô√©tat civil.", subject:"Mise √† jour de mes coordonn√©es ‚Äì Contrat n¬∞ {{Contrat_Numero}}", body:`Madame, Monsieur,

Merci d‚Äôenregistrer la mise √† jour suivante sur mon dossier/contrat n¬∞ {{Contrat_Numero}} :

Nouvelle adresse : {{Nouvelle_Adresse}} (√† compter du {{Date_Effet}}).
Nouveau statut d‚Äô√©tat civil : {{Nouvel_Etat_Civil}} (le cas √©ch√©ant, justificatif joint).

Je vous remercie de confirmer la mise √† jour et de m‚Äôadresser les prochains documents √† la nouvelle adresse.

Veuillez agr√©er, Madame, Monsieur, mes salutations distingu√©es.` },
  { id:"reclamation_reexamen_prestations", label:"R√©clamation ‚Äì R√©examen d‚Äôun remboursement / sinistre", tags:["r√©clamation","sant√©","GAV"], description:"Demande de r√©examen d‚Äôun dossier avec pi√®ces justificatives.", subject:"Demande de r√©examen ‚Äì Dossier n¬∞ {{Reference_Dossier}}", body:`Madame, Monsieur,

Je sollicite le r√©examen du dossier n¬∞ {{Reference_Dossier}} relatif √† {{Objet_Dossier}}.

Montant contest√© / non rembours√© : {{Montant_Conteste}} ‚Ç¨.
√âl√©ments compl√©mentaires : {{Elements_Complementaires}}.
Vous trouverez en pi√®ces jointes : {{Liste_Pieces}}.

Je vous remercie par avance pour votre retour motiv√© et la r√©gularisation si n√©cessaire.

Veuillez agr√©er, Madame, Monsieur, mes salutations distingu√©es.` },
  { id:"renonciation_per", label:"Renonciation ‚Äì PER (d√©lai l√©gal de 30 jours)", tags:["PER","renonciation","√©pargne retraite"], description:"Exercice du droit de renonciation au PER dans le d√©lai l√©gal apr√®s souscription.", subject:"Renonciation au PER n¬∞ {{PER_Numero}} (souscrit le {{Date_Souscription}})", body:`Madame, Monsieur,

J‚Äôexerce mon droit de renonciation au PER n¬∞ {{PER_Numero}}, souscrit le {{Date_Souscription}}, dans le d√©lai l√©gal de 30 jours.

Merci d‚Äôannuler le contrat et de rembourser les sommes vers√©es, le cas √©ch√©ant, sur l‚ÄôIBAN : {{IBAN}}. Je vous remercie de m‚Äôadresser une confirmation √©crite.

Veuillez agr√©er, Madame, Monsieur, mes salutations distingu√©es.` }
];

/* ===== Stockage ===== */
const STORAGE_DEFAULTS = 'courrier.defaults';
const STORAGE_USER_TEMPLATES = 'courrier.userTemplates';
const STORAGE_REMOVED_BUILTINS = 'courrier.removedBuiltins'; // pas d'archivage/restauration UI
let userTemplates = [];
let removedBuiltins = [];

/* ===== Utils ===== */
const qs = (s, el=document) => el.querySelector(s);
const qsa = (s, el=document) => Array.from(el.querySelectorAll(s));
const slugify = s => String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
const frLongDate = (d=new Date()) => new Intl.DateTimeFormat('fr-FR', { dateStyle: 'long' }).format(d);
function extractPlaceholders(text){ const set=new Set(); const re=/{{\s*([A-Za-z0-9_]+)\s*}}/g; let m; while((m=re.exec(text||''))){ set.add(m[1]); } return Array.from(set); }
function uniquePlaceholders(tpl){ return Array.from(new Set([ ...extractPlaceholders(tpl.subject), ...extractPlaceholders(tpl.body) ])); }
function substitute(str, vars){ return (str||'').replace(/{{\s*([A-Za-z0-9_]+)\s*}}/g,(_,k)=>(vars[k]??`{{${k}}}`)); }

/* ===== Templates ===== */
function loadUserTemplates(){ try{ userTemplates = JSON.parse(localStorage.getItem(STORAGE_USER_TEMPLATES)) || []; }catch{ userTemplates=[]; } }
function saveUserTemplates(){ localStorage.setItem(STORAGE_USER_TEMPLATES, JSON.stringify(userTemplates)); }
function loadRemoved(){ try{ removedBuiltins = JSON.parse(localStorage.getItem(STORAGE_REMOVED_BUILTINS)) || []; }catch{ removedBuiltins=[]; } }
function saveRemoved(){ localStorage.setItem(STORAGE_REMOVED_BUILTINS, JSON.stringify(removedBuiltins)); }
function allTemplates(){
  const built = BUILTIN_TEMPLATES.filter(t => !removedBuiltins.includes(t.id)).map(t=>({...t,_isUser:false}));
  const usr = userTemplates.map(t=>({...t,_isUser:true}));
  return [...built, ...usr];
}

/* ===== Defaults ===== */
function saveDefaults(){
  const data = { expNom:qs('#expNom').value, expOrg:qs('#expOrg').value, expAdr:qs('#expAdr').value, expTel:qs('#expTel').value, expMail:qs('#expMail').value, ville:qs('#ville').value };
  localStorage.setItem(STORAGE_DEFAULTS, JSON.stringify(data));
}
function loadDefaults(){
  const raw = localStorage.getItem(STORAGE_DEFAULTS);
  if(!raw){
    qs('#expNom').value = "Damien Richard ‚Äì Conseiller commercial";
    qs('#expOrg').value = "Harmonie Mutuelle";
    qs('#expAdr').value = "Agence de Nantes\n9 Rue Julien Videment\n44200 Nantes";
    qs('#expTel').value = "";
    qs('#expMail').value = "";
    qs('#ville').value = "Nantes";
    qs('#dateAuto').value = frLongDate();
    return;
  }
  try{ const d=JSON.parse(raw);
    qs('#expNom').value=d.expNom||""; qs('#expOrg').value=d.expOrg||""; qs('#expAdr').value=d.expAdr||"";
    qs('#expTel').value=d.expTel||""; qs('#expMail').value=d.expMail||""; qs('#ville').value=d.ville||""; qs('#dateAuto').value=frLongDate();
  }catch{}
}

/* ===== UI ===== */
function populateTemplates(preserve=true){
  const sel = qs('#templateSelect'); const current = sel.value; sel.innerHTML="";
  const list = allTemplates();
  list.forEach(t=>{ const o=document.createElement('option'); o.value=t.id; o.textContent=(t._isUser?'‚≠ê ':'')+t.label; sel.appendChild(o); });
  if(preserve && current){ sel.value=current; if(!sel.value) sel.selectedIndex=0; }
  if(!sel.value && list.length>0){ sel.selectedIndex=0; }
  onTemplateChange();
}
function onTemplateChange(){
  const id = qs('#templateSelect').value;
  const tpl = allTemplates().find(t=>t.id===id); if(!tpl) return;
  qs('#templateInfo').textContent = tpl.description||"";
  const chips = qs('#chips'); chips.innerHTML="";
  (tpl.tags||[]).forEach(tag=>{ const s=document.createElement('span'); s.className='chip'; s.textContent=tag; chips.appendChild(s); });
  const ph = uniquePlaceholders(tpl); const dyn = qs('#dynamicFields'); dyn.innerHTML="";
  if(ph.length){ const h=document.createElement('h2'); h.textContent="Champs du mod√®le"; h.style.marginTop="18px"; dyn.appendChild(h); }
  ph.forEach(name=>{ const id='ph_'+name; const lab=document.createElement('label'); lab.htmlFor=id; lab.textContent=name.replaceAll('_',' ');
    const inp=document.createElement('input'); inp.id=id; inp.placeholder=name; dyn.appendChild(lab); dyn.appendChild(inp); });
  renderPreview();
}
function collectVars(){
  const v={ Date:qs('#dateAuto').value||frLongDate(), Ville:qs('#ville').value||"", Dest_Nom:qs('#destNom').value||"", Dest_Attention:qs('#destAttention').value||"", Dest_Adresse:qs('#destAdr').value||"", Exp_Nom:qs('#expNom').value||"", Exp_Org:qs('#expOrg').value||"", Exp_Adr:qs('#expAdr').value||"", Exp_Tel:qs('#expTel').value||"", Exp_Mail:qs('#expMail').value||"" };
  const id = qs('#templateSelect').value; const tpl = allTemplates().find(t=>t.id===id);
  if(tpl){ uniquePlaceholders(tpl).forEach(name=>{ v[name]=qs('#ph_'+name)?.value||""; }); }
  return v;
}
function renderPreview(){
  saveDefaults();
  const id = qs('#templateSelect').value; const tpl = allTemplates().find(t=>t.id===id); if(!tpl) return;
  const v = collectVars();
  const subject = substitute(tpl.subject, v);
  const body = substitute(tpl.body, v).split("\n").map(l=>`<p>${l||"&nbsp;"}</p>`).join("");
  const topRightAddr = (v.Dest_Nom||v.Dest_Attention||v.Dest_Adresse)?`
    <div class="block" style="white-space: pre-line; text-align:right;">
      <strong>${v.Dest_Nom||""}</strong>
      ${v.Dest_Attention?`\n${v.Dest_Attention}`:""}
      ${v.Dest_Adresse?`\n${v.Dest_Adresse}`:""}
    </div>`:"";
  qs('#sheet').innerHTML = `
    <div class="letterhead">
      <div style="white-space: pre-line;">
        <strong>${v.Exp_Nom||""}</strong>
        ${v.Exp_Org?`\n${v.Exp_Org}`:""}
        ${v.Exp_Adr?`\n${v.Exp_Adr}`:""}
        ${v.Exp_Tel?`\nT√©l. ${v.Exp_Tel}`:""}
        ${v.Exp_Mail?`\n${v.Exp_Mail}`:""}
      </div>
      <div style="text-align:right;">
        ${v.Ville?`Fait √† ${v.Ville},`:""} le ${v.Date||frLongDate()}
      </div>
    </div>
    ${topRightAddr}
    <div class="subject">Objet : ${subject}</div>
    <div class="body block">${body}</div>
    <div class="footer">
      <div>Cordialement,</div>
      <div style="margin-top: 18px;"><strong>${v.Exp_Nom||""}</strong></div>
      ${v.Exp_Org?`<div>${v.Exp_Org}</div>`:""}
    </div>`;
}

/* ===== Copier & PDF ===== */
async function copyText(){
  const sheet = qs('#sheet').cloneNode(true);
  const text = sheet.innerText.replace(/\n{3,}/g, "\n\n");
  try{ await navigator.clipboard.writeText(text); alert("Copi√© dans le presse-papiers ‚úÖ"); }
  catch{ alert("Impossible de copier automatiquement. S√©lectionnez le texte puis Ctrl/Cmd+C."); }
}
async function downloadPDF(){
  const el = qs('#sheet'); if(!el){ alert("Aper√ßu introuvable."); return; }
  try{
    if(document.fonts && document.fonts.ready){ await document.fonts.ready; }
    const scale = Math.max(2, Math.min(3, (window.devicePixelRatio||2)));
    const canvas = await html2canvas(el, { scale, backgroundColor:'#ffffff', useCORS:true });
    const imgData = canvas.toDataURL('image/jpeg', 0.98);
    const { jsPDF } = window.jspdf || {}; if(!jsPDF) throw new Error('jsPDF non charg√©');
    const pdf = new jsPDF('p','mm','a4'); const pageW = pdf.internal.pageSize.getWidth(); const pageH = pdf.internal.pageSize.getHeight();
    pdf.addImage(imgData, 'JPEG', 0, 0, pageW, pageH); pdf.save('courrier.pdf');
  }catch(e){ console.error(e); alert("PDF indisponible : impression en secours."); window.print(); }
}

/* ===== √âditeur mod√®les perso ===== */
let editorState = { mode:'new', id:null };
function openEditor(mode='new', template=null){
  editorState.mode = mode;
  const isUser = template?._isUser === true;
  qs('#editorCard').style.display = 'block';
  qs('#mdl_name').value = template?.label || '';
  qs('#mdl_tags').value = (template?.tags||[]).join(', ');
  qs('#mdl_desc').value = template?.description || '';
  qs('#mdl_subject').value = template?.subject || '';
  qs('#mdl_body').value = template?.body || '';
  if(mode==='edit' && isUser){
    qs('#mdl_id').value = template.id; qs('#mdl_id').disabled = true; editorState.id = template.id; qs('#mdl_delete').style.display = '';
  } else {
    qs('#mdl_id').value = 'auto'; qs('#mdl_id').disabled = true; editorState.id = null; qs('#mdl_delete').style.display = 'none';
  }
  qs('#editorCard').scrollIntoView({behavior:'smooth', block:'start'});
}
function closeEditor(){ qs('#editorCard').style.display='none'; editorState={mode:'new',id:null}; }
function collectEditor(){
  const name=qs('#mdl_name').value.trim(); const tags=qs('#mdl_tags').value.split(',').map(t=>t.trim()).filter(Boolean);
  const desc=qs('#mdl_desc').value.trim(); const subject=qs('#mdl_subject').value; const body=qs('#mdl_body').value;
  if(!name){ alert("Donnez un nom au mod√®le."); return null; }
  if(!subject){ alert("Renseignez un sujet."); return null; }
  if(!body){ alert("Renseignez un corps de texte."); return null; }
  return {name,tags,desc,subject,body};
}
function saveEditor(){
  const data = collectEditor(); if(!data) return;
  const tpl = { id: editorState.id || `usr_${slugify(data.name)}_${Date.now()}`, label:data.name, tags:data.tags, description:data.desc, subject:data.subject, body:data.body };
  if(editorState.mode==='edit' && editorState.id){
    const idx = userTemplates.findIndex(t=>t.id===editorState.id);
    if(idx>=0) userTemplates[idx]=tpl; else userTemplates.push(tpl);
  } else { userTemplates.push(tpl); }
  saveUserTemplates(); populateTemplates(); qs('#templateSelect').value = tpl.id; onTemplateChange(); alert("Mod√®le enregistr√© ‚úÖ"); closeEditor();
}
function deleteEditor(){
  if(!editorState.id) return; if(!confirm("Supprimer ce mod√®le personnalis√© ?")) return;
  userTemplates = userTemplates.filter(t=>t.id!==editorState.id);
  saveUserTemplates(); populateTemplates(false); alert("Mod√®le supprim√©."); closeEditor();
}

/* ===== Suppression d√©finitive d'un mod√®le (sans archivage/restauration) ===== */
function removeCurrentTemplate(){
  const id = qs('#templateSelect').value;
  const tpl = allTemplates().find(t=>t.id===id);
  if(!tpl) return;
  if(!confirm(`Supprimer d√©finitivement le mod√®le : "${tpl.label}" ? Cette action est irr√©versible.`)) return;

  if(tpl._isUser){
    userTemplates = userTemplates.filter(t=>t.id!==id);
    saveUserTemplates();
  } else {
    if(!removedBuiltins.includes(id)) removedBuiltins.push(id);
    saveRemoved();
  }
  populateTemplates(false);
  alert("Mod√®le supprim√©.");
}

/* ===== Export / Import ===== */
function exportTemplates(){
  const blob = new Blob([JSON.stringify(userTemplates, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='modeles_courrier_perso.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000);
}
function importTemplates(){
  const input=document.createElement('input'); input.type='file'; input.accept='application/json';
  input.addEventListener('change',()=>{
    const file=input.files?.[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=()=>{
      try{ const arr=JSON.parse(reader.result); if(!Array.isArray(arr)) throw new Error('Format invalide');
        const map=new Map(userTemplates.map(t=>[t.id,t])); arr.forEach(t=>{ if(t && t.id) map.set(t.id,t); });
        userTemplates=Array.from(map.values()); saveUserTemplates(); populateTemplates(); alert("Mod√®les import√©s ‚úÖ");
      }catch(e){ alert("Import impossible : "+e.message); }
    };
    reader.readAsText(file);
  });
  input.click();
}

/* ===== Wiring ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  loadUserTemplates(); loadRemoved(); loadDefaults(); populateTemplates();
  qs('#templateSelect').addEventListener('change', onTemplateChange);
  qsa('#ville,#dateAuto,#expNom,#expOrg,#expAdr,#expTel,#expMail,#destNom,#destAttention,#destAdr').forEach(el=>el.addEventListener('input', renderPreview));
  qs('#btnPreview').addEventListener('click', renderPreview);
  qs('#btnCopy').addEventListener('click', copyText);
  qs('#btnPDF').addEventListener('click', downloadPDF);
  qs('#btnReset').addEventListener('click', ()=>{ localStorage.removeItem(STORAGE_DEFAULTS); qsa('input, textarea').forEach(i=>{ if(!['templateSelect','dateAuto'].includes(i.id)) i.value=''; }); qs('#dateAuto').value = frLongDate(); renderPreview(); });
  qs('#btnNew').addEventListener('click', ()=>openEditor('new', null));
  qs('#btnEdit').addEventListener('click', ()=>{ const id=qs('#templateSelect').value; const tpl=allTemplates().find(t=>t.id===id); if(!tpl) return; openEditor(tpl._isUser?'edit':'new', tpl); });
  qs('#btnClone').addEventListener('click', ()=>{ const id=qs('#templateSelect').value; const tpl=allTemplates().find(t=>t.id===id); if(!tpl) return; openEditor('new', {...tpl, label: tpl.label + ' (copie)'}); });
  qs('#mdl_save').addEventListener('click', saveEditor);
  qs('#mdl_cancel').addEventListener('click', closeEditor);
  qs('#mdl_delete').addEventListener('click', deleteEditor);
  qs('#btnRemove').addEventListener('click', removeCurrentTemplate);
  qs('#btnExport').addEventListener('click', exportTemplates);
  qs('#btnImport').addEventListener('click', importTemplates);
});
</script>
</body>
</html>
