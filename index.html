<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dashboard Pr√©voyance + Prime (v6.7 ‚Äî Plan + Simulation mensuelle + Historique)</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b1220; --panel:#0f172a; --muted:#94a3b8; --text:#e5e7eb;
  --accent:#22c55e; --accent2:#3b82f6; --border:#1f2937; --warn:#f59e0b; --danger:#ef4444;
  --ok:#22c55e; --over:#3b82f6;
}
*{box-sizing:border-box}
body{margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto; color:var(--text); background:radial-gradient(1200px 600px at 10% -10%, rgba(59,130,246,.18), transparent 40%), radial-gradient(1000px 500px at 100% 0%, rgba(34,197,94,.15), transparent 35%), linear-gradient(180deg,#0b1220,#0f172a 60%,#0b1220)}
header{padding:22px 16px 10px}
h1{margin:0; font-size:clamp(20px,3vw,28px)}
.sub{color:var(--muted); font-size:14px}
.tabs{display:flex; gap:8px; padding:0 16px 8px; flex-wrap:wrap}
.tab{cursor:pointer; padding:10px 14px; border-radius:12px; background:rgba(15,23,42,.6); border:1px solid var(--border); user-select:none; transition:all .15s ease}
.tab:hover{transform:translateY(-1px); box-shadow:0 6px 18px rgba(0,0,0,.25)}
.tab.active{background:linear-gradient(180deg,#3b82f6,#1d4ed8); border-color:#1e3a8a}
.panel{display:none}
.panel.active{display:block}
.card{background:rgba(15,23,42,.72); backdrop-filter: blur(6px); border:1px solid var(--border); border-radius:16px; box-shadow:0 12px 40px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.03); padding:16px}
.grid{display:grid; grid-template-columns:repeat(12,1fr); gap:16px; padding:16px}
.kpi{display:flex; flex-direction:column; gap:6px; padding:14px 16px; min-width:220px}
.kpi .label{color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.08em}
.kpi .value{font-size:clamp(18px,3vw,28px); font-weight:700}
.kpi .delta{font-size:12px}
input, select, button, textarea{background:#0b1220; color:#e5e7eb; border:1px solid var(--border); border-radius:12px; padding:10px 12px; font-size:14px; outline:none}
button{cursor:pointer; font-weight:600}
.btn{border:1px solid transparent}
.btn-primary{background:linear-gradient(180deg,#16a34a,#15803d); border-color:#14532d}
.btn-ghost{background:transparent; border-color:var(--border)}
.btn-danger{background:linear-gradient(180deg,#ef4444,#b91c1c); border-color:#7f1d1d}
.row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.small{font-size:12px; color:#94a3b8}
.progress{height:12px; background:#0b1220; border:1px solid var(--border); border-radius:999px; overflow:hidden}
.bar{height:100%; background:linear-gradient(90deg,#22c55e,#3b82f6); width:0%}
.right{text-align:right}
.table-wrap{overflow:auto}
table{width:100%; min-width:980px; border-collapse:separate; border-spacing:0}
th,td{padding:10px 8px; border-bottom:1px solid var(--border); font-size:14px}
thead th{position:sticky; top:0; background:#0b1220; z-index:1}
footer{color:#94a3b8; padding:16px; text-align:center; font-size:12px}
svg{width:100%; height:auto}
.chart{height:220px}
.debug{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; background:#0b1220; border:1px dashed #334155; border-radius:12px; padding:10px; color:#cbd5e1}
@media (max-width: 1080px){ .grid{grid-template-columns: 1fr} .kpi{min-width:unset} }
.badge{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; border:1px solid var(--border); font-size:12px; color:#cbd5e1; background:rgba(2,6,23,.6)}
.hr{height:1px; background:#1f2937; margin:8px 0 12px}
.section-title{margin:0 0 6px; font-weight:700}
.note{font-size:12px; color:#9ca3af}
.details{white-space:pre-wrap; background:#0b1220; border:1px solid #334155; border-radius:12px; padding:12px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; color:#d1d5db}
.actions{display:flex; gap:8px; flex-wrap:wrap}
.badge-warn{background:rgba(245,158,11,.15); border-color:#b45309; color:#fbbf24}
.badge-ok{background:rgba(34,197,94,.15); border-color:#166534; color:#86efac}
.badge-over{background:rgba(59,130,246,.15); border-color:#1e40af; color:#93c5fd}
@media print{
  body{background:#fff; color:#000}
  .tabs, .btn, .actions, .table-wrap, .chart, footer, .debug{display:none !important}
  .card{border:1px solid #ddd; box-shadow:none; background:#fff; color:#000}
  .kpi .value{color:#000}
  a:link{color:#000}
}
</style>
</head>
<body>
<header>
  <h1>Dashboard ‚Äî <span class="badge">Pr√©voyance</span> + <span class="badge">Calculateur</span> + <span class="badge">Global</span> + <span class="badge">Plan</span> + <span class="badge">Simulation</span> + <span class="badge">Historique</span> (v6.7)</h1>
  <div class="sub">Plan r√©aliste par mois ‚Ä¢ Simulation avec bar√®mes, surperf, qualitatif, collectif ‚Ä¢ Historique exportable</div>
</header>

<div class="tabs">
  <div class="tab active" data-tab="prev">Pr√©voyance</div>
  <div class="tab" data-tab="calc">Calculateur</div>
  <div class="tab" data-tab="global">Global</div>
  <div class="tab" data-tab="plan">Plan</div>
  <div class="tab" data-tab="av">Assurance Vie</div>
  <div class="tab" data-tab="per">PER</div>
  <div class="tab" data-tab="library">Argumentaires</div>
  <div class="tab" data-tab="gav">Aide √† la vente (GAV)</div>
  <div class="tab" data-tab="simudc">Simulation DC</div>
  <div class="tab" data-tab="courrier">Mod√®les Courrier</div>
</div>

<div id="prev" class="panel active"></div>
<div id="calc" class="panel"></div>
<div id="global" class="panel"></div>
<div id="plan" class="panel"></div>
<div id="av" class="panel"></div>
<div id="per" class="panel"></div>
<div id="library" class="panel"></div>
<div id="gav" class="panel"></div>
<div id="simudc" class="panel">
  <div class="grid">
    <section class="card" style="grid-column: span 12">
      <div class="row" style="justify-content: flex-end; gap: 8px">
        <button class="btn btn-ghost" onclick="try{document.getElementById('simuFrame').contentWindow.location.reload()}catch(e){}">üîÑ Recharger</button>
        <a class="btn btn-primary" href="simulation_dc.html" target="_blank" rel="noopener">Ouvrir en plein √©cran</a>
      </div>
      <div class="hr"></div>
      <iframe id="simuFrame" src="simulation_dc.html" style="width:100%; height:80vh; border:1px solid var(--border); border-radius:12px;" loading="lazy"></iframe>
    </section>
  </div>
</div>


<div id="courrier" class="panel">
  <div class="grid">
    <section class="card" style="grid-column: span 12">
      <div class="row" style="justify-content: flex-end; gap: 8px">
        <button class="btn btn-ghost" onclick="try{document.getElementById('courrierFrame').contentWindow.location.reload()}catch(e){}">üîÑ Recharger</button>
        <a class="btn btn-primary" href="onglet_courrier_v6_tag.html" target="_blank" rel="noopener">Ouvrir en plein √©cran</a>
      </div>
      <div class="hr"></div>
      <iframe id="courrierFrame" src="onglet_courrier_v6_tag.html" style="width:100%; height:80vh; border:1px solid var(--border); border-radius:12px;" loading="lazy"></iframe>
    </section>
  </div>
</div>

<footer>CSV = hors-ligne ‚Ä¢ XLSX = connexion n√©cessaire (chargement de SheetJS). ‚Äî v6.7</footer>

<script>
/* ===== Utils ===== */
const fmt0 = new Intl.NumberFormat('fr-FR', { style:'currency', currency:'EUR', maximumFractionDigits:0 });
const fmt = new Intl.NumberFormat('fr-FR', { style:'currency', currency:'EUR' });
const today = new Date();
function yearNow(){ return today.getFullYear(); }
function monthIndexNow(){ return today.getMonth(); } // 0..11
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function esc(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

/* ===== Pr√©voyance tab (import + charts) ‚Äî base v6.5 ===== */
function buildPrevPanel(){
  const root = document.getElementById('prev');
  root.innerHTML = `
    <div class="grid">
      <section class="card" style="grid-column: span 12">
        <div class="row">
          <input class="file" type="file" accept=".csv, text/csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" />
          <button class="btn btn-ghost import">Importer</button>
          <button class="btn btn-ghost export">Exporter (JSON)</button>
          <button class=\"btn btn-ghost exportCSV\">Exporter (CSV combin√©)</button>
          <button class="btn btn-danger clear">R√©initialiser</button>
          <span class="small">Colonnes attendues : <b>prenomPP</b>, <b>nomPP</b>, <b>offre</b>, <b>montantPeriodique</b>, <b>periodicite</b>, <b>dateSignature</b></span>
        </div>
        <div class="row" style="margin-top:10px">
          <input class="target" type="number" min="0" step="1" placeholder="Objectif annuel Pr√©voyance (‚Ç¨)" />
          <button class="btn btn-primary save">Enregistrer</button>
          <div class="actions">
            <button class="btn btn-ghost toCalc">Envoyer le CA ‚Üí Calculateur</button>
            <button class="btn btn-ghost print">Exporter PDF</button>
          </div>
        </div>
        <div class="debug box">En attente d‚Äôimport‚Ä¶</div>
      </section>

      <section class="card" style="grid-column: span 12">
        <div class="row">
          <div class="kpi card">
            <div class="label">Total annuel</div>
            <div class="value annualTotal">0 ‚Ç¨</div>
            <div class="delta small rows">Lignes import√©es : 0</div>
          </div>
          <div class="kpi card">
            <div class="label">Objectif annuel</div>
            <div class="value targetVal">‚Äî</div>
            <div class="delta pct">Atteint : ‚Äî</div>
            <div class="progress"><div class="bar progressBar"></div></div>
          </div>
          <div class="kpi card">
            <div class="label">CA moyen / vente (annuel)</div>
            <div class="value avg">0 ‚Ç¨</div>
            <div class="delta small products">Produits distincts : 0</div>
          </div>
          <div class="kpi card">
            <div class="label">Ventes</div>
            <div class="value deals">0</div>
            <div class="delta small yearInfo">Ann√©e s√©lectionn√©e : ‚Äî</div>
          </div>
        </div>
      </section>

      <section class="card" style="grid-column: span 6">
        <h3 class="section-title">CA annuel par mois (ann√©e s√©lectionn√©e)</h3>
        <div class="chart monthly"></div>
      </section>

      <section class="card" style="grid-column: span 6">
        <h3 class="section-title">R√©partition du CA annuel par produit</h3>
        <div class="chart pie"></div>
      </section>
      <section class="card" style="grid-column: span 12">
        <h3 class="section-title">Ajout manuel</h3>
        <div class="row" style="flex-wrap:wrap; gap:8px">
          <input class="m_prenom" placeholder="Pr√©nom" style="min-width:120px">
          <input class="m_nom" placeholder="Nom" style="min-width:120px">
          <input class="m_produit" placeholder="Produit" style="min-width:160px">
          <input class="m_montant" type="number" min="0" step="1" placeholder="Montant p√©riodique (‚Ç¨)" style="width:170px">
          <select class="m_per">
            <option value="mensuel" selected>Mensuel</option>
            <option value="trimestriel">Trimestriel</option>
            <option value="semestriel">Semestriel</option>
            <option value="annuel">Annuel</option>
          </select>
          <input class="m_date" type="date" style="min-width:150px">
          <button class="btn btn-primary m_add">Ajouter</button>
        </div>
      </section>

      

      <section class="card table-wrap" style="grid-column: span 12">
        <div class="row" style="margin-bottom:8px">
          <input class="search" type="search" placeholder="Rechercher (nom, produit‚Ä¶)" style="min-width:260px">
          <select class="filterYear"></select>
        </div>
        <table>
          <thead><tr><th>Pr√©nom</th><th>Nom</th><th>Produit</th><th class=\"right\">CA annuel</th><th>Date</th><th>Actions</th></tr></thead>
          <tbody class="tbody"></tbody>
        </table>
      </section>
    </div>
  `;

  const $ = sel => root.querySelector(sel);

  const els = {
    file: $('.file'), importBtn: $('.import'), exportBtn: $('.export'), clearBtn: $('.clear'),
    target: $('.target'), save: $('.save'), debug: $('.box'), toCalc: $('.toCalc'), printBtn: $('.print'),
    annualTotal: $('.annualTotal'), rows: $('.rows'),
    targetVal: $('.targetVal'), pct: $('.pct'), progressBar: $('.progressBar'),
    avg: $('.avg'), products: $('.products'), deals: $('.deals'), yearInfo: $('.yearInfo'),
    chartMonthly: $('.monthly'), chartPie: $('.pie'),
    search: $('.search'), filterYear: $('.filterYear'), tbody: $('.tbody'), m_prenom: $('.m_prenom'), m_nom: $('.m_nom'), m_produit: $('.m_produit'), m_montant: $('.m_montant'), m_per: $('.m_per'), m_date: $('.m_date'), m_add: $('.m_add'), exportCSVBtn: $('.exportCSV')
  };
let data = loadData();
  els.target.value = localStorage.getItem('prev.target') || '27000';
  renderAll();
  // --- Doublons: helpers ---
  function keyFor(r){
    const k1 = String(r.prenom||'').trim().toLowerCase();
    const k2 = String(r.nom||'').trim().toLowerCase();
    const k3 = String(r.produit||'').trim().toLowerCase();
    const k4 = String(r.date||'').slice(0,7); // YYYY-MM
    return [k1,k2,k3,k4].join('|');
  }
  function dedupeRows(rows){
    const seen = new Set(); const out = [];
    for(const r of rows){
      const k = keyFor(r);
      if(seen.has(k)) continue;
      seen.add(k); out.push(r);
    }
    return out;
  }
  function findDuplicateIndex(row){
    const k = keyFor(row);
    return data.findIndex(d => keyFor(d) === k);
  }


  
  // Default date today for manual add
  if(els.m_date){ els.m_date.value = new Date().toISOString().slice(0,10); }

  function annualFrom(amount, per){
    const a = Number(amount)||0;
    const p = String(per||'').toLowerCase();
    let monthly = a;
    if(p.includes('ann')) monthly = a/12;
    else if(p.includes('sem')) monthly = a/6;
    else if(p.includes('trim')) monthly = a/3;
    else monthly = a;
    return monthly*12;
  }

  function addManual(){
    const prenom = (els.m_prenom?.value||'').trim();
    const nom = (els.m_nom?.value||'').trim();
    const produit = (els.m_produit?.value||'').trim();
    const date = (els.m_date?.value||'') || new Date().toISOString().slice(0,10);
    const annual = annualFrom(els.m_montant?.value, els.m_per?.value);
    if(!produit || !annual){ alert('Renseigne au minimum Produit et Montant.'); return; }
    const row = { id: 'm'+Date.now().toString(36)+Math.random().toString(36).slice(2,5), prenom, nom, produit, date, annual, source:'manual' };
    const dupIdx = findDuplicateIndex(row);
    if(dupIdx !== -1){
      if(confirm('Doublon d√©tect√© (m√™me pr√©nom/nom/produit/mois). Remplacer l‚Äôexistant ?')){
        data[dupIdx] = { ...data[dupIdx], ...row };
      }else{
        const keepBoth = confirm('Conserver les deux entr√©es ?');
        if(keepBoth){ data.unshift(row); } else { return; }
      }
    }else{
      data.unshift(row);
    }
    saveData();
    renderAll();
    if(els.m_prenom) els.m_prenom.value='';
    if(els.m_nom) els.m_nom.value='';
    if(els.m_produit) els.m_produit.value='';
    if(els.m_montant) els.m_montant.value='';
  }

  els.m_add && els.m_add.addEventListener('click', addManual);

  // Table actions (edit/delete) for manual rows
  els.tbody.addEventListener('click', (e)=>{
    const btn = e.target.closest('button');
    if(!btn) return;
    const id = btn.dataset.id || btn.closest('tr')?.dataset.id;
    const idx = data.findIndex(d => String(d.id||'')===String(id));
    if(idx===-1) return;
    const row = data[idx];
    if(btn.classList.contains('del')){
      if(confirm('Supprimer cette ligne manuelle ?')){
        data.splice(idx,1);
        saveData(); renderAll();
      }
    }else if(btn.classList.contains('edit')){
      const prenom = prompt('Pr√©nom', row.prenom||'') ?? row.prenom;
      const nom = prompt('Nom', row.nom||'') ?? row.nom;
      const produit = prompt('Produit', row.produit||'') ?? row.produit;
      const date = prompt('Date (YYYY-MM-DD)', row.date||'') ?? row.date;
      const montant = prompt('Montant p√©riodique (‚Ç¨)', Math.round((row.annual||0)/12)) ?? String(Math.round((row.annual||0)/12));
      const per = prompt('P√©riodicit√© (mensuel/trimestriel/semestriel/annuel)', 'mensuel') ?? 'mensuel';
      const annual = annualFrom(montant, per);
      data[idx] = { ...row, prenom, nom, produit, date, annual, source:'manual' };
      saveData(); renderAll();
    }
  });

  // Export CSV combin√© (import + manuel) ‚Äî colonnes normalis√©es
  function exportCombinedCSV(){
    const headers = ['prenom','nom','produit','annual','date','source'];
    const lines = [headers.join(';')].concat(
      data.map(r => [r.prenom||'', r.nom||'', r.produit||'', String(Number(r.annual)||0), r.date||'', r.source||'import'].join(';'))
    );
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'prevoyance_combine.csv'; a.click(); URL.revokeObjectURL(url);
  }
  els.exportCSVBtn && els.exportCSVBtn.addEventListener('click', exportCombinedCSV);
els.importBtn.addEventListener('click', async () => {
    const f = els.file.files && els.file.files[0];
    if(!f){ alert('Choisis un fichier CSV/XLSX.'); return; }
    try{
      const text = await readFileToTextOrCSV(f);
      const parsed = parseCSV(text);
      let normalized = parsed.rows.map(r => normalizeRow(r)).map(r => ({...r, source:'import'}));
      const before = normalized.length; const deduped = dedupeRows(normalized);
      const removed = before - deduped.length;
      data = deduped;
      saveData();
      debug(`Import OK ‚Äî ${data.length} lignes.` + (removed>0? ` (${removed} doublon(s) ignor√©(s))` : '') + `
Extrait:\n` + JSON.stringify(data.slice(0,5), null, 2));
      renderAll();
    }catch(e){ debug('Erreur de lecture: ' + e); }
  });

  els.exportBtn.addEventListener('click', () => {
    const blob = new Blob([JSON.stringify({ data, settings: {
      target: localStorage.getItem('prev.target')||''
    }}, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download= 'prev_export.json'; a.click(); URL.revokeObjectURL(url);
  });

  els.clearBtn.addEventListener('click', () => {
    if(confirm('Effacer les donn√©es locales de Pr√©voyance ?')){ data=[]; saveData(); renderAll(); debug('Donn√©es r√©initialis√©es.'); }
  });

  els.save.addEventListener('click', () => {
    localStorage.setItem('prev.target', (els.target.value||'').trim());
    renderAll();
  });
  [els.search, els.filterYear].forEach(el => el.addEventListener('input', renderTable));

  els.toCalc.addEventListener('click', () => {
    const totalAnnual = data.reduce((s,d)=> s + (Number(d.annual)||0), 0);
    localStorage.setItem('calc.ca_prev', String(totalAnnual));
    document.querySelector('.tab[data-tab="calc"]').click();
  });

  els.printBtn.addEventListener('click', () => window.print());

  function storageKey(){ return 'prev.data'; }
  function loadData(){ try{ const j=localStorage.getItem(storageKey()); return j? JSON.parse(j): []; }catch(e){ return []; } }
  function saveData(){ localStorage.setItem(storageKey(), JSON.stringify(data)); }
  function debug(msg){ els.debug.textContent = msg; }

  async function readFileToTextOrCSV(file){
    const ext = (file.name.split('.').pop()||'').toLowerCase();
    if(ext === 'xlsx'){
      if(typeof XLSX === 'undefined') throw new Error('Librairie XLSX non charg√©e (connexion internet requise).');
      const ab = await file.arrayBuffer();
      const wb = XLSX.read(ab, {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const csv = XLSX.utils.sheet_to_csv(ws, {FS:';'});
      return csv;
    } else {
      return await file.text();
    }
  }

  function parseCSV(text){
    const firstLine = text.split(/\r?\n/).find(l=>l.trim().length>0) || '';
    const delimiter = firstLine.includes(';') && !firstLine.includes(',') ? ';' : ',';
    const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
    const headers = (lines.shift()||'').split(delimiter).map(s=>s.trim());
    const rows = lines.map(line => {
      const out = []; let cur=''; let inQ=false;
      for(let i=0;i<line.length;i++){
        const ch = line[i];
        if(ch === '"'){ if(inQ && line[i+1] === '"'){ cur+='"'; i++; } else { inQ=!inQ; } }
        else if(ch === delimiter && !inQ){ out.push(cur); cur=''; }
        else { cur += ch; }
      }
      out.push(cur);
      const obj = {}; headers.forEach((h,idx)=> obj[h]= (out[idx]||'').trim());
      return obj;
    });
    debug('En-t√™tes d√©tect√©es: ' + headers.join(' | '));
    return { headers, rows };
  }

  function toNum(v){
    if(v==null) return 0;
    let s = String(v).replace(/\u00a0/g,' ').replace(/[‚Ç¨]/g,'').replace(/['"]/g,'').replace(/\s/g,'').replace(',', '.');
    s = (s.match(/[0-9\.\-]+/g)||['0']).join('');
    const n = Number(s); return isFinite(n)? n: 0;
  }
  function toISO(v){
    const s = String(v||'').trim(); if(!s) return '';
    const m1 = s.match(/^(\d{4})[-/](\d{2})[-/](\d{2})/); if(m1) return `${m1[1]}-${m1[2]}-${m1[3]}`;
    const m2 = s.match(/^(\d{2})[/-](\d{2})[/-](\d{4})/); if(m2) return `${m2[3]}-${m2[2]}-${m2[1]}`;
    const d = new Date(s); if(!isNaN(d)) return d.toISOString().slice(0,10); return '';
  }

  function normalizeRow(r){
    const prenom = (r['prenomPP']||'').trim();
    const nom = (r['nomPP']||'').trim();
    const produit = (r['offre']||r['familleProduit']||'').trim();
    const date = toISO(r['dateSignature']);
    let amount = toNum(r['montantPeriodique']);
    const per = String(r['periodicite']||'').toLowerCase();
    let monthly = amount;
    if(per.includes('ann')) monthly = amount/12;
    else if(per.includes('sem')) monthly = amount/6;
    else if(per.includes('trim')) monthly = amount/3;
    else if(per.includes('mens')) monthly = amount;
    const annual = monthly * 12;
    return { prenom, nom, produit, date, annual };
  }

  function renderAll(){ fillYearFilter(); renderKPIs(); renderCharts(); renderTable(); }

  function fillYearFilter(){
    const years = Array.from(new Set(data.map(r => (r.date||'').slice(0,4)).filter(Boolean))).map(Number).sort((a,b)=>b-a);
    const cur = yearNow(); if(years.indexOf(cur)===-1) years.push(cur);
    els.filterYear.innerHTML = years.map(y => `<option value="${y}" ${y===cur?'selected':''}>Ann√©e ${y}</option>`).join('');
  }

  function renderKPIs(){
    const totalAnnual = data.reduce((s,d)=> s + (Number(d.annual)||0), 0);
    const target = Number(localStorage.getItem('prev.target')||0) || 0;
    els.annualTotal.textContent = fmt0.format(totalAnnual);
    els.rows.textContent = 'Lignes import√©es : ' + data.length;
    els.targetVal.textContent = target>0 ? fmt0.format(target) : '‚Äî';
    const pct = target>0 ? (totalAnnual/target*100) : 0;
    els.pct.innerHTML = 'Atteint : ' + (target>0 ? (Math.round(pct*10)/10)+'%' : '‚Äî') + (pct>=125 ? ' <span class="badge-over">125%+</span>' : '');
    const color = pct>=125? 'var(--over)' : pct>=100? 'var(--ok)' : pct>=80? 'var(--warn)' : 'var(--danger)';
    els.progressBar.style.width = Math.min(100, Math.round(pct)) + '%';
    els.progressBar.style.background = color;
    const avg = data.length ? totalAnnual / data.length : 0;
    els.avg.textContent = fmt0.format(avg);
    const productSet = new Set(data.map(d=> d.produit || 'Inconnu'));
    els.products.textContent = 'Produits distincts : ' + productSet.size;
    const y = Number(els.filterYear.value) || yearNow();
    const yearRowsKPI = data.filter(d => !d.date || d.date.startsWith(String(y)));
    els.deals.textContent = yearRowsKPI.length;
    els.yearInfo.textContent = 'Ann√©e s√©lectionn√©e : ' + y;
  }

  function renderCharts(){
    const y = Number(els.filterYear.value) || yearNow();
    const yearRows = data.filter(d => (d.date||'').startsWith(String(y)));
    const buckets = new Array(12).fill(0);
    yearRows.forEach(d => { if(!d.date) return; const m = Number(d.date.slice(5,7)) - 1; buckets[m] += Number(d.annual)||0; });
    els.chartMonthly.innerHTML = barChartSVG(buckets);
    const map = {}; data.forEach(d => { const key=(d.produit||'Inconnu')||'Inconnu'; map[key]=(map[key]||0)+(Number(d.annual)||0); });
    const top = Object.entries(map).sort((a,b)=> b[1]-a[1]).slice(0,8);
    els.chartPie.innerHTML = pieChartSVG(top);
  }

  function renderTable(){
    const y = Number(els.filterYear.value) || yearNow();
    const q = (els.search.value||'').toLowerCase();
    const rows = data.filter(d => {
      const txt = (d.prenom+' '+d.nom+' '+d.produit).toLowerCase();
      if(q && !txt.includes(q)) return false;
      const yearOK = !d.date || d.date.startsWith(String(y)); if(!yearOK) return false;
      return true;
    });
    rows.sort((a,b)=> (b.date||'').localeCompare(a.date||'') || (Number(b.annual)||0)-(Number(a.annual)||0));
    els.tbody.innerHTML = rows.map(r => `<tr data-id="${r.id||''}"><td>${esc(r.prenom||'')}</td><td>${esc(r.nom||'')}</td><td>${esc(r.produit||'')}</td><td class=\"right\">${fmt0.format(Number(r.annual)||0)}</td><td>${r.date || '‚Äî'}</td><td>${r.source==='manual' ? '<button class=\"btn btn-ghost edit\" data-id=\"'+(r.id||'')+'\">‚úèÔ∏è</button> <button class=\"btn btn-danger del\" data-id=\"'+(r.id||'')+'\">üóë</button>' : '‚Äî'}</td></tr>`).join('');
  }

  function barChartSVG(values){
    const labels = ['Jan','F√©v','Mar','Avr','Mai','Juin','Juil','Ao√ª','Sept','Oct','Nov','D√©c'];
    const w=680, h=220, pad=30, max=Math.max(10, ...values);
    const bw = (w - pad*2) / values.length;
    const bars = values.map((v,i)=>{
      const x = pad + i*bw + 6;
      const bh = (v/max) * (h - pad*2);
      const y = h - pad - bh;
      const fill = v>0 ? 'url(#g)' : '#0b1220';
      return `<rect x="${x}" y="${y}" width="${bw-12}" height="${Math.max(1,bh)}" rx="6" ry="6" fill="${fill}">
        <title>${labels[i]}: ${fmt0.format(v)}</title>
      </rect>`;
    }).join('');
    const xlabels = labels.map((lab,i)=>{
      const x = pad + i*bw + bw/2;
      return `<text x="${x}" y="${h-8}" font-size="11" text-anchor="middle" fill="#9ca3af">${lab}</text>`;
    }).join('');
    const grid = [0.25,0.5,0.75,1].map(p=>{
      const y = pad + (1-p)*(h - pad*2);
      return `<line x1="${pad}" y1="${y}" x2="${w-pad}" stroke="#1f2937" stroke-width="1"/>`;
    }).join('');
    return `<svg viewBox="0 0 ${w} ${h}" role="img" aria-label="CA annuel par mois">
      <defs><linearGradient id="g" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#22c55e"/><stop offset="100%" stop-color="#3b82f6"/></linearGradient></defs>
      ${grid}${bars}${xlabels}
    </svg>`;
  }

  function pieChartSVG(entries){
    const w=680, h=220, cx=110, cy=110, r=85;
    const total = entries.reduce((s,[_k,v])=>s+v,0) || 1;
    let a0 = -Math.PI/2;
    const colors = ['#22c55e','#3b82f6','#a855f7','#f59e0b','#10b981','#ef4444','#06b6d4','#f97316'];
    const slices = entries.map(([k,v],i)=>{
      const ang = (v/total)*Math.PI*2; const a1 = a0 + ang; const large = ang>Math.PI ? 1:0;
      const x0 = cx + r*Math.cos(a0), y0 = cy + r*Math.sin(a0);
      const x1 = cx + r*Math.cos(a1), y1 = cy + r*Math.sin(a1);
      const path = `M ${cx} ${cy} L ${x0} ${y0} A ${r} ${r} 0 ${large} 1 ${x1} ${y1} Z`;
      const color = colors[i % colors.length];
      const mid = a0 + ang/2; const lx = cx + (r+14)*Math.cos(mid), ly = cy + (r+14)*Math.sin(mid);
      a0 = a1;
      return `<path d="${path}" fill="${color}"><title>${k}: ${fmt0.format(v)}</title></path>
              <text x="${lx}" y="${ly}" font-size="11" text-anchor="${Math.cos(mid)>0? 'start':'end'}" fill="#cbd5e1">${k}</text>`;
    }).join('');
    return `<svg viewBox="0 0 ${w} ${h}" role="img" aria-label="R√©partition par produit">${slices}</svg>`;
  }
}

/* ===== Calculateur tab (copie v6.5 avec save-to-history) ===== */
function buildCalcPanel(){
  const root = document.getElementById('calc');
  root.innerHTML = `
    <div class="grid">
      <section class="card" style="grid-column: span 12">
        <div class="actions" style="justify-content:flex-end; margin-bottom:8px">
          <button class="btn btn-ghost print">Exporter PDF</button>
          <button class="btn btn-ghost clear">R√©initialiser param√®tres</button>
        </div>
        <h3 class="section-title">Entr√©es</h3>
        <div class="row">
          <span class="small">CA Pr√©voyance (‚Ç¨)</span>
          <input class="ca_prev" data-save="1" type="number" min="0" step="1" placeholder="ex. 30000" />
          <button class="btn btn-ghost pullPrev">‚Üê depuis l'onglet Pr√©voyance</button>
          <span class="small">Objectif Pr√©voyance (‚Ç¨)</span>
          <input class="obj_prev" data-save="1" type="number" min="0" step="1" value="27000" />
        </div>
        <div class="row">
          <span class="small">Contrats ER (nbre)</span>
          <input class="nb_er" data-save="1" type="number" min="0" step="1" placeholder="ex. 11" />
          <span class="small">Objectif ER (contrats)</span>
          <input class="obj_er" data-save="1" type="number" min="0" step="1" value="11" />
        </div>
        <div class="row">
          <span class="small">CA ER (‚Ç¨)</span>
          <input class="ca_er" data-save="1" type="number" min="0" step="1" placeholder="ex. 55000" />
          <span class="small">Objectif ER (CA‚Ç¨)</span>
          <input class="obj_er_eur" data-save="1" type="number" min="0" step="1" value="55000" />
        </div>
        <div class="hr"></div>
        <h3 class="section-title">Bar√®mes ‚Ç¨ par palier</h3>
        <div class="row note">Palier le plus bas ‚â§ votre atteinte (80,85,90,95,100,105,110,115,120,125).</div>
        <div class="row">
          <span class="small">Pr√©voyance :</span>
          <input class="b_prev" data-save="1" type="text" style="min-width:520px" value="80:750,85:1120,90:1490,95:1860,100:2240,105:2690,110:3030,115:3210,120:3390,125:3580">
        </div>
        <div class="row">
          <span class="small">ER Contrats :</span>
          <input class="b_er_c" data-save="1" type="text" style="min-width:520px" value="80:160,85:240,90:320,95:400,100:480,105:575,110:645,115:685,120:725,125:765">
        </div>
        <div class="row">
          <span class="small">ER CA‚Ç¨ :</span>
          <input class="b_er_e" data-save="1" type="text" style="min-width:520px" value="80:160,85:240,90:320,95:400,100:480,105:575,110:645,115:685,120:725,125:765">
        </div>

        <div class="hr"></div>
        <h3 class="section-title">Surperformance (au-del√† de 125%)</h3>
        <div class="row">
          <span class="small">Bonus Pr√©voyance / tranche de +5% :</span>
          <input class="surprev" data-save="1" type="number" min="0" step="1" value="100" style="width:120px" />
          <span class="small">Bonus ER Contrats / tranche de +5% :</span>
          <input class="surer" data-save="1" type="number" min="0" step="1" value="20" style="width:120px" />
          <span class="note">Les bonus de surperf ne sont pas bonifi√©s par le qualitatif.</span>
        </div>

        <div class="hr"></div>
        <h3 class="section-title">Qualitatif (N√©obsia & Multi)</h3>
        <div class="row">
          <span class="small">Majoration N√©obsia :</span>
          <select class="q_neo" data-save="1">
            <option value="0">‚Äî</option>
            <option value="5">Palier 1 (+5%)</option>
            <option value="10">Palier 2 (+10%)</option>
            <option value="20">Palier 3 (+20%)</option>
          </select>
          <span class="small">Majoration Multi-propositions :</span>
          <select class="q_multi" data-save="1">
            <option value="0">‚Äî</option>
            <option value="5">Palier 1 (+5%)</option>
            <option value="10">Palier 2 (+10%)</option>
            <option value="20">Palier 3 (+20%)</option>
          </select>
        </div>

        <div class="hr"></div>
        <h3 class="section-title">Collectif Sant√©</h3>
        <div class="row">
          <span class="small">Condition : R/O ‚â• 65% sur au moins un objectif (Pr√©, ER contrats ou ER CA‚Ç¨)</span>
        </div>
        <div class="row">
          <span class="small">Palier atteint :</span>
          <select class="coll_palier" data-save="1">
            <option value="0">‚Äî</option>
            <option value="1">P1 (280 ‚Ç¨)</option>
            <option value="2">P2 (555 ‚Ç¨)</option>
            <option value="3">P3 (885 ‚Ç¨)</option>
          </select>
        </div>
        <div class="hr"></div>
        <div class="row actions">
          <button class="btn btn-primary calc">Calculer</button>
          <button class="btn btn-ghost savehist" title="Ajoute cette simulation √† l'historique">Enregistrer dans l'historique</button>
        </div>
      </section>

      <section class="card" style="grid-column: span 12">
        <div class="row">
          <div class="kpi card">
            <div class="label">% atteinte Pr√©voyance</div>
            <div class="value ro_prev">0%</div>
            <div class="delta small badge badge-warn ro_prev_badge">‚Äî</div>
          </div>
          <div class="kpi card">
            <div class="label">% atteinte ER (contrats)</div>
            <div class="value ro_er_c">0%</div>
            <div class="delta small badge badge-warn ro_er_c_badge">‚Äî</div>
          </div>
          <div class="kpi card">
            <div class="label">% atteinte ER (CA‚Ç¨)</div>
            <div class="value ro_er_e">0%</div>
            <div class="delta small badge badge-warn ro_er_e_badge">‚Äî</div>
          </div>
          <div class="kpi card">
            <div class="label">Prime √©co totale</div>
            <div class="value prime_eco">0 ‚Ç¨</div>
            <div class="delta small">(Pr√© + ER contrats + ER CA‚Ç¨)</div>
          </div>
          <div class="kpi card">
            <div class="label">Surperformance</div>
            <div class="value prime_surperf">0 ‚Ç¨</div>
            <div class="delta small">Pr√©voyance + ER contrats</div>
          </div>
          <div class="kpi card">
            <div class="label">Bonifs qualit√©</div>
            <div class="value prime_qual">0 ‚Ç¨</div>
          </div>
          <div class="kpi card">
            <div class="label">Collectif Sant√©</div>
            <div class="value prime_coll">0 ‚Ç¨</div>
          </div>
          <div class="kpi card">
            <div class="label">Total</div>
            <div class="value total">0 ‚Ç¨</div>
          </div>
        </div>
        <div class="hr"></div>
        <h3 class="section-title">D√©tail du calcul</h3>
        <textarea class="details" rows="12" readonly>Effectue un calcul puis reviens ici : le d√©tail s'affichera.</textarea>
      </section>
    </div>
  `;

  const $ = sel => root.querySelector(sel);
  const SAVE_PREFIX = 'v67.';

  const els = {
    printBtn: $('.print'), clearBtn: $('.clear'), saveHist: $('.savehist'),
    ca_prev: $('.ca_prev'), pullPrev: $('.pullPrev'), obj_prev: $('.obj_prev'),
    nb_er: $('.nb_er'), obj_er: $('.obj_er'),
    ca_er: $('.ca_er'), obj_er_eur: $('.obj_er_eur'),
    b_prev: $('.b_prev'), b_er_c: $('.b_er_c'), b_er_e: $('.b_er_e'),
    surprev: $('.surprev'), surer: $('.surer'),
    q_neo: $('.q_neo'), q_multi: $('.q_multi'),
    coll_palier: $('.coll_palier'),
    calc: $('.calc'),
    ro_prev: $('.ro_prev'), ro_er_c: $('.ro_er_c'), ro_er_e: $('.ro_er_e'),
    ro_prev_badge: $('.ro_prev_badge'), ro_er_c_badge: $('.ro_er_c_badge'), ro_er_e_badge: $('.ro_er_e_badge'),
    prime_eco: $('.prime_eco'), prime_surperf: $('.prime_surperf'), prime_qual: $('.prime_qual'),
    prime_coll: $('.prime_coll'), total: $('.total'),
    details: $('.details')
  };

  // Autosave / restore
  function restoreAll(){
    root.querySelectorAll('[data-save="1"]').forEach(el => {
      const key = SAVE_PREFIX + el.className.split(' ')[0];
      const val = localStorage.getItem(key);
      if(val!=null){ el.value = val; }
      const handler = ()=> localStorage.setItem(key, el.value);
      el.addEventListener('input', handler);
      el.addEventListener('change', handler);
    });
  }
  restoreAll();

  // Prefill CA prev from previous tab
  const savedCA = Number(localStorage.getItem('calc.ca_prev')||0) || 0;
  if(savedCA>0 && !els.ca_prev.value) els.ca_prev.value = Math.round(savedCA);
  els.pullPrev.addEventListener('click', () => {
    const prevData = JSON.parse(localStorage.getItem('prev.data')||'[]');
    const totalAnnual = prevData.reduce((s,d)=> s + (Number(d.annual)||0), 0);
    els.ca_prev.value = Math.round(totalAnnual);
  });

  els.printBtn.addEventListener('click', () => window.print());
  els.clearBtn.addEventListener('click', () => {
    if(confirm('R√©initialiser les param√®tres sauvegard√©s ?')){
      root.querySelectorAll('[data-save="1"]').forEach(el => {
        const key = SAVE_PREFIX + el.className.split(' ')[0];
        localStorage.removeItem(key);
      });
      alert('Param√®tres effac√©s. Recharge la page pour revenir aux valeurs par d√©faut.');
    }
  });

  els.calc.addEventListener('click', compute);
  els.saveHist.addEventListener('click', saveToHistory);

  function parseBar√®me(txt){
    const parts = txt.split(',').map(s=>s.trim()).filter(Boolean);
    const arr = parts.map(p => {
      const [k,v] = p.split(':').map(x=>x.trim());
      return {k: Number(k), v: Number(v)};
    }).filter(x=> !isNaN(x.k) && !isNaN(x.v)).sort((a,b)=> a.k-b.k);
    return arr;
  }
  function valueFromBar√®me(ro, arr){
    if(!arr.length) return 0;
    let val = 0;
    for(const it of arr){
      if(ro >= it.k) val = it.v;
      else break;
    }
    return val;
  }
  function badgeText(p){ return p>=125? 'Surperf' : p>=100? 'Objectif OK' : p>=80? 'En bonne voie' : '√Ä la tra√Æne'; }
  function setBadge(el,p){
    el.textContent = badgeText(p);
    el.className = 'delta small badge ' + (p>=125? 'badge-over' : p>=100? 'badge-ok' : p>=80? 'badge-warn' : '');
  }

  function compute(){
    const caPrev = Number(els.ca_prev.value||0), objPrev = Number(els.obj_prev.value||0);
    const nbER = Number(els.nb_er.value||0), objER = Number(els.obj_er.value||0);
    const caER = Number(els.ca_er.value||0), objEREur = Number(els.obj_er_eur.value||0);

    const roPrev = objPrev>0 ? (caPrev/objPrev*100) : 0;
    const roERc = objER>0 ? (nbER/objER*100) : 0;
    const roERe = objEREur>0 ? (caER/objEREur*100) : 0;

    els.ro_prev.textContent = (Math.round(roPrev*10)/10)+'%';
    els.ro_er_c.textContent = (Math.round(roERc*10)/10)+'%';
    els.ro_er_e.textContent = (Math.round(roERe*10)/10)+'%';
    setBadge(els.ro_prev_badge, roPrev);
    setBadge(els.ro_er_c_badge, roERc);
    setBadge(els.ro_er_e_badge, roERe);

    const bPrev = parseBar√®me(els.b_prev.value);
    const bERc = parseBar√®me(els.b_er_c.value);
    const bERe = parseBar√®me(els.b_er_e.value);

    const pPrev = valueFromBar√®me(roPrev, bPrev);
    const pERc = valueFromBar√®me(roERc, bERc);
    const pERe = valueFromBar√®me(roERe, bERe);

    const primeEco = pPrev + pERc + pERe;
    els.prime_eco.textContent = fmt0.format(primeEco);

    // Surperformance (non bonifi√©e)
    const perPrev = Number(els.surprev.value||100);
    const perER = Number(els.surer.value||20);
    const trPrev = roPrev>125 ? Math.floor((roPrev-125)/5) : 0;
    const trER = roERc>125 ? Math.floor((roERc-125)/5) : 0;
    const primeSurperf = trPrev*perPrev + trER*perER;
    els.prime_surperf.textContent = fmt0.format(primeSurperf);

    // Qualitatif
    const qNeo = Number(els.q_neo.value||0);
    const qMul = Number(els.q_multi.value||0);
    const primeQual = Math.round(primeEco * (qNeo + qMul) / 100);
    els.prime_qual.textContent = fmt0.format(primeQual);

    // Collectif
    let primeColl = 0;
    const eligible = (roPrev>=65) || (roERc>=65) || (roERe>=65);
    if(eligible){
      const pal = Number(els.coll_palier.value||0);
      primeColl = pal===1 ? 280 : pal===2 ? 555 : pal===3 ? 885 : 0;
    }
    els.prime_coll.textContent = fmt0.format(primeColl);

    const total = primeEco + primeSurperf + primeQual + primeColl;
    els.total.textContent = fmt0.format(total);

    // Details
    const br = [];
    br.push('‚Äî R√©capitulatif v6.7 ‚Äî');
    br.push(`Pr√©voyance : CA ${fmt0.format(caPrev)} / Obj ${fmt0.format(objPrev)} ‚Üí R/O ${roPrev.toFixed(1)}%`);
    br.push(`  ‚Ä¢ Bar√®me: ${fmt0.format(pPrev)}`);
    br.push(`  ‚Ä¢ Surperf Pr√©: ${trPrev} √ó ${fmt0.format(perPrev)} = ${fmt0.format(trPrev*perPrev)}`);
    br.push(`ER Contrats : ${nbER} / Obj ${objER} ‚Üí R/O ${roERc.toFixed(1)}%`);
    br.push(`  ‚Ä¢ Bar√®me: ${fmt0.format(pERc)}`);
    br.push(`  ‚Ä¢ Surperf ER: ${trER} √ó ${fmt0.format(perER)} = ${fmt0.format(trER*perER)}`);
    br.push(`ER CA‚Ç¨ : ${fmt0.format(caER)} / Obj ${fmt0.format(objEREur)} ‚Üí R/O ${roERe.toFixed(1)}%`);
    br.push(`  ‚Ä¢ Bar√®me: ${fmt0.format(pERe)}`);
    br.push(`Qualitatif : ${(qNeo+qMul)||0}% √ó base ${fmt0.format(primeEco)} = ${fmt0.format(primeQual)}`);
    br.push(`Collectif Sant√© : ${eligible ? '√âligible' : 'Non √©ligible'} ‚Üí ${fmt0.format(primeColl)}`);
    br.push(`TOTAL: ${fmt0.format(total)}`);
    els.details.value = br.join('\n');

    const state = { caPrev, objPrev, nbER, objER, caER, objEREur, roPrev, roERc, roERe, primeEco, primeSurperf, primeQual, primeColl, total };
    localStorage.setItem('v67.lastCalc', JSON.stringify(state));
  }

  function saveToHistory(){
    const raw = localStorage.getItem('v67.lastCalc');
    if(!raw){ alert('Fais d‚Äôabord un calcul.'); return; }
    const st = JSON.parse(raw);
    st.ts = new Date().toISOString();
    const list = JSON.parse(localStorage.getItem('v67.history')||'[]');
    list.push(st);
    localStorage.setItem('v67.history', JSON.stringify(list));
    alert('Ajout√© √† l‚Äôhistorique ‚úî');
  }
}

/* ===== Global tab ===== */
function buildGlobalPanel(){
  const root = document.getElementById('global');
  root.innerHTML = `
    <div class="grid">
      <section class="card" style="grid-column: span 12">
        <div class="row" style="justify-content:space-between; width:100%">
          <h3 class="section-title">Vue globale annuelle</h3>
          <div class="actions">
            <button class="btn btn-ghost print">Exporter PDF</button>
            <button class="btn btn-ghost pull">‚Üê r√©cup√©rer la derni√®re simulation</button>
          </div>
        </div>
        <div class="row">
          <div class="kpi card">
            <div class="label">R/O global (moyenne 3 obj.)</div>
            <div class="value ro_global">‚Äî</div>
            <div class="delta small badge ro_global_badge">‚Äî</div>
          </div>
          <div class="kpi card">
            <div class="label">CA Pr√©voyance</div>
            <div class="value ca_prev">‚Äî</div>
            <div class="delta small">Objectif: <span class="obj_prev">‚Äî</span></div>
          </div>
          <div class="kpi card">
            <div class="label">ER Contrats</div>
            <div class="value er_c">‚Äî</div>
            <div class="delta small">Objectif: <span class="obj_er">‚Äî</span></div>
          </div>
          <div class="kpi card">
            <div class="label">CA ER</div>
            <div class="value ca_er">‚Äî</div>
            <div class="delta small">Objectif: <span class="obj_er_eur">‚Äî</span></div>
          </div>
          <div class="kpi card">
            <div class="label">Prime totale</div>
            <div class="value prime_total">‚Äî</div>
            <div class="delta small">(√©co + surperf + qualitatif + collectif)</div>
          </div>
        </div>
      </section>
    </div>
  `;

  const $ = sel => root.querySelector(sel);
  const els = {
    printBtn: $('.print'), pullBtn: $('.pull'),
    ro_global: $('.ro_global'), ro_global_badge: $('.ro_global_badge'),
    ca_prev: $('.ca_prev'), obj_prev: $('.obj_prev'),
    er_c: $('.er_c'), obj_er: $('.obj_er'),
    ca_er: $('.ca_er'), obj_er_eur: $('.obj_er_eur'),
    prime_total: $('.prime_total')
  };
  els.printBtn.addEventListener('click', ()=> window.print());
  els.pullBtn.addEventListener('click', fillFromLast);

  function badgeText(p){ return p>=125? 'Surperf' : p>=100? 'Objectif OK' : p>=80? 'En bonne voie' : '√Ä la tra√Æne'; }
  function setBadge(el,p){
    el.textContent = badgeText(p);
    el.className = 'delta small badge ' + (p>=125? 'badge-over' : p>=100? 'badge-ok' : p>=80? 'badge-warn' : '');
  }

  function fillFromLast(){
    const raw = localStorage.getItem('v67.lastCalc'); if(!raw){ alert('Aucune simulation trouv√©e. Va dans l‚Äôonglet Calculateur.'); return; }
    const s = JSON.parse(raw);
    const roGlobal = (s.roPrev + s.roERc + s.roERe) / 3;
    els.ro_global.textContent = (Math.round(roGlobal*10)/10)+'%';
    setBadge(els.ro_global_badge, roGlobal);
    els.ca_prev.textContent = fmt0.format(s.caPrev); els.obj_prev.textContent = fmt0.format(s.objPrev);
    els.er_c.textContent = s.nbER + ' contrats'; els.obj_er.textContent = s.objER + ' contrats';
    els.ca_er.textContent = fmt0.format(s.caER); els.obj_er_eur.textContent = fmt0.format(s.objEREur);
    els.prime_total.textContent = fmt0.format(s.total);
  }
}

/* ===== Plan tab (route simple jusqu'√† d√©cembre) ===== */



function buildPlanPanel(){
  const root = document.getElementById('plan');
  // persist week mode
  try{ localStorage.setItem('plan.weekMode','iso'); }catch(e){}

  root.innerHTML = `
    <div class="grid">
      <section class="card" style="grid-column: span 12">
        <h3 class="section-title">Suivi hebdomadaire (Semaines ISO) ‚Üí Objectif mensuel ‚Üí Objectif annuel</h3>

        <div class="row" style="flex-wrap:wrap; gap:8px">
          <span class="small">Vue</span>
          <select class="view">
            <option value="mois">Mois</option>
            <option value="annee">Ann√©e</option>
          </select>

          <span class="small">Ann√©e</span>
          <select class="year"></select>

          <span class="small month-label">Mois</span>
          <select class="month"></select>

          <span class="small">Objectif annuel (‚Ç¨)</span>
          <input class="goal" type="number" min="0" step="1" placeholder="ex. 70000" />

          <span class="small">Source</span>
          <select class="mode">
            <option value="auto" selected>Auto (Pr√©voyance)</option>
            <option value="manual">Manuelle</option>
          </select>

          <span class="small">Objectif du mois (‚Ç¨)</span>
          <input class="mgoal" type="number" min="0" step="1" placeholder="ex. 6000" />

          <button class="btn btn-primary saveGoals">Enregistrer objectifs</button>

          <!-- Champs invisibles pour compat sc√©narios existants -->
          <input class="ytd" type="number" style="display:none" />
          <input class="basket" type="number" style="display:none" value="60" />
          <button class="btn btn-ghost toSimu" style="display:none">‚Üí Pr√©-remplir l‚Äôonglet Simulation</button>
        </div>

        <div class="hr"></div>

        <div class="row" style="flex-wrap:wrap; gap:8px; align-items:flex-start">
          <h4 class="section-title" style="margin:0">Semaines ISO</h4>
          <div class="weeks" style="flex:1 1 100%"></div>
          <div class="actions">
            <button class="btn btn-ghost export">Exporter (CSV)</button>
            <button class="btn btn-danger reset">R√©initialiser</button>
          </div>
        </div>

        <div class="hr"></div>
        <div class="row" style="flex-direction:column; gap:10px; width:100%">
          <div class="kpi card">
            <div class="label">Avancement mensuel</div>
            <div class="value msum">0 ‚Ç¨</div>
            <div class="delta small">Objectif du mois : <span class="mgoal_view">‚Äî</span> ‚Ä¢ Progression : <span class="mpct">0%</span></div>
            <div class="progress"><div class="bar mbar" style="width:0%"></div></div>
          </div>
          <div class="kpi card">
            <div class="label">Avancement annuel (YTD)</div>
            <div class="value ytdsum">0 ‚Ç¨</div>
            <div class="delta small">Objectif annuel : <span class="goal_view">‚Äî</span> ‚Ä¢ Progression : <span class="ypct">0%</span></div>
            <div class="progress"><div class="bar ybar" style="width:0%"></div></div>
          </div>
        </div>
      </section>
    </div>
  `;

  const $ = sel => root.querySelector(sel);
  const els = {
    view: $('.view'), year: $('.year'), month: $('.month'), monthLabel: $('.month-label'),
    goal: $('.goal'), mgoal: $('.mgoal'), saveGoals: $('.saveGoals'), mode: $('.mode'),
    weeks: $('.weeks'), exportBtn: $('.export'), resetBtn: $('.reset'),
    msum: $('.msum'), mgoal_view: $('.mgoal_view'), mpct: $('.mpct'), mbar: $('.mbar'),
    ytdsum: $('.ytdsum'), goal_view: $('.goal_view'), ypct: $('.ypct'), ybar: $('.ybar'),
    ytd: $('.ytd')
  };

  // ===== Helpers =====
  function ymd(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
  function clone(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
  function addDays(d, n){ const r = clone(d); r.setDate(r.getDate()+n); return r; }
  function daysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }
  function round0(x){ return Math.round(Number(x)||0); }

  // ISO week helpers
  function startOfISOWeek(d){ const r = clone(d); const day = (r.getDay()+6)%7; r.setDate(r.getDate()-day); return r; } // Monday
  function endOfISOWeek(d){ return addDays(startOfISOWeek(d),6); }
  function isoWeekYear(d){
    const r = clone(d);
    const th = addDays(r, 3 - ((r.getDay()+6)%7)); // Thursday
    return th.getFullYear();
  }
  function isoWeekNumber(d){
    const r = clone(d);
    const ws = startOfISOWeek(r);
    const th = addDays(r, 3 - ((r.getDay()+6)%7));
    const jan4 = new Date(th.getFullYear(), 0, 4);
    const w1 = startOfISOWeek(jan4);
    const diffDays = Math.round((ws - w1)/86400000);
    return Math.floor(diffDays/7) + 1;
  }

  function isoWeeksForMonth(year, monthIndex){
    const first = new Date(year, monthIndex, 1);
    const last = new Date(year, monthIndex, daysInMonth(year, monthIndex));
    const start = startOfISOWeek(first);
    const end = endOfISOWeek(last);
    const out = [];
    for(let d = clone(start); d <= end; d = addDays(d,7)){
      const s = clone(d);
      const e = endOfISOWeek(s);
      const iy = isoWeekYear(s);
      const iw = isoWeekNumber(s);
      out.push({ isoYear: iy, isoWeek: iw, start: ymd(s), end: ymd(e), key: `${iy}-W${String(iw).padStart(2,'0')}` });
    }
    return out;
  }

  function isoWeeksForYear(year){
    const jan4 = new Date(year,0,4);
    let d = startOfISOWeek(jan4); // Monday of ISO week 1
    const out = [];
    while(true){
      const iy = isoWeekYear(d);
      if(iy !== year) break;
      const s = clone(d);
      const e = endOfISOWeek(s);
      const iw = isoWeekNumber(s);
      out.push({ isoYear: iy, isoWeek: iw, start: ymd(s), end: ymd(e), key: `${iy}-W${String(iw).padStart(2,'0')}` });
      d = addDays(d,7);
    }
    return out;
  }

  // Data from Pr√©voyance
  function loadPrevData(){
    try{ const j = localStorage.getItem('prev.data'); return j? JSON.parse(j): []; }catch(e){ return []; }
  }

  function autoTotalsFor(weeks){
    const data = loadPrevData();
    const map = new Map();
    for(const r of data){
      const ds = (r.date||'').trim(); if(!ds) continue;
      const m = ds.match(/^(\d{4})-(\d{2})-(\d{2})$/); if(!m) continue;
      const d = new Date(Number(m[1]), Number(m[2])-1, Number(m[3]));
      const iy = isoWeekYear(d); const iw = isoWeekNumber(d);
      const key = `${iy}-W${String(iw).padStart(2,'0')}`;
      map.set(key, (map.get(key)||0) + (Number(r.annual)||0));
    }
    // Round each weekly total to nearest euro
    return weeks.map(w => round0(map.get(w.key)||0));
  }

  // YTD helpers
  function sumAnnualInMonth(data, year, month){ // month 0..11
    const ym = `${year}-${String(month+1).padStart(2,'0')}`;
    // Round monthly sums as integers too
    const s = data.reduce((s,d)=> s + ((d.date||'').startsWith(ym) ? (Number(d.annual)||0) : 0), 0);
    return round0(s);
  }

  // Storage helpers
  function kAnnual(){ return 'plan.annual.goal'; }
  function kMGoal(ym){ return 'plan.month.goal.'+ym; }
  function kWeeksMonth(ym){ return 'plan.month.weeks.'+ym; }
  function kWeeksYear(y){ return 'plan.year.weeks.'+y; }

  function loadAnnual(){ return round0(localStorage.getItem(kAnnual())||0); }
  function saveAnnual(v){ localStorage.setItem(kAnnual(), String(round0(v))); }
  function loadMGoal(ym){ return round0(localStorage.getItem(kMGoal(ym))||0); }
  function saveMGoal(ym,v){ localStorage.setItem(kMGoal(ym), String(round0(v))); }
  function loadWeeksMonth(ym){ try{ const j=localStorage.getItem(kWeeksMonth(ym)); return j? JSON.parse(j).map(round0): []; }catch(e){ return []; } }
  function saveWeeksMonth(ym, arr){ localStorage.setItem(kWeeksMonth(ym), JSON.stringify(arr.map(round0))); }
  function loadWeeksYear(y){ try{ const j=localStorage.getItem(kWeeksYear(y)); return j? JSON.parse(j).map(round0): []; }catch(e){ return []; } }
  function saveWeeksYear(y, arr){ localStorage.setItem(kWeeksYear(y), JSON.stringify(arr.map(round0))); }

  // Selectors init (persisted)
  const now = new Date();
  const curYear = now.getFullYear();
  const curMonth = now.getMonth(); // 0..11

  const savedView = localStorage.getItem('plan.view') || 'mois';
  els.view.value = (savedView==='annee'?'annee':'mois');

  // Year list: +/- 3 years around current + any years from data
  const years = (()=>{
    const set = new Set([curYear-1, curYear, curYear+1, curYear+2]);
    const d = loadPrevData();
    d.forEach(r => { const y = (r.date||'').slice(0,4); if(y) set.add(Number(y)); });
    return Array.from(set).sort((a,b)=>a-b);
  })();
  els.year.innerHTML = years.map(y=> `<option value="${y}">${y}</option>`).join('');
  const savedYear = Number(localStorage.getItem('plan.year')||curYear) || curYear;
  if(years.includes(savedYear)) els.year.value = String(savedYear); else els.year.value = String(curYear);

  function fillMonthSelect(){
    const y = Number(els.year.value)||curYear;
    const opts = Array.from({length:12},(_,i)=>{
      const ym = `${y}-${String(i+1).padStart(2,'0')}`;
      return `<option value="${ym}">${ym}</option>`;
    }).join('');
    els.month.innerHTML = opts;
    const savedMonth = localStorage.getItem('plan.month') || `${curYear}-${String(curMonth+1).padStart(2,'0')}`;
    const targetYM = savedMonth.startsWith(String(y)) ? savedMonth : `${y}-01`;
    els.month.value = targetYM;
  }
  fillMonthSelect();

  // Goals init
  const ym0 = els.month.value;
  const aGoal = loadAnnual();
  const mGoal = loadMGoal(ym0) || round0((aGoal||0)/12);
  if(aGoal>0) els.goal.value = aGoal;
  if(mGoal>0) els.mgoal.value = mGoal;

  // Render UI
  function renderWeeks(){
    const view = els.view.value;
    const mode = els.mode.value;
    const yearSel = Number(els.year.value)||curYear;
    const ym = els.month.value;
    const [ySel, mSel] = ym.split('-').map(Number);
    const wdefs = view==='mois' ? isoWeeksForMonth(ySel, mSel-1) : isoWeeksForYear(yearSel);

    let vals = [];
    if(mode==='auto'){
      vals = autoTotalsFor(wdefs);
    }else{
      if(view==='mois'){
        vals = loadWeeksMonth(ym);
        while(vals.length < wdefs.length) vals.push(0);
      }else{
        vals = loadWeeksYear(yearSel);
        while(vals.length < wdefs.length) vals.push(0);
      }
    }

    const rows = wdefs.map((w,idx)=>{
      const v = round0(vals[idx]||0);
      const input = mode==='auto'
        ? `<input data-week="${idx}" type="number" min="0" step="1" value="${v}" style="width:160px" disabled />`
        : `<input data-week="${idx}" type="number" min="0" step="1" value="${v}" style="width:160px" />`;
      return `<div class="row" style="gap:12px; align-items:center">
        <span class="small" style="width:320px">${w.isoYear}-W${String(w.isoWeek).padStart(2,'0')} : ${w.start} ‚Üí ${w.end}</span>
        ${input}<span class="small">‚Ç¨</span>
      </div>`;
    }).join('');
    els.weeks.innerHTML = rows;

    if(mode!=='auto'){
      els.weeks.querySelectorAll('input[type="number"]').forEach(inp=>{
        inp.addEventListener('input', ()=>{
          const current = Array.from(els.weeks.querySelectorAll('input')).map(x=> round0(x.value||0));
          if(view==='mois'){ saveWeeksMonth(ym, current); } else { saveWeeksYear(yearSel, current); }
          recalc(); // update KPIs
        });
      });
    }
  }

  // Recalculate KPIs (rounded)
  function colorFor(pct){ return pct>=125? 'var(--over)' : pct>=100? 'var(--ok)' : pct>=80? 'var(--warn)' : 'var(--danger)'; }
  function fmt0eur(x){ return new Intl.NumberFormat('fr-FR', {style:'currency', currency:'EUR', maximumFractionDigits:0}).format(round0(x||0)); }

  function recalc(){
    const view = els.view.value;
    const mode = els.mode.value;
    const ym = els.month.value;
    const [ySel, mSel] = ym.split('-').map(Number);
    const yearSel = Number(els.year.value)||ySel;

    const wdefs = view==='mois' ? isoWeeksForMonth(ySel, mSel-1) : isoWeeksForYear(yearSel);
    const valsRaw = (mode==='auto')
      ? autoTotalsFor(wdefs)
      : (view==='mois' ? loadWeeksMonth(ym).slice(0, wdefs.length) : loadWeeksYear(yearSel).slice(0, wdefs.length));
    const vals = valsRaw.map(round0);

    // Monthly KPIs only meaningful for Vue "Mois"
    const msum = vals.reduce((s,x)=> s+(Number(x)||0), 0);
    const mgoal = round0( Number(els.mgoal.value||0) || loadMGoal(ym) || round0((Number(els.goal.value||0) || loadAnnual())/12) );
    els.mgoal.value = mgoal;
    els.msum.textContent = fmt0eur(msum);
    els.mgoal_view.textContent = fmt0eur(mgoal);
    const mpct = mgoal>0 ? (msum/mgoal*100) : 0;
    els.mpct.textContent = (Math.round(mpct*10)/10)+'%';
    els.mbar.style.width = Math.min(100, Math.round(mpct))+'%';
    els.mbar.style.background = colorFor(mpct);
    // Show/hide monthly KPI based on view
    const monthlyCard = els.msum.closest('.kpi');
    monthlyCard.style.display = (view==='mois') ? '' : 'none';

    // YTD
    let ytd = 0;
    if(mode==='auto'){
      const data = loadPrevData();
      for(let mm=0; mm <= (view==='mois' ? (mSel-1) : 11); mm++){
        ytd += sumAnnualInMonth(data, yearSel, mm);
      }
    }else{
      if(view==='mois'){
        for(let mm=1; mm<=mSel; mm++){
          const ymx = `${yearSel}-${String(mm).padStart(2,'0')}`;
          ytd += loadWeeksMonth(ymx).map(round0).reduce((s,x)=> s+(Number(x)||0),0);
        }
      }else{
        ytd = vals.reduce((s,x)=> s+(Number(x)||0),0);
      }
    }
    ytd = round0(ytd);
    const agoal = round0(Number(els.goal.value||0) || loadAnnual());
    els.ytd.value = ytd;
    els.ytdsum.textContent = fmt0eur(ytd);
    els.goal_view.textContent = fmt0eur(agoal);
    const ypct = agoal>0 ? (ytd/agoal*100) : 0;
    els.ypct.textContent = (Math.round(ypct*10)/10)+'%';
    els.ybar.style.width = Math.min(100, Math.round(ypct))+'%';
    els.ybar.style.background = colorFor(ypct);
  }

  // Export CSV (rounded)
  els.exportBtn.addEventListener('click', ()=>{
    const view = els.view.value;
    const mode = els.mode.value;
    const ym = els.month.value;
    const [ySel, mSel] = ym.split('-').map(Number);
    const yearSel = Number(els.year.value)||ySel;
    const wdefs = view==='mois' ? isoWeeksForMonth(ySel, mSel-1) : isoWeeksForYear(yearSel);
    const valsRaw = (mode==='auto') ? autoTotalsFor(wdefs)
                                 : (view==='mois' ? loadWeeksMonth(ym).slice(0, wdefs.length) : loadWeeksYear(yearSel).slice(0, wdefs.length));
    const vals = valsRaw.map(round0);

    const headers = ['year','isoWeek','weekStart','weekEnd','amount','monthShown','mode'];
    const lines = [headers.join(';')].concat(
      wdefs.map((w,i)=>[w.isoYear, String(w.isoWeek).padStart(2,'0'), w.start, w.end, round0(vals[i]||0),
                        (view==='mois'? ym : ''), mode].join(';'))
    );
    const blob = new Blob([lines.join('\\n')], {type:'text/csv;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = (view==='mois' ? `plan_${ym}.csv` : `plan_${yearSel}.csv`);
    a.click(); URL.revokeObjectURL(a.href);
  });

  // Reset
  els.resetBtn.addEventListener('click', ()=>{
    const view = els.view.value;
    const ym = els.month.value;
    const yearSel = Number(els.year.value)||new Date().getFullYear();
    if(view==='mois'){
      if(confirm(`R√©initialiser les semaines (manuel) pour ${ym} ?`)){ saveWeeksMonth(ym, []); renderWeeks(); recalc(); }
    }else{
      if(confirm(`R√©initialiser les semaines (manuel) pour l'ann√©e ${yearSel} ?`)){ saveWeeksYear(yearSel, []); renderWeeks(); recalc(); }
    }
  });

  // Goals save
  els.saveGoals.addEventListener('click', ()=>{
    const ym = els.month.value;
    saveAnnual(els.goal.value);
    saveMGoal(ym, els.mgoal.value);
    recalc();
  });

  // Reactivity
  function onViewChange(){
    const v = els.view.value;
    els.month.style.display = (v==='mois') ? '' : 'none';
    els.monthLabel.style.display = (v==='mois') ? '' : 'none';
    localStorage.setItem('plan.view', v);
    renderWeeks(); recalc();
  }
  els.view.addEventListener('change', onViewChange);

  els.year.addEventListener('change', ()=>{
    localStorage.setItem('plan.year', els.year.value);
    fillMonthSelect();
    renderWeeks(); recalc();
  });

  els.month.addEventListener('change', ()=>{
    localStorage.setItem('plan.month', els.month.value);
    const mg = loadMGoal(els.month.value) || round0((loadAnnual()||0)/12);
    els.mgoal.value = mg>0 ? mg : '';
    renderWeeks(); recalc();
  });

  els.mode.addEventListener('change', ()=>{ renderWeeks(); recalc(); });

  // Initial render
  onViewChange(); // sets visibility + render
}

/* ===== Prise en charge GAV ‚Äî Module int√©gr√© ===== */
function buildGAVPanel() {
  const root = document.getElementById('gav');
  if(!root) return;
  root.innerHTML = `<section id="tab-prise-gav" class="gav-wrap" data-module="prise-gav">
  <style>
    /* v1.8 ‚Äî Theme-adaptive, z√©ro d√©pendance externe, CSP-friendly */
    .gav-wrap{font-family:inherit;color:var(--text,inherit);background:inherit}
    .gav-container{max-width:1200px;margin:0 auto;padding:16px}
    .gav-header{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .gav-title{font-size:1.5rem;font-weight:800;color:var(--text,#e5e7eb);display:flex;gap:10px;align-items:center}
    .gav-title .emoji{font-size:1.6rem}

    /* Inputs */
    .gav-select,.gav-input{appearance:none;border:1px solid var(--border,#1f2937);background:var(--bg,#0b1220);color:var(--text,#e5e7eb);border-radius:12px;padding:10px 12px;font-weight:600}
    .gav-select:focus,.gav-input:focus{outline:none;box-shadow:0 0 0 2px rgba(59,130,246,.25)}

    /* Badges & chips */
    .gav-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:.8rem;font-weight:700;border:1px solid var(--border,#1f2937);background:var(--bg, transparent);color:var(--text,#e5e7eb)}
    .gav-chip{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;font-size:.75rem;border:1px solid var(--border,#1f2937);background:var(--bg, transparent);color:var(--muted,#94a3b8)}
    .gav-pill{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(59,130,246,.15);color:#93c5fd;font-weight:800;font-size:.75rem;border:1px solid rgba(30,64,175,.6)}

    /* Layout */
    .gav-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px;margin-top:16px}
    .gav-card{grid-column:span 12;background:var(--panel, var(--card-bg, transparent));border:1px solid var(--border,#1f2937);border-radius:16px;padding:14px;box-shadow:0 12px 40px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.03);transition:transform .12s ease, box-shadow .12s ease}
    .gav-card:hover{transform:translateY(-1px);box-shadow:0 16px 44px rgba(0,0,0,.34)}
    @media(min-width:720px){.gav-card{grid-column:span 6}}
    @media(min-width:1040px){.gav-card{grid-column:span 4}}

    .gav-card-head{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    .gav-card-title{font-weight:800;color:var(--text,#e5e7eb)}
    .gav-tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .gav-money{font-size:1.25rem;font-weight:900;color:var(--accent2,#3b82f6)}
    .gav-muted{color:var(--muted,#94a3b8);font-size:.9rem}

    /* Compare bar */
    .gav-compare{margin-top:8px}
    .gav-bar{height:10px;border-radius:10px;background:var(--bg,#0b1220);position:relative;overflow:hidden;border:1px solid var(--border,#1f2937)}
    .gav-bar .left{position:absolute;left:0;top:0;height:100%;background:var(--barLeft,#334155)}
    .gav-bar .right{position:absolute;left:0;top:0;height:100%;background:linear-gradient(90deg,var(--accent,#22c55e),var(--accent2,#3b82f6));opacity:.9}
    .gav-figures{display:flex;justify-content:space-between;font-size:.8rem;margin-top:6px;color:var(--muted,#94a3b8)}

    /* Actions / buttons */
    .gav-actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .gav-btn{cursor:pointer;border:1px solid transparent;background:linear-gradient(180deg,var(--accent2,#3b82f6),#1d4ed8);color:#fff;font-weight:800;border-radius:12px;padding:9px 12px}
    .gav-btn.sec{background:transparent;color:var(--text,#e5e7eb);border-color:var(--border,#1f2937)}

    /* Details & explainers */
    .gav-details{display:none;margin-top:10px;border-top:1px dashed var(--border,#1f2937);padding-top:10px;font-size:.95rem;color:var(--text,#e5e7eb)}
    .gav-explain{margin-top:10px;background:var(--panel, var(--card-bg, transparent));border:1px solid var(--border,#1f2937);border-radius:12px;padding:12px;display:none}
    .gav-explain h4{margin:0 0 8px 0;font-size:.95rem}
    .gav-explain ul{margin:0 0 8px 16px;padding:0}
    .gav-explain li{margin:4px 0}

    /* Table "Qui paie quoi ?" */
    .gav-table{display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:6px;font-size:.85rem;align-items:center}
    .gav-table .th{font-weight:800}
    .gav-table div{padding:6px 8px;background:var(--bg,#0b1220);border:1px solid var(--border,#1f2937);border-radius:8px;color:var(--text,#e5e7eb)}
    .gav-table .muted{color:var(--muted,#94a3b8);font-weight:600}
    .gav-legend{font-size:.75rem;color:var(--muted,#94a3b8);margin-top:6px}

    /* Empty */
    .gav-empty{padding:28px;background:transparent;border:1px dashed var(--border,#1f2937);border-radius:16px;text-align:center;color:var(--muted,#94a3b8)}

    /* Copy fallback */
    .gav-copypanel{margin-top:10px;background:var(--panel, var(--card-bg, transparent));border:1px solid var(--border,#1f2937);border-radius:12px;padding:12px;display:none}
    .gav-copypanel h4{margin:0 0 8px 0;font-size:.95rem}
    .gav-copytextarea{width:100%;min-height:80px;border:1px dashed var(--border,#1f2937);border-radius:8px;padding:8px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:var(--bg,#0b1220);color:var(--text,#e5e7eb)}
    .gav-copyactions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}

    /* Toast */
    .gav-toast{position:fixed;right:12px;bottom:12px;background:var(--accent2,#3b82f6);color:#fff;padding:10px 12px;border-radius:12px;font-weight:800;box-shadow:0 10px 30px rgba(2,6,23,.2);z-index:9999}
  </style>

  <div class="gav-container">
    <div class="gav-header">
      <div class="gav-title" id="titre-prise-gav"><span class="emoji">üõ°Ô∏è</span>Prise en <span class="gav-pill">GAV</span></div>
      <div class="gav-controls">
        <select id="gav-produit" class="gav-select" aria-label="Produit">
          <option value="GAV" selected>Produit : GAV</option>
          <option value="OBSEQUES">Obs√®ques (bient√¥t)</option>
          <option value="DECES">Capital D√©c√®s (bient√¥t)</option>
        </select>
        <select id="gav-cible" class="gav-select" aria-label="Cible">
          <option value="TOUS" selected>üéØ Cible : Toutes</option>
          <option value="Famille">Famille</option>
          <option value="Senior">Senior</option>
        <option value="Ado">Ado</option><option value="Adulte">Adulte</option></select>
        <select id="gav-type" class="gav-select" aria-label="Type d'accident">
          <option value="TOUS" selected>üè∑Ô∏è Type : Tous</option>
        </select>
        <input id="gav-search" class="gav-input" placeholder="üîé Rechercher (mots-cl√©s)‚Ä¶"/>
      </div>
    </div>

    <div id="gav-grid" class="gav-grid" role="list"></div>
    <div id="gav-debug" style="display:none;margin-top:10px;padding:10px;border-radius:12px;background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;font-size:12px;white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace"></div>
    <div id="gav-empty" class="gav-empty" style="display:none">Aucun cas ne correspond √† vos filtres.</div>

    <div class="gav-foot" style="margin-top:12px;color:var(--muted,#94a3b8);font-size:.85rem">
      <div>üí° Astuce RDV : utilisez ¬´ Copier l‚Äôargumentaire ¬ª pour coller une punchline adapt√©e au profil.</div>
      <div class="gav-sep" style="height:8px"></div>
      <div>Bar√®mes issus de vos CG GAV (AIPP ‚â• 5 %, valeur du point, +50 % si tierce personne, abattement > 70 ans, souffrances/esth√©tique 0,5‚Üí7, hospi 50 ‚Ç¨/jour, etc.). Montants illustratifs mais coh√©rents. Adaptez selon expertises.</div>
    </div>
  </div>

  
</section>`;
  try {
    var s = document.createElement('script');
    s.type = 'text/javascript';
    s.text = "(function(){\n    'use strict';\n    function dbgEl(){ return document.getElementById('gav-debug'); }\n    function dbg(m){ try{ var el=dbgEl(); if(!el) return; el.style.display='block'; var t=new Date().toLocaleTimeString('fr-FR'); el.textContent += '\\n['+t+'] '+m; }catch(e){} }\n    dbg('Init module PriseGAV‚Ä¶');\n\n    // --- Auto-skin pour s'int√©grer au th√®me h√¥te (d√©tecte fond clair/sombre)\n    var ROOT = document.getElementById('tab-prise-gav');\n    function parseRGB(str){ try{ var inside=(str||'').split('(')[1]; if(!inside) return [15,23,42]; inside=inside.split(')')[0]; var p=inside.split(','); return [parseInt(p[0],10)||15, parseInt(p[1],10)||23, parseInt(p[2],10)||42]; }catch(e){ return [15,23,42]; } }\n    function luminance(r,g,b){ r/=255; g/=255; b/=255; var a=[r,g,b].map(function(v){ return v<=0.03928? v/12.92 : Math.pow((v+0.055)/1.055,2.4); }); return 0.2126*a[0]+0.7152*a[1]+0.0722*a[2]; }\n    function applyAutoSkin(){\n      try{\n        if(!ROOT) return;\n        // 1) Si l'h√¥te fournit des tokens, on en h√©rite et on ne force rien\n        var csRoot = getComputedStyle(ROOT);\n        var hasHostTokens = ['--text','--muted','--panel','--border'].some(function(t){\n          return (csRoot.getPropertyValue(t)||'').trim();\n        });\n        if(hasHostTokens && !ROOT.getAttribute('data-force-skin')){\n          ROOT.setAttribute('data-skin','host');\n          return;\n        }\n\n        // 2) Palettes de secours clair/sombre\n        var light = {'--text':'#0f172a','--muted':'#475569','--bg':'transparent','--panel':'var(--card-bg, transparent)','--border':'rgba(15,23,42,0.08)','--accent':'#22c55e','--accent2':'#2563eb','--barLeft':'#e2e8f0'};\n        var dark  = {'--text':'#e5e7eb','--muted':'#94a3b8','--bg':'transparent','--panel':'var(--card-bg, rgba(15,23,42,.9))','--border':'#1f2937','--accent':'#22c55e','--accent2':'#3b82f6','--barLeft':'#334155'};\n\n        var forced = ROOT.getAttribute('data-force-skin');\n        if(forced==='light' || forced==='dark'){\n          var pf = forced==='light'? light : dark;\n          for(var fk in pf){ ROOT.style.setProperty(fk, pf[fk]); }\n          ROOT.setAttribute('data-skin', forced);\n          return;\n        }\n\n        // 3) D√©tection auto sur <body>\n        var csBody = getComputedStyle(document.body);\n        var bg = csBody.backgroundColor||'';\n        var textCol = csBody.color||'';\n        function _parseRGB(str){ try{ var inside=(str||'').split('(')[1]; if(!inside) return [15,23,42]; inside=inside.split(')')[0]; var p=inside.split(','); return [parseInt(p[0],10)||15, parseInt(p[1],10)||23, parseInt(p[2],10)||42]; }catch(e){ return [15,23,42]; } }\n        function _lum(r,g,b){ r/=255; g/=255; b/=255; var a=[r,g,b].map(function(v){ return v<=0.03928? v/12.92 : Math.pow((v+0.055)/1.055,2.4); }); return 0.2126*a[0]+0.7152*a[1]+0.0722*a[2]; }\n        var rgb=_parseRGB(bg); var L=_lum(rgb[0],rgb[1],rgb[2]);\n        var pal = (L>0.6)? light : dark;\n        var bgStr=(bg+'').toLowerCase();\n        var isTrans = bgStr.indexOf('transparent')>-1 || (bgStr.indexOf('rgba')>-1 && bgStr.trim().endsWith(', 0)'));\n        if(isTrans || !bg){ var tr=_parseRGB(textCol); var Lt=_lum(tr[0],tr[1],tr[2]); pal = (Lt<0.5)? light : dark; }\n\n        for(var k in pal){ ROOT.style.setProperty(k, pal[k]); }\n        ROOT.setAttribute('data-skin', pal===light?'light':'dark');\n      }catch(e){}\n    }\n    applyAutoSkin();\n    try{ var mql=window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)'); if(mql&&mql.addEventListener){ mql.addEventListener('change', function(){ applyAutoSkin(); }); } }catch(e){}\n    try{ var mo=new MutationObserver(function(){ applyAutoSkin(); }); mo.observe(document.body,{attributes:true,attributeFilter:['class','style']}); }catch(e){}\n\n    function euro(n){ return Number(n||0).toLocaleString('fr-FR',{style:'currency',currency:'EUR'}); }\n\n    // --- Donn√©es des 10 cas (Famille x5, Senior x5) ---\n    var CASES = [\n      {id:'F1', cible:'Famille', titre:'Enfant ‚Äì br√ªlure eau bouillante', emoji:'üî•', type:['Br√ªlure','Enfant'], resume:'Br√ªlures 2e degr√© profond, greffe, cicatrices.', sans:{resteMedical:0, pertesRevenus:0, annexes:500}, gav:{ip:{taux:8, montant:29440}, souff:6500, esth:6500, hospiJ:14, hospi:700, pertesRevenus:0, prothese:0, logement:0, fauteuil:0, autres:0}, tags:['H√¥pital 14 j','Cicatrices importantes']},\n      {id:'F2', cible:'Famille', titre:'Parent ‚Äì chute d‚Äô√©chelle (bricolage)', emoji:'ü™ú', type:['Chute','Adulte'], resume:'Fracture lombaire + jambe, s√©quelles dos, arr√™t 6 mois.', sans:{resteMedical:0, pertesRevenus:4000, annexes:0}, gav:{ip:{taux:20, montant:73600}, souff:6500, esth:0, hospiJ:10, hospi:500, pertesRevenus:4000, prothese:0, logement:0, fauteuil:0, autres:0}, tags:['R√©√©duc','Arr√™t 6 mois']},\n      {id:'F3', cible:'Famille', titre:'Ado ‚Äì rupture LCA (sport √† risque)', emoji:'ü•ä', type:['Sport','Ado'], resume:'Chirurgie + r√©√©duc; ann√©e scolaire perdue.', sans:{resteMedical:0, pertesRevenus:0, annexes:920}, gav:{ip:{taux:8, montant:29440}, souff:4000, esth:0, hospiJ:4, hospi:200, pertesRevenus:0, prothese:0, logement:0, fauteuil:0, autres:920}, tags:['Perte ann√©e scolaire','Hospi 4 j']},\n      {id:'F4', cible:'Famille', titre:'Trottinette √©lectrique ‚Äì 4 incisives cass√©es', emoji:'üõ¥', type:['EDP','Dentaire'], resume:'Couronnes dentaires co√ªteuses.', sans:{resteMedical:0, pertesRevenus:0, annexes:1970}, gav:{ip:{taux:6, montant:22080}, souff:2000, esth:0, hospiJ:0, hospi:0, pertesRevenus:0, prothese:1970, logement:0, fauteuil:0, autres:0}, tags:['Proth√®se dentaire','EDP motoris√©']},\n      {id:'F5', cible:'Famille', titre:'Parent ‚Äì section tendon (cuisine)', emoji:'üî™', type:['Coupure','Adulte'], resume:'Chirurgie main, perte de force, arr√™t 2 mois.', sans:{resteMedical:0, pertesRevenus:1500, annexes:0}, gav:{ip:{taux:7, montant:25760}, souff:5000, esth:0, hospiJ:3, hospi:150, pertesRevenus:1500, prothese:0, logement:0, fauteuil:0, autres:0}, tags:['Main dominante','R√©√©duc']},\n      {id:'S1', cible:'Senior', titre:'75 ans ‚Äì fracture col f√©mur', emoji:'ü¶¥', type:['Chute','Hanche'], resume:'Proth√®se, boiterie, adaptation douche.', sans:{resteMedical:0, pertesRevenus:0, annexes:1500}, gav:{ip:{taux:10, montant:27600}, souff:4000, esth:1000, hospiJ:21, hospi:1050, pertesRevenus:0, prothese:0, logement:500, fauteuil:0, autres:0}, tags:['R√©√©duc','Am√©nagement logt']},\n      {id:'S2', cible:'Senior', titre:'72 ans ‚Äì polytrauma + aide humaine', emoji:'‚ôø', type:['Chute','Polytrauma'], resume:'Parapl√©gie incompl√®te, fauteuil, gros travaux.', sans:{resteMedical:0, pertesRevenus:0, annexes:35000}, gav:{ip:{taux:70, montant:637875, bonus:'tierce personne +50%'}, souff:31000, esth:0, hospiJ:35, hospi:1500, pertesRevenus:0, prothese:5000, logement:30000, fauteuil:0, autres:0}, tags:['Tierce personne','Gros travaux','Plafonds √©lev√©s']},\n      {id:'S3', cible:'Senior', titre:'70 ans ‚Äì fracture hum√©rus', emoji:'üí™', type:['Chute','Bras'], resume:'Chirurgie, mobilit√© r√©duite.', sans:{resteMedical:0, pertesRevenus:0, annexes:0}, gav:{ip:{taux:8, montant:29440}, souff:4000, esth:0, hospiJ:5, hospi:250, pertesRevenus:0, prothese:0, logement:0, fauteuil:0, autres:0}, tags:['Hospi 5 j']},\n      {id:'S4', cible:'Senior', titre:'80 ans ‚Äì chute, √©dentation (proth√®se)', emoji:'ü¶∑', type:['Chute','Dentaire'], resume:'Proth√®ses dentaires on√©reuses.', sans:{resteMedical:0, pertesRevenus:0, annexes:1500}, gav:{ip:{taux:5, montant:9200}, souff:2000, esth:0, hospiJ:0, hospi:0, pertesRevenus:0, prothese:1500, logement:0, fauteuil:0, autres:0}, tags:['Proth√®se dentaire']},\n      {id:'S5', cible:'Senior', titre:'68 ans ‚Äì agression, fracture orbitaire', emoji:'üö®', type:['Agression','Visage'], resume:'Cicatrice faciale, s√©quelles esth√©tiques.', sans:{resteMedical:0, pertesRevenus:0, annexes:0}, gav:{ip:{taux:6, montant:22080}, souff:10000, esth:12500, hospiJ:4, hospi:200, pertesRevenus:0, prothese:0, logement:0, fauteuil:0, autres:0}, tags:['Pr√©judice esth√©tique','Hospi 4 j']}\n    ];\n\n    // --- S√©lecteurs DOM ---\n    var els = {\n      grid: document.getElementById('gav-grid'),\n      empty: document.getElementById('gav-empty'),\n      cible: document.getElementById('gav-cible'),\n      type: document.getElementById('gav-type'),\n      produit: document.getElementById('gav-produit'),\n      search: document.getElementById('gav-search')\n    };\n    dbg('Refs DOM ok: '+Object.keys(els).map(function(k){return k+':'+(!!els[k]);}).join(', '));\n\n    var required = ['grid','empty','cible','type','produit','search'];\n    for(var i=0;i<required.length;i++){ var k=required[i]; if(!els[k]){ console.error('[PriseGAV] √âl√©ment manquant:', k); dbg('√âl√©ment manquant: '+k); } }\n\n    if(els.produit){ els.produit.value='GAV'; dbg('Produit forc√©: '+els.produit.value); }\n    if(els.cible) els.cible.value='TOUS';\n    if(els.type) els.type.value='TOUS';\n\n    // Remplit le filtre Type dynamiquement (unique)\n    try{\n      var typeSet = {};\n      for(i=0;i<CASES.length;i++){ var tarr=CASES[i].type||[]; for(var j=0;j<tarr.length;j++){ typeSet[tarr[j]] = true; } }\n      var ALL_TYPES = Object.keys(typeSet);\n      if(els.type && els.type.options.length <= 1){\n        for(i=0;i<ALL_TYPES.length;i++){ var o=document.createElement('option'); o.value=ALL_TYPES[i]; o.textContent=ALL_TYPES[i]; els.type.appendChild(o); }\n        dbg('Types inject√©s: '+ALL_TYPES.join(', '));\n      }\n    }catch(e){ console.warn('[PriseGAV] type options', e); dbg('Type options error: '+(e && e.message? e.message : e)); }\n\n    function filtered(){\n      var cible = (els.cible && els.cible.value) ? els.cible.value : 'TOUS';\n      var type = (els.type && els.type.value) ? els.type.value : 'TOUS';\n      var q = (els.search && els.search.value ? els.search.value : '').trim().toLowerCase();\n      return CASES.filter(function(c){\n        if(cible!=='TOUS' && c.cible!==cible) return false;\n        if(type!=='TOUS' && !(c.type||[]).includes(type)) return false;\n        if(q){\n          var hay = [c.id,c.titre,c.resume,c.cible].concat(c.tags||[]).concat(c.type||[]).join(' ').toLowerCase();\n          if(hay.indexOf(q) === -1) return false;\n        }\n        return true;\n      });\n    }\n\n    function computeBars(c){\n      var sansTotal = (c.sans.resteMedical||0)+(c.sans.pertesRevenus||0)+(c.sans.annexes||0);\n      var g=c.gav||{}; var gavTotal = (g.ip&&g.ip.montant||0)+(g.souff||0)+(g.esth||0)+(g.hospi||0)+(g.pertesRevenus||0)+(g.prothese||0)+(g.logement||0)+(g.fauteuil||0)+(g.autres||0);\n      var max = Math.max(1, sansTotal, gavTotal);\n      var leftW = Math.round((sansTotal/max)*100);\n      var rightW = Math.round((gavTotal/max)*100);\n      return {sansTotal:sansTotal, gavTotal:gavTotal, leftW:leftW, rightW:rightW};\n    }\n\n    function fmtBreakdown(g){\n      var parts=[];\n      if(g.ip) parts.push('IP '+g.ip.taux+'%: '+euro(g.ip.montant)+(g.ip.bonus?(' ('+g.ip.bonus+')'):''));\n      if(g.souff) parts.push('Souffrances: '+euro(g.souff));\n      if(g.esth) parts.push('Esth√©tique: '+euro(g.esth));\n      if(g.pertesRevenus) parts.push('Pertes de revenus: '+euro(g.pertesRevenus));\n      if(g.hospi) parts.push('Hospi ('+(g.hospiJ||'?')+' j): '+euro(g.hospi));\n      if(g.prothese || g.fauteuil) parts.push('Proth√®se/fauteuil: '+euro((g.prothese||0)+(g.fauteuil||0)));\n      if(g.logement) parts.push('Logement adapt√©: '+euro(g.logement));\n      if(g.autres) parts.push('Autres: '+euro(g.autres));\n      return parts.join(' ‚Ä¢ ');\n    }\n\n    function pitch(c){\n      var sums = computeBars(c);\n      return '\"'+c.titre+'\" ('+c.cible+') ‚Äî Sans GAV: '+euro(sums.sansTotal)+' √† supporter. Avec GAV: indemnisation ~ '+euro(sums.gavTotal)+' (dont '+fmtBreakdown(c.gav)+').';\n    }\n\n    function mk(tag, cls, text){ var el=document.createElement(tag); if(cls) el.className=cls; if(text!=null) el.textContent=text; return el; }\n\n    function card(c){\n      var sums = computeBars(c);\n      var article = mk('article','gav-card'); article.setAttribute('role','listitem');\n\n      // Head\n      var head = mk('div','gav-card-head');\n      var left = mk('div','');\n      var title = mk('div','gav-card-title', (c.emoji?c.emoji+' ':'')+c.titre);\n      left.appendChild(title);\n      var tags = mk('div','gav-tags');\n      var chipCible = mk('span','gav-chip', c.cible); tags.appendChild(chipCible);\n      var types = c.type||[]; for(var i=0;i<types.length;i++){ tags.appendChild(mk('span','gav-chip', types[i])); }\n      left.appendChild(tags);\n      var right = mk('div',''); right.style.textAlign='right';\n      right.appendChild(mk('div','gav-money', euro(sums.gavTotal)));\n      right.appendChild(mk('div','gav-muted','Indemnisation GAV estim√©e'));\n      head.appendChild(left); head.appendChild(right);\n      article.appendChild(head);\n\n      // Resume\n      var resume = mk('div','gav-muted', c.resume); resume.style.marginTop='6px'; article.appendChild(resume);\n\n      // Compare bar\n      var compare = mk('div','gav-compare');\n      var bar = mk('div','gav-bar');\n      var leftBar = mk('div','left'); leftBar.style.width = String(sums.leftW)+'%';\n      var rightBar = mk('div','right'); rightBar.style.width = String(sums.rightW)+'%';\n      bar.appendChild(leftBar); bar.appendChild(rightBar);\n      compare.appendChild(bar);\n      var figs = mk('div','gav-figures');\n      var f1 = mk('div',null,'Sans GAV : '); var strong1 = mk('strong',null,euro(sums.sansTotal)); f1.appendChild(strong1);\n      var f2 = mk('div',null,'Avec GAV : '); var strong2 = mk('strong',null,euro(sums.gavTotal)); f2.appendChild(strong2);\n      figs.appendChild(f1); figs.appendChild(f2);\n      compare.appendChild(figs);\n      article.appendChild(compare);\n\n      // Actions\n      var actions = mk('div','gav-actions');\n      var btnDet = mk('button','gav-btn','Voir le d√©tail'); btnDet.setAttribute('data-act','details');\n      var btnCopy = mk('button','gav-btn sec','Copier l‚Äôargumentaire'); btnCopy.setAttribute('data-act','copy');\n      var btnExp = mk('button','gav-btn sec','Plus d‚Äôexplications'); btnExp.setAttribute('data-act','explain'); btnExp.setAttribute('aria-expanded','false');\n      actions.appendChild(btnDet); actions.appendChild(btnCopy); actions.appendChild(btnExp);\n      article.appendChild(actions);\n\n      // Details\n      var details = mk('div','gav-details');\n      var sansLine = mk('div',null,'');\n      var sansBadge = mk('span','gav-badge','üßæ Sans GAV'); sansLine.appendChild(sansBadge);\n      sansLine.appendChild(document.createTextNode(' Reste m√©dical : '));\n      var s1 = mk('strong',null,euro(c.sans.resteMedical||0)); sansLine.appendChild(s1);\n      sansLine.appendChild(document.createTextNode(' ‚Ä¢ Pertes de revenus : '));\n      var s2 = mk('strong',null,euro(c.sans.pertesRevenus||0)); sansLine.appendChild(s2);\n      sansLine.appendChild(document.createTextNode(' ‚Ä¢ Annexes : '));\n      var s3 = mk('strong',null,euro(c.sans.annexes||0)); sansLine.appendChild(s3);\n      sansLine.appendChild(document.createTextNode(' ‚Üí Total: '));\n      var sTot = mk('strong',null,euro(sums.sansTotal)); sansLine.appendChild(sTot);\n      details.appendChild(sansLine);\n\n      var gavLine = mk('div',null,'');\n      var gavBadge = mk('span','gav-badge','üí∂ Avec GAV'); gavLine.appendChild(gavBadge);\n      gavLine.appendChild(document.createTextNode(' '+fmtBreakdown(c.gav)+' ‚Üí '));\n      var gTot = mk('strong',null,euro(sums.gavTotal)); gavLine.appendChild(gTot);\n      details.appendChild(gavLine);\n\n      if(c.tags && c.tags.length){\n        var tagsWrap = mk('div','gav-tags'); tagsWrap.style.marginTop = '8px';\n        for(i=0;i<c.tags.length;i++){ tagsWrap.appendChild(mk('span','gav-chip', c.tags[i])); }\n        details.appendChild(tagsWrap);\n      }\n\n      // Bloc p√©dagogique\n      var explain = mk('div','gav-explain');\n      var h4 = mk('h4',null,'Explication des prises en charge');\n      explain.appendChild(h4);\n      var ul = mk('ul',null,'');\n      var bullets = [\n        'S√©curit√© sociale (AMO) : rembourse selon des tarifs de responsabilit√© (ex. hospitalisation 80 % du tarif ; le forfait journalier est souvent pris en charge par la mutuelle).',\n        'Mutuelle ¬´ classique ¬ª 100 % BR : compl√®te le ticket mod√©rateur mais ne couvre pas les d√©passements d‚Äôhonoraires, implants/couronnes haut de gamme, am√©nagement du logement, perte de revenus, ni les pr√©judices extra-patrimoniaux.',\n        'La GAV indemnise les cons√©quences de l‚Äôaccident : Incapacit√© Permanente (AIPP) via bar√®me, souffrances endur√©es, pr√©judice esth√©tique, aide humaine, am√©nagements, appareillages, pertes de revenus r√©siduelles, etc.'\n      ];\n      for(i=0;i<bullets.length;i++){ var li=mk('li',null,bullets[i]); ul.appendChild(li); }\n      explain.appendChild(ul);\n\n      var h4b = mk('h4',null,'Qui paie quoi ?');\n      explain.appendChild(h4b);\n      var tbl = mk('div','gav-table');\n      var headers = ['Poste','AMO','Mutuelle','GAV']; for(i=0;i<headers.length;i++){ var d=mk('div','th',headers[i]); tbl.appendChild(d); }\n      var rows = [\n        ['Soins / hospitalisation','‚úì','‚úì','‚àº'],\n        ['D√©passements / dentaire on√©reux','‚úó','‚àº','‚úì'],\n        ['Pertes de revenus','‚àº','‚úó','‚úì'],\n        ['Incapacit√© Permanente (AIPP)','‚úó','‚úó','‚úì'],\n        ['Souffrances endur√©es','‚úó','‚úó','‚úì'],\n        ['Pr√©judice esth√©tique','‚úó','‚úó','‚úì'],\n        ['Aide humaine / Tierce personne','‚úó','‚úó','‚úì'],\n        ['Am√©nagement logement/v√©hicule','‚úó','‚úó','‚úì'],\n        ['Appareils sp√©ciaux / fauteuil','‚úó','‚úó','‚úì']\n      ];\n      for(i=0;i<rows.length;i++){ for(var j=0;j<rows[i].length;j++){ var cell = mk('div', j===0? 'muted' : '', rows[i][j]); tbl.appendChild(cell); } }\n      explain.appendChild(tbl);\n      var legend = mk('div','gav-legend','‚úì couvert ‚Ä¢ ‚àº partiel/selon contrat ‚Ä¢ ‚úó non couvert'); explain.appendChild(legend);\n\n      var h4c = mk('h4',null,'Comment est calcul√©e l‚ÄôIP ?'); explain.appendChild(h4c);\n      var pcalc = mk('div','gav-muted','Exemple indicatif : Montant = Valeur du point √ó taux AIPP (ajust√© selon l‚Äô√¢ge ; + majoration si tierce personne). Ex. 3‚ÄØ680 ‚Ç¨ / point ; abattement au-del√† de 70 ans ; +50 % si aide humaine durable.'); explain.appendChild(pcalc);\n\n      details.appendChild(explain);\n      article.appendChild(details);\n\n      // Panneau de copie (fallback si Clipboard API bloqu√©e)\n      var copyPanel = mk('div','gav-copypanel');\n      var ch = mk('h4',null,'Argumentaire √† copier'); copyPanel.appendChild(ch);\n      var ta = document.createElement('textarea'); ta.className = 'gav-copytextarea'; ta.setAttribute('readonly','readonly'); copyPanel.appendChild(ta);\n      var cpAct = mk('div','gav-copyactions');\n      var bSel = mk('button','gav-btn sec','S√©lectionner le texte');\n      var bClose = mk('button','gav-btn sec','Fermer');\n      cpAct.appendChild(bSel); cpAct.appendChild(bClose);\n      copyPanel.appendChild(cpAct);\n      article.appendChild(copyPanel);\n\n      bSel.addEventListener('click', function(){ try{ ta.focus(); ta.select(); }catch(e){} });\n      bClose.addEventListener('click', function(){ copyPanel.style.display = 'none'; });\n\n      // Bouton d‚Äôexplication (toggle) ‚Äî force l‚Äôouverture des d√©tails si n√©cessaire\n      btnExp.addEventListener('click', function(){\n        if(details.style.display !== 'block'){ details.style.display = 'block'; }\n        var open = (explain.style.display === 'block');\n        explain.style.display = open ? 'none' : 'block';\n        btnExp.setAttribute('aria-expanded', open ? 'false' : 'true');\n        if(!open){ try{ explain.scrollIntoView({behavior:'smooth', block:'nearest'}); }catch(e){} }\n      });\n\n      // Events\n      btnDet.addEventListener('click', function(){\n        var isOpen = (details.style.display === 'block');\n        details.style.display = isOpen ? 'none' : 'block';\n        if(isOpen){ explain.style.display = 'none'; btnExp.setAttribute('aria-expanded','false'); }\n      });\n\n      btnCopy.addEventListener('click', function(){\n        var text = pitch(c);\n        var ok = false;\n        if(window.isSecureContext && navigator && navigator.clipboard && navigator.clipboard.writeText){\n          navigator.clipboard.writeText(text).then(function(){ ok = true; }).catch(function(){}).finally(function(){\n            if(ok){\n              try{ var t = mk('div','gav-toast','‚úÖ Argumentaire copi√©'); document.body.appendChild(t); setTimeout(function(){ t.remove(); },1200);}catch(e){}\n            }else{\n              ta.value = text; copyPanel.style.display = 'block'; try{ ta.focus(); ta.select(); }catch(e){}\n            }\n          });\n        } else {\n          ta.value = text; copyPanel.style.display = 'block'; try{ ta.focus(); ta.select(); }catch(e){}\n        }\n      });\n\n      return article;\n    }\n\n    function render(){\n      if(els.produit && els.produit.value!=='GAV'){ els.produit.value='GAV'; dbg('Produit r√©tabli √† GAV'); }\n      if(!els.grid || !els.empty){ dbg('Conteneurs manquants, abort render'); return; }\n      var list = filtered();\n      dbg('Render: '+list.length+' carte(s)');\n      els.grid.innerHTML='';\n      if(!list.length){ els.empty.style.display='block'; els.empty.textContent='Aucun cas ne correspond √† vos filtres.'; return; }\n      els.empty.style.display='none';\n      for(var i=0;i<list.length;i++){ els.grid.appendChild(card(list[i])); }\n    }\n\n    function safeRender(){ try{ render(); } catch(e){ console.error('[PriseGAV] Erreur de rendu', e); dbg('Erreur de rendu: '+(e&&e.message?e.message:e)); if(els.grid){ els.grid.innerHTML = '<div class=\"gav-empty\">Erreur d\\'initialisation du module : '+(e&&e.message?e.message:e)+'</div>'; } if(els.empty){ els.empty.style.display='none'; } } }\n\n    // Listeners\n    if(els.cible) els.cible.addEventListener('change', safeRender);\n    if(els.type) els.type.addEventListener('change', safeRender);\n    if(els.produit) els.produit.addEventListener('change', function(){ safeRender(); });\n    if(els.search) els.search.addEventListener('input', function(){ clearTimeout(window.__gavT); window.__gavT = setTimeout(safeRender, 120); });\n\n    // API onglet\n    window.PriseGAV = {\n      show: function(){ var sec = document.getElementById('tab-prise-gav'); if(sec) sec.style.display = 'block'; if(els && els.produit) els.produit.value = 'GAV'; dbg('show() appel√©'); safeRender(); },\n      hide: function(){ var sec = document.getElementById('tab-prise-gav'); if(sec) sec.style.display = 'none'; },\n      force: function(){ dbg('force()'); safeRender(); }\n    };\n\n    // Premier rendu\n    safeRender();\n  })();";
    root.appendChild(s);
  } catch(e) {
    console.error('[GAV] √âchec injection du script:', e);
    var dbg = document.createElement('div');
    dbg.className = 'debug';
    dbg.textContent = 'Erreur d\'initialisation du module GAV: ' + (e && e.message ? e.message : e);
    root.appendChild(dbg);
  }
  try { if (window.PriseGAV && typeof window.PriseGAV.force === 'function') window.PriseGAV.force(); } catch(e){}
}

/* ===== Tabs bootstrap ===== */

document.querySelectorAll('.tab').forEach(t => {
  t.addEventListener('click', () => {
    const id = t.dataset.tab;
    document.querySelectorAll('.tab').forEach(x => x.classList.toggle('active', x === t));
    document.querySelectorAll('.panel').forEach(p => p.classList.toggle('active', p.id === id));
    if(id==='prev' && !document.getElementById('prev').dataset.ready){ buildPrevPanel(); document.getElementById('prev').dataset.ready='1'; }
    if(id==='calc' && !document.getElementById('calc').dataset.ready){ buildCalcPanel(); document.getElementById('calc').dataset.ready='1'; }
    if(id==='global' && !document.getElementById('global').dataset.ready){ buildGlobalPanel(); document.getElementById('global').dataset.ready='1'; }
    if(id==='plan' && !document.getElementById('plan').dataset.ready){ buildPlanPanel(); document.getElementById('plan').dataset.ready='1'; }

    if(id==='av' && !document.getElementById('av').dataset.ready){ buildAVPanel(); document.getElementById('av').dataset.ready='1'; }
    if(id==='per' && !document.getElementById('per').dataset.ready){ buildPERPanel(); document.getElementById('per').dataset.ready='1'; }
    if(id==='library' && !document.getElementById('library').dataset.ready){ buildLibraryPanel(); document.getElementById('library').dataset.ready='1'; }
    if(id==='gav' && !document.getElementById('gav').dataset.ready){ buildGAVPanel(); document.getElementById('gav').dataset.ready='1'; }

          });
});

// Default: build Pr√©voyance
buildPrevPanel(); document.getElementById('prev').dataset.ready='1';

  function nowISO(){ const d=new Date(); const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }
  function load(){ try{ const j=localStorage.getItem(k()); return j? JSON.parse(j):[]; }catch(e){ return []; } }
  function save(arr){ localStorage.setItem(k(), JSON.stringify(arr)); }

  function rowHtml(o, idx){
    return `<tr data-i="${idx}">
      <td><input value="${o.name||''}" class="i-name" /></td>
      <td>
        <select class="i-prod">
          ${['Sant√©','GAV','D√©c√®s','PER','AV','Autre'].map(v=>`<option ${o.product===v?'selected':''}>${v}</option>`).join('')}
        </select>
      </td>
      <td><input type="number" step="1" min="0" class="i-amount" value="${Math.round(o.amount||0)}" /></td>
      <td><input type="number" min="0" max="100" step="1" class="i-prob" value="${Math.round(o.prob||0)}" /></td>
      <td><input type="date" class="i-next" value="${o.next||''}" /></td>
      <td>
        <select class="i-stat">
        ${['√Ä contacter','En cours','Devis envoy√©','√Ä rappeler','Gagn√©','Perdu'].map(v=>`<option ${o.status===v?'selected':''}>${v}</option>`).join('')}
        </select>
      </td>
      <td>
        <button class="btn btn-ghost up">‚ñ≤</button>
        <button class="btn btn-ghost down">‚ñº</button>
        <button class="btn btn-danger del">Suppr</button>
      </td>
    </tr>`;
  }

  /* ===== Biblioth√®que d'argumentaires (PDF int√©gr√© + CRUD) ===== */
function buildLibraryPanel(){
  const root = document.getElementById('library');
  if(!root) return;
  root.innerHTML = `
    <div class="grid">
      <section class="card" style="grid-column: span 12">
        <h3 class="section-title">Argumentaires & Objections ‚Äî Biblioth√®que int√©gr√©e</h3>
        <div class="row" style="flex-wrap:wrap; gap:8px">
          <input class="q" placeholder="Rechercher (mot-cl√©: objection, r√©ponse, punchline‚Ä¶)" style="min-width:320px" />
          <select class="prod"></select>
          <select class="sit"></select>
          <button class="btn btn-ghost add">Ajouter une carte</button>
          <button class="btn btn-ghost import">Importer JSON</button>
          <button class="btn btn-ghost export">Exporter JSON</button>
          <button class="btn btn-danger reset">R√©initialiser (cartes PDF)</button>
        </div>
        <div class="hr"></div>
        <div class="cards" style="display:grid; grid-template-columns: repeat(auto-fill,minmax(320px,1fr)); gap:12px;"></div>
      </section>
    </div>`;

  const DATA_FROM_PDF = [{"product": "Sant√©", "situation": "Famille", "objection": "C'est trop cher , j'ai d√©j√† trop de d√©penses pour la famille.", "response": "Je comprends que le budget soit une contrainte. Justement, nos formules Sant√© sont modulables : vous pouvez choisir un niveau de garantie adapt√© pour contr√¥ler le co√ªt tout en couvrant l'essentiel. Mieux vaut une petite cotisation ma√Ætris√©e que de faire face √† une grosse d√©pense impr√©vue en cas de souci de sant√©.", "punchline": "Mieux vaut investir un peu dans sa sant√© que de risquer beaucoup √† la n√©gliger .", "value": "Couverture personnalisable selon le budget; remboursements √©lev√©s sur les postes co√ªteux (hospitalisation, dentaire, optique); √©vite les restes √† charge importants pour la famille."}, {"product": "Sant√©", "situation": "Famille", "objection": "On est jeunes et en bonne sant√©, on n'a pas vraiment besoin d'une mutuelle renforc√©e.", "response": "Tant mieux si vous √™tes en bonne sant√© ! Mais personne n'est √† l'abri d'un accident ou d'un impr√©vu m√©dical, surtout avec des enfants. Souscrire quand tout va bien permet d'obtenir un bon tarif et d'√™tre serein : si quelque chose arrive, vous aurez les meilleurs soins sans vous soucier du co√ªt.", "punchline": "La sant√© n'attend pas que les probl√®mes arrivent pour √™tre prot√©g√©e.", "value": "Tarifs avantageux pour jeunes assur√©s; prise en charge des impr√©vus (urgences, fractures, analyses co√ªteuses); tranquillit√© d'esprit pour toute la famille en cas de p√©pin."}, {"product": "Sant√©", "situation": "Famille", "objection": "La S√©cu et ma mutuelle d'entreprise de base suffisent, je n'ai pas besoin de garanties suppl√©mentaires.", "response": "Votre couverture actuelle prot√®ge le minimum. Cependant, de nombreux soins courants (lunettes, proth√®ses dentaires, sp√©cialistes hors convention) restent mal rembours√©s. Avec notre compl√©mentaire Sant√©, vous comblez ces lacunes et √©vitez de payer de votre poche. C'est l'assurance d'un meilleur confort de soins pour vous et votre famille.", "punchline": "Ne laissez pas un budget serr√© dicter la qualit√© de vos soins.", "value": "Compl√©ment de remboursement sur les postes mal pris en charge par les r√©gimes de base; acc√®s √† un r√©seau de partenaires sant√© √† tarifs n√©goci√©s; meilleur confort financier m√™me pour les soins on√©reux."}, {"product": "Sant√©", "situation": "Famille", "objection": "Je pr√©f√®re payer moi-m√™me les petites d√©penses et j'esp√®re ne jamais avoir de gros probl√®me de sant√©.\"1. 2. 3. 4. 1", "response": "Payer les petites d√©penses, c'est faisable, mais un seul gros probl√®me de sant√© peut co√ªter des milliers d'euros. L'assurance sant√© vous √©vite d'entamer vos √©conomies en cas de coup dur . C'est comme un parapluie : quand la temp√™te arrive, vous √™tes content de l'avoir , m√™me si vous ne l'utilisez pas tous les jours.", "punchline": "", "value": ""}, {"product": "Sant√©", "situation": "Famille", "objection": "Les assurances sant√© ne remboursent jamais aussi bien qu'elles le promettent, et c'est compliqu√© de se faire rembourser .", "response": "Notre assurance sant√© est au contraire tr√®s transparente. Nous remboursons jusqu'√† 100 % ou 200 % des tarifs de la S√©curit√© sociale sur de nombreux soins, et le tiers payant √©vite m√™me d'avancer les frais chez de nombreux professionnels. De plus, nous simplifions les d√©marches : tout peut se faire en ligne ou par appli, et vous √™tes rembours√© en quelques jours.", "punchline": "Simplifiez-vous la sant√© : on s'occupe de tout, sauf de votre place chez le m√©decin !", "value": "Remboursements clairs et √©lev√©s (y compris en optique/dentaire); tiers payant g√©n√©ralis√© pour √©viter l'avance de frais; gestion 100 % digitale et rapide des demandes."}, {"product": "Sant√©", "situation": "S√©nior", "objection": "√Ä mon √¢ge, une bonne mutuelle co√ªte trop cher de toute fa√ßon.", "response": "Les besoins de sant√© augmentent avec l'√¢ge, et nos offres Seniors en tiennent compte avec un tarif ajust√©. Pensez au co√ªt d'un appareil auditif ou de soins √† domicile : sans mutuelle, c'est un reste √† charge √©norme. Nous proposons des garanties cibl√©es sur vos besoins r√©els (hospitalisation, optique, audioproth√®ses) pour un tarif optimis√©. C'est un investissement pour votre qualit√© de vie.", "punchline": "Votre sant√© n'a pas de prix, et pourtant elle peut √™tre bien assur√©e.", "value": "Formules d√©di√©es aux seniors (soins courants et hospitaliers renforc√©s); prise en charge des √©quipements co√ªteux (audition, dentaire, etc.); maintien du niveau de sant√© sans sacrifier son budget retraite."}, {"product": "Sant√©", "situation": "S√©nior", "objection": "J'ai d√©j√† une mutuelle depuis des ann√©es, je pr√©f√®re ne pas changer pour √©viter les probl√®mes de carence ou de paperasse.", "response": "Rassurez-vous, en changeant de mutuelle vous conservez vos droits sans interruption si vous encha√Ænez les contrats. Nous nous occupons de toutes les d√©marches de r√©siliation pour vous. L'int√©r√™t de changer , c'est souvent de b√©n√©ficier de meilleures garanties ou d'un tarif plus avantageux adapt√© √† votre situation actuelle. Vous pourriez y gagner sur toute la ligne sans effort.", "punchline": "Changer pour mieux, sans tracas : on s'occupe de tout pour vous.", "value": "Pas de d√©lai de carence en reprenant vos garanties acquises; accompagnement personnalis√© pour la transition de contrat; souvent des garanties plus √©lev√©es ou cotisation r√©duite √† la cl√©."}, {"product": "Sant√©", "situation": "S√©nior5.", "objection": "Je n'ai pas de gros besoins m√©dicaux, juste le g√©n√©raliste et quelques m√©dicaments. La S√©cu suffit pour moi.", "response": "Aujourd'hui vous avez la chance de ne pas avoir de gros soucis. Mais avec l'√¢ge, un probl√®me peut vite survenir : par exemple, une chute n√©cessitant de la r√©√©ducation ou des lunettes hors de prix. La S√©cu rembourse mal ces frais. Avoir une mutuelle, c'est √™tre pr√™t √† faire face sans entamer vos √©conomies, pour continuer √† vous soigner correctement en toute circonstance.", "punchline": "En mati√®re de sant√©, mieux vaut pr√©venir aujourd'hui que payer le prix fort demain.", "value": "S√©curit√© financi√®re face aux al√©as de sant√© li√©s √† l'√¢ge; acc√®s sans restriction aux sp√©cialistes et meilleurs soins; pr√©servation du capital et de la qualit√© de vie."}, {"product": "Sant√©", "situation": "S√©nior", "objection": "Je pr√©f√®re garder mon argent pour moi que de le donner tous les mois √† une assurance.", "response": "Pensez-y comme √† une solidarit√© avec vous-m√™me : vous mettez un peu chaque mois pour √©viter de devoir sortir beaucoup d'un coup le jour o√π un probl√®me de sant√© arrivera. Sans mutuelle, une seule hospitalisation pourrait vous co√ªter bien plus que des ann√©es de cotisations. Avec notre assurance, vous transformez de grosses d√©penses impr√©visibles en un budget ma√Ætris√©.", "punchline": "Mieux vaut des petites cotisations r√©guli√®res qu'une facture ing√©rable sortie de nulle part.", "value": "Stabilisation du budget sant√© (plus de mauvaises surprises); acc√®s aux meilleurs traitements sans arbitrer selon le co√ªt; protection de votre patrimoine contre les d√©penses m√©dicales lourdes."}, {"product": "Sant√©", "situation": "S√©nior", "objection": "Les paperasses de sant√© sont trop compliqu√©es pour moi, je ne saurai pas me faire rembourser .", "response": "Notre service client est l√† pour vous accompagner . Nous proposons m√™me de prendre en charge les formalit√©s administratives √† votre place : par exemple, le tiers payant signifie que vous n'avancez rien et nous r√©glons directement avec le professionnel de sant√©. Et si vous avez la moindre question, votre conseiller d√©di√© s'occupe de tout. Vous n'avez qu'√† vous soigner , on s'occupe du reste.", "punchline": "Profitez de vos soins, on g√®re les papiers !", "value": "Assistance administrative incluse (tiers payant, aide aux d√©marches); service client d√©di√© aux seniors; simplicit√© d'utilisation (relev√©s clairs, support t√©l√©phonique). GAV (Garantie Accidents de la Vie)"}, {"product": "Garantie Accidents de la Vie (GAV)", "situation": "Famille", "objection": "Je suis tr√®s prudent, je fais attention dans tout ce que je fais. Je ne vois pas l'int√©r√™t de payer pour √ßa.", "response": "Vous avez raison d'√™tre prudent, mais les accidents de la vie courante arrivent m√™me aux plus vigilants. Une mauvaise chute √† la maison ou un accident b√™te arrive sans pr√©venir . La GAV est l√† pour vous prot√©ger quand m√™me : elle pr√©voit une indemnisation importante si un accident grave survient, afin que votre vie continue le plus normalement possible financi√®rement.", "punchline": "On ne peut pas √©viter tous les accidents, mais on peut en √©viter les cons√©quences9. 10. 1. 3 financi√®res.", "value": "Protection 24h/24, tous lieux et pour toute la famille; indemnisation forfaitaire pouvant aller jusqu'√† plusieurs centaines de milliers d'euros en cas d'invalidit√©; aide financi√®re pour am√©nager votre quotidien apr√®s un accident."}, {"product": "Garantie Accidents de la Vie (GAV)", "situation": "Famille", "objection": "On est d√©j√† assur√©s pour tout : voiture, habitation‚Ä¶ une assurance accidents de la vie en plus, c'est trop.", "response": "En r√©alit√©, ni l'assurance auto ni l'assurance habitation ne vous couvrent pour les accidents de la vie courante. La GAV vient en compl√©ment : elle intervient pour les accidents domestiques, les accidents de loisirs, les situations du quotidien que les autres assurances n'indemnisent pas. C'est une protection en plus pour des risques bien r√©els que personne d'autre ne prend en charge.", "punchline": "Ne confondez pas tout risque et tous risques : la GAV couvre ce que les autres n'assurent pas.", "value": "Compl√©ment des assurances existantes (protection hors v√©hicule et travail); couverture des accidents domestiques, sportifs, de loisirs, etc.; garantie valable partout (√† la maison, en voyage, en vacances)."}, {"product": "Garantie Accidents de la Vie (GAV)", "situation": "Famille", "objection": "Franchement, les accidents graves, √ßa n'arrive qu'aux autres. Je ne veux pas payer pour un cas tr√®s improbable.", "response": "Personne ne s'attend √† √™tre victime d'un accident grave‚Ä¶ jusqu'au jour o√π √ßa arrive. Chaque ann√©e, des millions de personnes sont touch√©es par des accidents de la vie courante en France. La GAV co√ªte seulement quelques euros par mois, mais elle peut sauver votre situation financi√®re si l'improbable se produit. C'est une petite tranquillit√© d'esprit en plus, au cas o√π.", "punchline": "Un accident peut changer une vie en une seconde, mais une bonne assurance peut en att√©nuer les d√©g√¢ts.", "value": "Cotisation modeste au regard de la protection obtenue; tranquillit√© d'esprit face aux al√©as de la vie; soutien financier imm√©diat pour faire face aux cons√©quences (r√©√©ducation, incapacit√©, etc.)."}, {"product": "Garantie Accidents de la Vie (GAV)", "situation": "Famille", "objection": "Si je deviens invalide apr√®s un accident, la S√©curit√© sociale me versera une pension, non ?", "response": "La S√©curit√© sociale verse une pension d'invalidit√©, mais elle est souvent tr√®s partielle par rapport √† vos revenus, et elle ne couvre pas les frais d'am√©nagement ou l'aide √† domicile dont vous pourriez avoir besoin. La GAV, elle, vous verse un capital important en cas d'invalidit√© grave. Cet argent vous permettrait par exemple d'am√©nager votre logement pour rester autonome, ou de compenser la perte de revenus. C'est un vrai filet de s√©curit√© en plus de la pension.", "punchline": "Votre assurance sant√© vous soigne, la GAV vous aide √† reconstruire votre vie.", "value": "Versement d'un capital libre d'utilisation en cas d'invalidit√© (pas seulement des remboursements m√©dicaux); compensation de la perte de revenus et des frais non couverts; maintien de l'autonomie gr√¢ce √† un soutien financier adapt√©."}, {"product": "Garantie Accidents de la Vie (GAV)", "situation": "Famille2.", "objection": "Franchement, on n'a pas le budget pour encore une assurance. On a d'autres priorit√©s.", "response": "Je comprends que le budget familial soit serr√©. La bonne nouvelle, c'est que la GAV reste tr√®s abordable : pour le prix de deux caf√©s par mois, vous prot√©gez toute votre famille contre les gros coups durs. Et pensez aux cons√©quences financi√®res d'un accident grave : un parent qui ne peut plus travailler , des frais m√©dicaux longs‚Ä¶ Sans protection, l'impact financier serait bien pire que le co√ªt mensuel de la GAV.", "punchline": "", "value": ""}, {"product": "Garantie Accidents de la Vie (GAV)", "situation": "S√©nior", "objection": "√Ä mon √¢ge, si je me blesse gravement, assurance ou pas, je finirai en maison de retraite.", "response": "Pas forc√©ment. Si un accident vous arrive, disposer d'un capital gr√¢ce √† la GAV peut justement vous √©viter la maison de retraite. Par exemple, cet argent pourrait financer l'am√©nagement de votre domicile (rampe, lit m√©dicalis√©, aide √† domicile) pour que vous puissiez continuer √† vivre chez vous confortablement. Sans cette aide financi√®re, beaucoup de seniors n'ont pas le choix. La GAV vous donne les moyens de choisir .", "punchline": "Pr√©servez votre ind√©pendance, m√™me apr√®s un accident, gr√¢ce √† un coup de pouce financier .", "value": "Permet de financer des am√©nagements pour rester √† domicile; garantie de recevoir un capital rapidement pour faire face aux cons√©quences d'une perte d'autonomie; libert√© de choix sur l'utilisation des fonds (aide professionnelle, √©quipement, etc.)."}, {"product": "Garantie Accidents de la Vie (GAV)", "situation": "S√©nior", "objection": "Je ne fais plus rien de risqu√©, je passe la plupart de mon temps tranquillement √† la maison.", "response": "Beaucoup d'accidents graves arrivent √† la maison lors des activit√©s quotidiennes : une mauvaise chute dans l'escalier , un faux pas dans le jardin‚Ä¶ M√™me en √©tant prudent et casanier , le risque z√©ro n'existe pas. La GAV vous prot√®ge justement dans votre vie de tous les jours, √† la maison comme √† l'ext√©rieur . Ainsi, m√™me pendant vos activit√©s les plus tranquilles, vous savez que vous √™tes couvert en cas de coup dur .", "punchline": "M√™me chez soi, un accident est vite arriv√© : mieux vaut √™tre couvert dans son cocon.", "value": "Couverture valable m√™me pour les accidents domestiques courants (chutes, br√ªlures‚Ä¶); s'applique √† toutes vos activit√©s quotidiennes sans exclusion; prot√®ge les seniors souvent seuls √† domicile."}, {"product": "Garantie Accidents de la Vie (GAV)", "situation": "S√©nior", "objection": "Ma mutuelle sant√© et l'Assurance Maladie couvriront les frais si je me blesse, je n'ai pas besoin d'une GAV.", "response": "Votre mutuelle sant√© couvrira les soins, mais pas les cons√©quences durables d'un accident. Par exemple, si vous gardez des s√©quelles, que vous avez besoin d'une aide m√©nag√®re ou de fauteuils adapt√©s, ce n'est pas la mutuelle qui paiera, et la S√©curit√© sociale non plus. La GAV intervient l√† : elle vous verse une somme pour faire face √† ces d√©penses et maintenir votre qualit√© de vie. C'est le compl√©ment indispensable pour tout ce que la sant√© ne prend pas en6. 7. 8. 5 charge.", "punchline": "Soigner l'accident, c'est bien. En r√©parer les cons√©quences, c'est mieux.", "value": "Compl√®te la mutuelle en cas de s√©quelles physiques permanentes; aide au financement des services non m√©dicaux (aide √† domicile, √©quipements sp√©ciaux); √©vite de puiser dans ses √©conomies pour retrouver un confort de vie."}, {"product": "Garantie Accidents de la Vie (GAV)", "situation": "S√©nior", "objection": "Je vis seul et je n'ai plus de famille √† charge. √Ä quoi bon une assurance accidents ?", "response": "M√™me sans famille √† charge, pensez √† vous et √† votre propre confort. Si un accident vous handicape, qui paiera pour une aide quotidienne ou un bon fauteuil roulant ? La GAV vous aide, vous, directement. C'est une protection pour pr√©server votre dignit√© et votre autonomie, sans devoir compter sur d'√©ventuelles aides externes. Vous cotisez pour vous-m√™me, pour √™tre s√ªr que quoiqu'il arrive, vous pourrez faire face.", "punchline": "Votre avenir m√©rite protection, m√™me si vous √™tes seul : pensez √† vous comme √† votre meilleur ami.", "value": "Prise en charge centr√©e sur l'assur√© (pas besoin d'avoir des ayants droit pour en b√©n√©ficier); garantie de ressources pour financer sa propre assistance; reste valable quel que soit votre statut familial."}, {"product": "Garantie Accidents de la Vie (GAV)", "situation": "S√©nior", "objection": "J'ai d√©j√† une assurance accident avec ma carte bancaire ou une garantie dans un autre contrat.", "response": "Les assurances accident des cartes bancaires sont en g√©n√©ral limit√©es : souvent elles ne couvrent que les accidents en voyage ou avec des conditions particuli√®res, et les montants d'indemnisation sont faibles. Notre GAV est beaucoup plus compl√®te : elle vous couvre en toutes circonstances, avec des plafonds d'indemnisation √©lev√©s, et elle prend en charge l'invalidit√© partielle ou totale, pas seulement le d√©c√®s. C'est une vraie s√©curit√© beaucoup plus large que les petites garanties annexes de carte.", "punchline": "Ne confondez pas une mini-garantie et une vraie protection : la GAV, c'est l'armure tous risques de votre quotidien.", "value": "Couverture bien plus √©tendue que les garanties accidents basiques (montants √©lev√©s, invalidit√© incluse); engagement contractuel clair et solide; tranquillit√© d'esprit en sachant que l'assureur interviendra r√©ellement en cas de besoin. D√©c√®s (Assurance Vie Risque D√©c√®s)"}, {"product": "Assurance D√©c√®s", "situation": "Famille", "objection": "Je suis jeune, ce n'est pas maintenant que je vais mourir . J'ai le temps avant de penser √† une assurance d√©c√®s.", "response": "Personne n'envisage de partir jeune, et je vous le souhaite √©galement. Mais justement, prendre une assurance d√©c√®s maintenant co√ªte tr√®s peu cher et s√©curise l'avenir de vos proches quoi qu'il arrive. Si un accident ou une maladie survenait, le capital vers√© permettrait √† votre famille de garder leur maison, de financer les √©tudes des enfants‚Ä¶ C'est une protection pr√©coce qui fait toute la diff√©rence, au cas o√π.", "punchline": "On attache sa ceinture sans pr√©voir d'accident, on assure sa famille sans pr√©voir de mourir .", "value": "Primes tr√®s basses √† jeune √¢ge pour un capital √©lev√©; protection imm√©diate de la famille en cas de coup dur; s√©r√©nit√© d'esprit pour le titulaire qui sait sa famille √† l'abri.9. 10. 1. 6"}, {"product": "Assurance D√©c√®s", "situation": "Famille", "objection": "J'ai d√©j√† une assurance d√©c√®s avec mon pr√™t immobilier / mon travail, √ßa suffit.", "response": "Ces couvertures existent, mais sont-elles suffisantes ? L'assurance emprunteur rembourse la banque, pas votre famille directement. Et l'assurance d√©c√®s de votre travail est limit√©e (g√©n√©ralement un ou deux ans de salaire) et dispara√Æt si vous changez d'employeur . Notre assurance d√©c√®s personnelle vous garantit un capital que VOUS choisissez, qui ira directement √† vos proches pour leurs besoins (factures, √©ducation des enfants, etc.), et ce quelle que soit votre situation professionnelle.", "punchline": "Ne confiez pas le destin financier de vos proches au hasard des contrats tiers : choisissez le v√¥tre.", "value": "Capital garanti d√©fini selon vos besoins familiaux; couverture ind√©pendante de l'emploi ou d'un pr√™t (vous gardez la ma√Ætrise); versement rapide directement aux b√©n√©ficiaires d√©sign√©s."}, {"product": "Assurance D√©c√®s", "situation": "Famille", "objection": "Au lieu de payer une prime d'assurance, je pr√©f√®re √©conomiser cet argent pour ma famille.", "response": "√âpargner , c'est bien, mais il vous faudrait des dizaines d'ann√©es pour mettre de c√¥t√© ce que l'assurance verserait en une seule fois si un malheur arrivait. Par exemple, en √©pargnant 30 ‚Ç¨ par mois, vous aurez 3 600 ‚Ç¨ en 10 ans. Une assurance d√©c√®s pourrait verser 100 000 ‚Ç¨ du jour au lendemain si besoin. C'est compl√©mentaire √† l'√©pargne : √ßa offre une protection imm√©diate que l'√©pargne seule ne peut atteindre rapidement.", "punchline": "", "value": ""}, {"product": "Assurance D√©c√®s", "situation": "Famille", "objection": "Statistiquement j'ai peu de risques de mourir jeune, payer pour √ßa semble de l'argent jet√© par les fen√™tres.", "response": "C'est vrai, on l'esp√®re tous : la probabilit√© est faible. Mais les cons√©quences seraient si lourdes pour vos proches que cela vaut la peine d'assurer ce risque-l√†. C'est un peu comme un extincteur √† la maison : on souhaite ne jamais s'en servir , mais on est bien content de l'avoir en cas d'incendie. Et vu le faible co√ªt de l'assurance d√©c√®s quand on est en bonne sant√©, le jeu en vaut la chandelle pour prot√©ger ceux qu'on aime.", "punchline": "Assurer un risque faible, parce que ses cons√©quences seraient insupportables √† porter pour vos proches.", "value": "Forte tranquillit√© d'esprit pour un co√ªt modique; prise en charge d'un risque aux cons√©quences financi√®res majeures; acte de pr√©voyance responsable qui compl√®te les autres assurances."}, {"product": "Assurance D√©c√®s", "situation": "Famille", "objection": "C'est trop morbide votre truc, je n'ai pas envie de penser √† ma mort pour souscrire un contrat.", "response": "Je comprends, ce n'est jamais agr√©able d'envisager le pire. Mais voyez cela plut√¥t comme un acte d'amour et de responsabilit√© envers vos proches. Une fois le contrat en place,2. 3. 4. 5. 7 vous n'aurez plus √† y penser au quotidien, sauf pour vous dire que quoi qu'il arrive, votre famille sera prot√©g√©e. Cela permet de vivre encore plus sereinement le pr√©sent, justement.", "punchline": "Pr√©voir l'impr√©visible, ce n'est pas √™tre morbide, c'est aimer sa famille intelligemment.", "value": "D√©marche simple et faite une fois pour toutes; soulagement mental de savoir sa famille prot√©g√©e; vos proches sont pr√©serv√©s du stress financier en plus du drame √©motionnel."}, {"product": "Assurance D√©c√®s", "situation": "S√©nior", "objection": "√Ä mon √¢ge c'est trop tard ou bien trop co√ªteux de prendre une assurance d√©c√®s.", "response": "Il existe des formules sp√©cialement pens√©es pour les seniors. M√™me √† 60 ou 65 ans, vous pouvez encore assurer un capital d√©c√®s modeste, par exemple pour aider votre conjoint ou payer vos frais d'obs√®ques. Les cotisations sont ajust√©es √† l'√¢ge, mais vous pouvez choisir un capital moins √©lev√© pour ma√Ætriser le budget. Mieux vaut tard que jamais : un petit capital vaut mieux qu'aucune aide du tout pour vos proches.", "punchline": "Il n'est jamais trop tard pour prot√©ger ceux qu'on aime, m√™me modestement.", "value": "Contrats adapt√©s aux seniors (sans examen m√©dical pour certains montants); possibilit√© de choisir un capital et une dur√©e de cotisation selon ses moyens; assure au minimum les frais imm√©diats (obs√®ques, factures) sans laisser la charge aux proches."}, {"product": "Assurance D√©c√®s", "situation": "S√©nior", "objection": "Mes enfants sont grands, ils n'ont pas besoin que je leur laisse de l'argent.", "response": "Vos enfants n'en ont peut-√™tre pas besoin pour vivre, mais pensez aux coups durs : ce capital pourrait leur permettre de prendre un nouveau d√©part, de r√©aliser un projet que vous voulez soutenir (achat immobilier , cr√©ation d'entreprise) ou simplement de financer les frais li√©s √† votre succession sans entamer leurs propres √©conomies. C'est un moyen de leur transmettre un dernier coup de pouce, un h√©ritage suppl√©mentaire symbole de votre soutien.", "punchline": "Ce n'est pas d'assistance dont vos enfants adultes ont besoin, mais d'un dernier geste qui fait la diff√©rence.", "value": "Libert√© de d√©signer le b√©n√©ficiaire de votre choix (enfant, petit-enfant, cause caritative); capital vers√© hors succession (selon la r√©glementation, ce qui peut acc√©l√©rer et faciliter la transmission); geste d'amour final qui peut faire la diff√©rence dans leurs projets."}, {"product": "Assurance D√©c√®s", "situation": "S√©nior", "objection": "J'ai suffisamment d'√©conomies et de patrimoine, je n'ai pas besoin d'assurance pour transmettre quelque chose.", "response": "Votre patrimoine est pr√©cieux, mais songez que lors d'un d√©c√®s, les comptes peuvent √™tre bloqu√©s le temps de la succession et des droits de succession sont dus. L'assurance d√©c√®s verse un capital liquide et imm√©diat √† vos b√©n√©ficiaires, leur √©vitant d'avoir √† vendre un bien en urgence ou de puiser dans leurs poches pour payer les frais. C'est une s√©curit√© en plus, m√™me quand on a du patrimoine : de l'argent disponible tout de suite pour faire face √† tout.", "punchline": "Un patrimoine, c'est bien. Du cash disponible imm√©diatement pour vos proches, c'est encore mieux en moment de crise.", "value": "Capital hors succession vers√© en quelques semaines sans formalit√©s lourdes; permet de payer les frais (succession, obs√®ques) sans entamer le patrimoine principal; √©vite des d√©cisions pr√©cipit√©es (vente de biens) pour r√©gler des urgences financi√®res."}, {"product": "Assurance D√©c√®s", "situation": "S√©nior6.", "objection": "Mon √©pouse/√©poux touchera ma pension de r√©version, √ßa suffira pour vivre.", "response": "La pension de r√©version ne repr√©sente qu'une partie de votre retraite (souvent 50 √† 60%). Cela veut dire que le revenu de votre conjoint va diminuer significativement. Avec une assurance d√©c√®s, vous compensez cette baisse brutale de ressources : le capital peut √™tre plac√© pour g√©n√©rer un compl√©ment de revenu ou servir de matelas financier le temps que votre conjoint se retourne. C'est assurer le m√™me niveau de vie √† votre moiti√©, sans mauvaises surprises.", "punchline": "Ne laissez pas la moiti√© de votre retraite devenir la totalit√© de ses revenus : compensez pour son confort.", "value": "Maintien du niveau de vie du conjoint survivant; capital transformable en rente ou en √©pargne de secours; protection du conjoint au-del√† des r√©gimes de retraite officiels."}, {"product": "Assurance D√©c√®s", "situation": "S√©nior", "objection": "Franchement, je pr√©f√®re utiliser mon argent pour profiter de la vie maintenant que payer une assurance pour quand je ne serai plus l√†.", "response": "Vous avez bien raison de profiter de la vie. Et justement, souscrire une assurance d√©c√®s n'emp√™che pas de le faire : le co√ªt peut √™tre tr√®s mod√©r√© compar√© √† vos d√©penses de loisir , et c'est une mani√®re de profiter l'esprit tranquille. En sachant vos proches prot√©g√©s, chaque voyage ou petit plaisir est savour√© sans arri√®re-pens√©e. Quelques dizaines d'euros par mois ne vous priveront pas de vos joies, mais √©viteront bien des soucis √† votre famille plus tard.", "punchline": "Vivez pleinement aujourd'hui, assurez l'avenir des v√¥tres en parall√®le : l'un n'emp√™che pas l'autre.", "value": "Cotisation modeste par rapport √† vos revenus de retrait√© actifs; tranquillit√© d'esprit qui vous permet d'appr√©cier encore plus vos loisirs; assurance de laisser une empreinte positive et utile sans vous restreindre. PER (Plan √âpargne Retraite)"}, {"product": "Plan √âpargne Retraite (PER)", "situation": "Famille", "objection": "Je n'ai pas les moyens d'√©pargner pour la retraite avec toutes mes charges actuelles.", "response": "Le PER est justement tr√®s flexible : vous pouvez y mettre de petites sommes, quand vous le pouvez. M√™me 50 ‚Ç¨ par mois peuvent suffire pour commencer . Et n'oubliez pas que chaque versement est d√©ductible de vos imp√¥ts : si vous payez des imp√¥ts, l'√âtat en prend une partie √† sa charge, ce qui al√®ge votre effort. C'est une √©pargne progressive et adapt√©e √† vos capacit√©s, pour ne pas sentir de manque tout en construisant votre futur petit √† petit.", "punchline": "Mieux vaut √©pargner un peu r√©guli√®rement que rien du tout : chaque euro compte pour votre futur .", "value": "Versements libres et modulables selon votre budget; avantage fiscal imm√©diat qui r√©duit l'effort net; constitution progressive d'un capital sans pression."}, {"product": "Plan √âpargne Retraite (PER)", "situation": "Famille", "objection": "L'argent est bloqu√© jusqu'√† la retraite, si j'ai un coup dur je ne pourrai pas y toucher .", "response": "Le PER a pour vocation de s√©curiser votre retraite, c'est vrai que l'√©pargne est bloqu√©e sauf cas exceptionnels. Mais sachez qu'il existe des possibilit√©s de retrait anticip√© : achat de votre r√©sidence principale, invalidit√©, d√©c√®s de votre conjoint, ch√¥mage de longue dur√©e‚Ä¶ Dans ces situations, vous pouvez r√©cup√©rer vos fonds. Et √† la retraite, vous aurez le choix de sortir en capital si vous voulez tout r√©cup√©rer d'un coup. En fait, c'est un coffre-fort pour vos vieux jours,10. 1. 2. 9 avec une cl√© de secours en cas de gros coup dur .", "punchline": "Bloqu√© jusqu'√† la retraite, sauf en cas de vraie n√©cessit√© : votre √©pargne est en s√©curit√©, pas en prison.", "value": "√âpargne s√©curis√©e pour l'objectif retraite (√©vite les tentations de la puiser); options de d√©blocage anticip√© en cas de situations difficiles; possibilit√© de sortie flexible √† la retraite (capital ou rente)."}, {"product": "Plan √âpargne Retraite (PER)", "situation": "Famille", "objection": "Qui me dit que d'ici 20 ans l'√âtat ne va pas changer les r√®gles fiscales ? Je n'ai pas confiance.", "response": "Les r√®gles peuvent √©voluer , mais l'objectif du PER est de rester avantageux pour inciter les gens √† √©pargner . Depuis son lancement, d√©j√† 10 millions de Fran√ßais l'ont adopt√© , c'est un pilier de la politique retraite actuelle. Et g√©n√©ralement, les avantages acquis sont conserv√©s m√™me en cas d'ajustements. En attendant, vous profitez d√®s aujourd'hui de la r√©duction d'imp√¥t et de la croissance de votre √©pargne. Ne pas agir par crainte de changements hypoth√©tiques, c'est se priver d'avantages bien r√©els maintenant. Et quoi qu'il arrive, l'argent que vous aurez mis de c√¥t√© restera √† vous.", "punchline": "", "value": ""}, {"product": "Plan √âpargne Retraite (PER)", "situation": "Famille", "objection": "Je pr√©f√®re investir dans l'immobilier ou sur une assurance vie, au moins je peux disposer de mon argent.", "response": "L'immobilier et l'assurance vie sont de tr√®s bons placements, compl√©mentaires du PER. Le PER a un atout que les autres n'ont pas : l'√©conomie d'imp√¥t √† l'entr√©e, ce qui booste votre rendement. Et il est sp√©cifiquement con√ßu pour vous donner un revenu √† la retraite. Par exemple, avec un PER vous pouvez choisir de transformer votre capital en rente viag√®re pour un compl√©ment √† vie. Rien ne vous emp√™che d'avoir plusieurs supports d'√©pargne, au contraire : diversifier , c'est s√©curiser . Le PER vient simplement ajouter un avantage fiscal et une discipline pour votre objectif retraite.", "punchline": "", "value": ""}, {"product": "Plan √âpargne Retraite (PER)", "situation": "Famille", "objection": "Ma retraite, j'y penserai plus tard. J'ai encore le temps, l√† j'ai d'autres priorit√©s.", "response": "Plus tard, ce sera plus difficile de rattraper le temps perdu. Chaque ann√©e sans √©pargne retraite est une occasion manqu√©e de faire fructifier votre argent. Si vous commencez maintenant, m√™me modestement, vous profiterez de l'effet cumul√© des int√©r√™ts. En commen√ßant tard, il faudra cotiser bien plus chaque mois pour compenser . Mieux vaut mettre un peu de c√¥t√© maintenant que beaucoup dans l'urgence √† 5 ans de la retraite. Votre vous du futur vous remerciera d'avoir commenc√© t√¥t !", "punchline": "", "value": ""}, {"product": "Plan √âpargne Retraite (PER)", "situation": "S√©nior", "objection": "Je suis √† 10 ans de la retraite √† peine, √ßa ne sert √† rien d'ouvrir un PER si tard.", "response": "Il n'est pas trop tard ! √Ä 10 ans de la retraite, vous √™tes sans doute √† votre pic de revenus. Placer une partie de vos revenus dans un PER va fortement r√©duire vos imp√¥ts chaque ann√©e, et cet argent √©conomis√© travaille pour vous. En 10 ans, avec des versements r√©guliers ou ponctuels (prime de fin de carri√®re, √©pargne disponible), vous pouvez constituer un beau compl√©ment. Et √† la sortie, vous pourrez retirer en capital pour r√©aliser vos projets de retraite. M√™me sur 10 ans, le PER peut faire une belle diff√©rence, surtout fiscalement.", "punchline": "Chaque ann√©e compte, m√™me les dix derni√®res : le PER peut encore booster votre retraite in extremis .", "value": "R√©duction fiscale importante en fin de carri√®re (o√π l'imp√¥t est souvent √©lev√©); possibilit√© de versements uniques cons√©quents (ex : indemnit√©s de d√©part) pour profiter du cadre PER; constitution rapide d'un capital retraite compl√©mentaire utilisable d√®s le premier jour de la retraite."}, {"product": "Plan √âpargne Retraite (PER)", "situation": "S√©nior", "objection": "Je suis d√©j√† √† la retraite, ouvrir un PER ne m'apporterait rien.", "response": "Certes, une fois √† la retraite, l'avantage de la d√©duction fiscale est moins pertinent si vos revenus baissent. Mais le PER peut encore servir d'outil patrimonial. Par exemple, si vous souhaitez transmettre un capital √† un proche dans un cadre favorable ou vous constituer plus tard une rente viag√®re (pour vos 80 ans et plus), c'est possible. De plus, si vous avez h√©rit√© ou vendu un bien, vous pouvez loger cette somme dans un PER pour la faire fructifier √† l'abri de l'imp√¥t jusqu'√† sa sortie. Ce n'est pas le premier public vis√©, mais c'est loin d'√™tre inutile selon vos objectifs.", "punchline": "M√™me retrait√©, on peut encore planifier et optimiser : le PER n'a pas d'√¢ge pour servir vos projets.", "value": "Outil souple pour g√©rer des sommes m√™me une fois retrait√© (capitalisation √† l'abri de l'imp√¥t); possibilit√© de transmission aux b√©n√©ficiaires en cas de d√©c√®s avec fiscalit√© avantageuse (similaire √† l'assurance vie); option de rente viag√®re future pour anticiper une possible d√©pendance."}, {"product": "Plan √âpargne Retraite (PER)", "situation": "S√©nior", "objection": "Et si je d√©c√®de avant d'en profiter , tout cet argent sera perdu ?", "response": "Pas du tout, rassurez-vous. L'√©pargne accumul√©e sur votre PER ne dispara√Æt pas si vous veniez √† d√©c√©der . Au contraire, elle est transmise √† vos b√©n√©ficiaires, un peu comme avec une assurance vie. Vous pouvez d√©signer la personne de votre choix qui recevra les fonds. Donc soit vous en profitez vous-m√™me √† la retraite, soit ce sont vos proches qui en profitent. Dans tous les cas, l'argent que vous placez sur le PER revient √† votre foyer d'une mani√®re ou d'une autre.", "punchline": "Sur le PER, rien n'est perdu : si ce n'est pas vous, ce sera vos proches qui r√©colteront le fruit de votre √©pargne.", "value": "Clause b√©n√©ficiaire pour transmettre le capital √©pargn√©; assurance que l'effort d'√©pargne profite √† la famille m√™me en cas d'al√©a de la vie; √©pargne s√©curis√©e juridiquement (hors succession classique selon les cas, acc√©l√©rant le versement).6. 7. 8. 11"}, {"product": "Plan √âpargne Retraite (PER)", "situation": "S√©nior", "objection": "Je ne paie presque pas d'imp√¥ts, le b√©n√©fice fiscal du PER ne m'int√©resse pas.", "response": "M√™me sans avantage fiscal imm√©diat, le PER reste int√©ressant. D'abord, il vous force √† sanctuariser une √©pargne pour la retraite, l√† o√π une assurance vie par exemple pourrait √™tre d√©pens√©e √† tout moment. Ensuite, vos gains accumul√©s dans le PER ne sont pas impos√©s tant que vous ne sortez pas l'argent, ce qui veut dire plus de capitalisation. Enfin, vous pouvez aussi choisir de ne pas d√©duire vos versements : ainsi, √† la sortie, vous r√©cup√©rerez votre √©pargne avec seulement les gains fiscalis√©s √† taux r√©duit. En somme, c'est un outil de plus pour pr√©parer l'avenir , m√™me si l'avantage fiscal est moindre pour vous.", "punchline": "Le PER, ce n'est pas que pour les gros imp√¥ts : c'est avant tout pour se payer une retraite plus confortable, imp√¥ts ou pas.", "value": "Discipline d'√©pargne d√©di√©e √† la retraite (on ne pioche pas dedans facilement); capitalisation √† l'abri de l'imp√¥t sur les revenus de placements; flexibilit√© fiscale (d√©duire ou non selon l'int√©r√™t, et imposition all√©g√©e en sortie si non d√©duit)."}, {"product": "Plan √âpargne Retraite (PER)", "situation": "S√©nior", "objection": "C'est trop risqu√© votre PER, je ne veux pas jouer ma retraite en bourse.", "response": "Le PER n'est pas un produit unique en bourse, c'est vous qui choisissez comment l'investir . Vous pouvez opter pour des placements s√©curis√©s, comme des fonds en euros garantis, ou moduler le risque selon ce qui vous convient. De plus, la gestion pilot√©e de nombreux PER s√©curise automatiquement votre √©pargne √† l'approche de la retraite, pour √©viter les mauvaises surprises. En clair , vous pouvez profiter du PER m√™me avec un profil prudent : ce n'est pas du casino, c'est de l'√©pargne sur-mesure.", "punchline": "", "value": ""}, {"product": "Assurance Vie", "situation": "Famille", "objection": "Le rendement des fonds en euros est trop faible, √ßa ne rapporte presque rien.", "response": "Il est vrai que le fonds garanti en euros a eu des taux bas ces derni√®res ann√©es, mais il a l'avantage de la s√©curit√© totale. Et rien ne vous oblige √† rester sur du 100 % fonds euros : en assurance vie, vous pouvez diversifier sur des fonds plus dynamiques pour chercher du rendement, tout en gardant une partie s√©curis√©e. De plus, les int√©r√™ts du fonds euros s'accumulent sans imp√¥ts chaque ann√©e tant que vous ne retirez pas, ce qui am√©liore le rendement net √† terme. C'est un placement √©quilibr√© entre s√©curit√© et performance sur la dur√©e.", "punchline": "S√©curit√© et performance : en assurance vie, √† vous de doser le cocktail pour booster le rendement.", "value": "Capital garanti sur le fonds euros + potentiel de meilleurs rendements via des unit√©s de compte; int√©r√™ts capitalis√©s sans fiscalit√© annuelle; ajustement possible de la strat√©gie en cours de route selon le contexte √©conomique."}, {"product": "Assurance Vie", "situation": "Famille9.", "objection": "Il y a trop de frais (entr√©e, gestion‚Ä¶), au final √ßa mange tout le profit.", "response": "Notre assurance vie est nouvelle g√©n√©ration : 0 % de frais d'entr√©e, et des frais de gestion r√©duits. Les assureurs ont fait des efforts, la concurrence a tir√© les prix vers le bas. Par ailleurs, les avantages de l'assurance vie (comme la fiscalit√© all√©g√©e apr√®s 8 ans, ou la gestion professionnelle) compensent largement ces petits frais. Pensez-y : pas d'imp√¥ts sur vos gains tant que vous ne sortez pas l'argent, √ßa fait souvent plus d'√©conomie que les frais de gestion annuels. Au final, le rendement net reste tr√®s attractif.", "punchline": "Des frais ma√Ætris√©s pour un maxi-profit : l'assurance vie moderne sait rester comp√©titive.", "value": "Contrats sans frais d'entr√©e et √† frais r√©duits; optimisation fiscale qui compense les co√ªts; expertise de gestion incluse pour faire fructifier au mieux l'√©pargne."}, {"product": "Assurance Vie", "situation": "Famille", "objection": "Mon argent est bloqu√© pendant 8 ans, si j'ai besoin je ne pourrai pas y toucher .", "response": "Contrairement √† une id√©e re√ßue, l'argent n'est pas bloqu√© 8 ans. Vous pouvez retirer tout ou partie de votre √©pargne quand vous voulez. Les 8 ans, c'est seulement pour b√©n√©ficier du maximum d'avantages fiscaux sur les gains. M√™me si vous retirez avant, vous aurez simplement une petite taxation sur les int√©r√™ts, rien d'interdit. Et en cas de besoin urgent, un rachat partiel peut se faire en quelques jours, le temps que l'assureur traite l'op√©ration. L'assurance vie, c'est liquide et souple : vous gardez le contr√¥le de vos fonds.", "punchline": "Disponible √† tout moment : votre argent reste le v√¥tre, avec en bonus des avantages fiscaux au fil du temps.", "value": "Liquidit√© de l'√©pargne (rachats possibles √† tout moment sans p√©nalit√©); fiscalit√© d√©gressive avec le temps (apr√®s 8 ans, abattement annuel sur les gains); souplesse des versements et retraits selon vos besoins."}, {"product": "Assurance Vie", "situation": "Famille", "objection": "Je pr√©f√®re investir directement moi-m√™me en bourse ou dans la pierre plut√¥t que via une assurance vie.", "response": "Investir en direct, c'est bien, mais l'assurance vie offre un cadre vraiment avantageux pour le faire. Vous pouvez investir en unit√©s de compte dans plein de fonds (actions, immobilier papier , etc.) sans vous soucier de la gestion administrative : pas d'imposition √† chaque arbitrage, pas de complications de succession sur ces actifs. Tout est regroup√© et g√©r√© de fa√ßon professionnelle. Et si un jour vous voulez changer de strat√©gie, vous arbitrez sans co√ªt fiscal interne. En plus, avec l'assurance vie vous combinez divers placements dans un seul contrat facile √† piloter . C'est la tranquillit√© d'esprit et l'optimisation fiscale en plus de l'investissement.", "punchline": "", "value": ""}, {"product": "Assurance Vie", "situation": "Famille", "objection": "Moi j'aime les placements s√ªrs comme le Livret A ou le PEL. L'assurance vie, √ßa me semble plus risqu√© ou complexe.", "response": "L'assurance vie peut √™tre aussi s√©curitaire que vous le souhaitez. Par exemple, vous pouvez mettre une grande part sur le fonds en euros garanti, qui rapporte en g√©n√©ral plus qu'un Livret A sur le long terme tout en √©tant sans risque en capital. Et contrairement au PEL ou au3. 4. 5. 13 Livret, il n'y a pas de plafond de d√©p√¥t, vous pouvez placer de plus grosses sommes. En prime, la fiscalit√© de l'assurance vie au-del√† de 8 ans est tr√®s douce, ce qui am√©liore le rendement net. Donc vous gardez la s√©curit√©, mais avec du rendement et de la libert√© en plus.", "punchline": "Aussi s√ªr qu'un Livret, plus performant sur la dur√©e : l'assurance vie allie s√©curit√© et efficacit√©.", "value": "Fonds en euros √† capital garanti offrant une r√©mun√©ration attractive sur la dur√©e; aucun plafond de versement (√©pargnez √† votre rythme sans limite); cadre fiscal avantageux apr√®s quelques ann√©es de d√©tention."}, {"product": "Assurance Vie", "situation": "Famille", "objection": "Je n'y comprends rien √† vos unit√©s de compte, arbitrages‚Ä¶ C'est trop compliqu√© pour moi.", "response": "Pas de souci, on est l√† pour √ßa ! Vous pouvez tout √† fait opter pour une gestion simplifi√©e : soit 100 % fonds en euros sans vous pr√©occuper du reste, soit une gestion pilot√©e o√π nos experts s'occupent d'investir pour vous en fonction de votre profil. Vous d√©finissez juste vos objectifs (s√©curitaire ou plus dynamique) et on fait le travail. L'assurance vie peut √™tre aussi simple qu'un livret une fois mise en place. Et vous recevez des comptes rendus clairs pour suivre l'√©volution sans jargon incompr√©hensible.", "punchline": "", "value": ""}, {"product": "Assurance Vie", "situation": "S√©nior", "objection": "J'ai plus de 70 ans, l'avantage fiscal pour la succession de l'assurance vie ne s'applique plus vraiment.", "response": "Il est vrai qu'apr√®s 70 ans, les nouveaux versements n'ont plus le gros abattement de 152 500 ‚Ç¨ par b√©n√©ficiaire. Cependant, les int√©r√™ts g√©n√©r√©s par ces versements restent exon√©r√©s de droits de succession, ce qui n'est pas n√©gligeable. Et l'assurance vie garde d'autres atouts : vous pouvez toujours d√©signer pr√©cis√©ment qui recevra l'argent et le versement aux b√©n√©ficiaires est rapide, sans attendre le r√®glement de toute la succession. √Ä plus de 70 ans, l'assurance vie reste un excellent outil pour placer vos √©conomies en profitant d'une fiscalit√© all√©g√©e sur les gains et en facilitant la transmission le moment venu.", "punchline": "M√™me apr√®s 70 ans, l'assurance vie vous donne un coup d'avance : moins d'imp√¥ts sur les gains et un h√©ritage vers√© sans d√©lai.", "value": "Gains futurs non tax√©s aux h√©ritiers (seul le capital vers√© apr√®s 70 ans est compt√© pour les droits, pas les int√©r√™ts); clause b√©n√©ficiaire sur-mesure pour r√©partir votre patrimoine comme vous le souhaitez; versement rapide des fonds aux b√©n√©ficiaires (souvent en quelques semaines)."}, {"product": "Assurance Vie", "situation": "S√©nior", "objection": "Je ne veux pas prendre de risques, si la bourse s'effondre je peux tout perdre.", "response": "Rien ne vous oblige √† prendre des risques inconsid√©r√©s. Dans votre assurance vie, vous pouvez tout mettre sur des supports prudents. Par exemple, le fonds en euros garantit votre capital tout en g√©n√©rant des int√©r√™ts chaque ann√©e. Et m√™me si vous voulez un peu plus de rendement, vous pouvez diversifier modestement sur des fonds tr√®s s√©curis√©s (fonds obligataires, immobiliers stables). De plus, vous pouvez ajuster √† tout moment si le contexte6. 7. 8. 14 change. En clair , l'assurance vie s'adapte √† VOTRE profil : du plus prudent au plus audacieux, c'est vous qui fixez le curseur .", "punchline": "Z√©ro risque ou un soup√ßon de risque, c'est vous qui d√©cidez : l'assurance vie s'adapte √† votre tranquillit√© d'esprit.", "value": "Fonds en euros garantis pour une √©pargne sans risque; large choix de supports pour coller √† votre tol√©rance au risque; possibilit√© de modifier la r√©partition √† tout moment pour s√©curiser si besoin."}, {"product": "Assurance Vie", "situation": "S√©nior", "objection": "Je pr√©f√®re donner de l'argent √† mes enfants maintenant de mon vivant, plut√¥t que de le mettre sur une assurance vie.", "response": "Aider vos enfants de votre vivant, c'est super , mais gardez peut-√™tre une poire pour la soif. L'assurance vie vous permet de rester ma√Ætre de votre √©pargne : si vous en avez besoin, elle est l√†, et si tout va bien, ce sont vos enfants qui en h√©riteront plus tard. En plus, en passant par l'assurance vie, vous pouvez potentiellement transmettre davantage : par exemple, les sommes transmises via l'assurance vie b√©n√©ficient d'abattements fiscaux sp√©cifiques, ce qui peut permettre √† vos enfants de recevoir plus que via une donation classique tax√©e. En bref, vous ne vous privez pas aujourd'hui, et vous optimisez pour eux demain.", "punchline": "Donner oui, mais sans vous d√©munir : l'assurance vie concilie votre s√©curit√© et leur futur .", "value": "Vous conservez la disponibilit√© de votre capital en cas de besoin; cadre fiscal transmission avantageux (abattements d√©di√©s assurance vie en plus des donations classiques); possibilit√© de partager le capital plus √©quitablement ou progressivement selon vos souhaits."}, {"product": "Assurance Vie", "situation": "S√©nior", "objection": "De toute fa√ßon, √† la fin mes enfants paieront des imp√¥ts sur l'assurance vie, alors quel int√©r√™t ?", "response": "En r√©alit√©, l'assurance vie est l'un des outils les plus avantageux pour transmettre un capital. Pour les versements effectu√©s avant vos 70 ans, chaque b√©n√©ficiaire a droit √† 152 500 ‚Ç¨ exempt√©s d'imp√¥ts, puis une taxation forfaitaire de 20 % (au-del√† de montants tr√®s √©lev√©s) . C'est souvent bien moins que les droits de succession classiques qui peuvent monter √† 30-40%. Concr√®tement, dans la plupart des cas, vos enfants ne paieront rien ou tr√®s peu sur l'assurance vie. Et vous pouvez d√©signer plusieurs b√©n√©ficiaires pour multiplier les abattements. L'int√©r√™t, c'est donc que vos proches re√ßoivent plus, plus rapidement et en toute confidentialit√©.", "punchline": "Moins d'imp√¥ts, plus pour vos proches : l'assurance vie, c'est l'h√©ritage optimis√©.", "value": "Fiscalit√© ultra-avantageuse pour les b√©n√©ficiaires (surtout pour les sommes vers√©es avant 70 ans); possibilit√© de diviser le capital entre plusieurs b√©n√©ficiaires pour optimiser les abattements; transmission directe hors notaire sur ces capitaux (versement simplifi√© et discret). Assurance Emprunteur"}, {"product": "Assurance Emprunteur", "situation": "Famille", "objection": "La banque m'oblige √† prendre son assurance de pr√™t, je n'ai pas le choix.", "response": "Depuis quelques ann√©es, la loi vous permet de choisir librement votre assurance emprunteur . La banque n'a pas le droit d'imposer la sienne si vous trouvez moins cher ou mieux ailleurs. En pratique, beaucoup d'emprunteurs changent d'assurance pour √©conomiser , tout en gardant la m√™me protection . Vous avez donc tout √† fait le choix de prendre une9. 10. 2 1. 3 3 4 15 assurance ind√©pendante et souvent moins co√ªteuse.", "punchline": "Votre pr√™t, votre assurance, votre choix : la loi est de votre c√¥t√©.", "value": "Libert√© de choisir une assurance d√©l√©gu√©e gr√¢ce √† la l√©gislation (Loi Lagarde, Hamon, Lemoine); possibilit√© de r√©duire consid√©rablement le co√ªt de l'assurance tout en conservant les m√™mes garanties; contrat sur-mesure adapt√© √† votre profil plut√¥t qu'une offre standard de banque."}, {"product": "Assurance Emprunteur", "situation": "Famille", "objection": "Changer d'assurance de pr√™t, √ßa a l'air d'√™tre la gal√®re administrative.", "response": "Pas du tout. Nous nous occupons de presque tout pour vous. Concr√®tement, une fois que vous avez choisi notre contrat, on g√®re les d√©marches de r√©siliation de l'ancienne assurance et la mise en place de la nouvelle. La banque doit juste v√©rifier que les garanties sont √©quivalentes, ce qui est le cas avec notre offre. En quelques semaines tout est boucl√©, sans interruption de couverture. Pour vous, c'est juste quelques papiers √† signer et des √©conomies √† la cl√©.", "punchline": "On s'occupe de la paperasse, vous, vous profitez des √©conomies : changer d'assurance, c'est facile.", "value": "Prise en charge compl√®te du processus de changement (conseil, comparatif, d√©marches administratives); continuit√© de garantie assur√©e sans carence; simplicit√© et rapidit√© de la substitution (proc√©dure standardis√©e avec les banques)."}, {"product": "Assurance Emprunteur", "situation": "Famille", "objection": "Je ne vais pas √©conomiser grand-chose en changeant, √ßa vaut √† peine le coup de s'emb√™ter .", "response": "Ne sous-estimez pas les √©conomies possibles : sur la dur√©e restante de votre pr√™t, √ßa peut repr√©senter des milliers d'euros. Par exemple, √©conomiser 20 ‚Ç¨ par mois, c'est 240 ‚Ç¨ par an, et 2 400 ‚Ç¨ sur 10 ans, sans compter les int√©r√™ts. Pour un effort minime de changement, c'est de l'argent que vous gardez pour vous ou vos projets. Et m√™me si l'√©conomie √©tait moindre, pourquoi payer plus cher pour la m√™me protection ? Chaque euro gagn√© compte.", "punchline": "", "value": ""}, {"product": "Assurance Emprunteur", "situation": "Famille", "objection": "J'ai eu des probl√®mes de sant√©, j'ai peur qu'en changeant d'assurance on me refuse ou qu'on exclue des garanties.", "response": "On va √©tudier votre profil m√©dical en toute confidentialit√© avant de lancer le changement. Il existe de nombreuses assurances emprunteur sur le march√©, et certaines sont sp√©cialis√©es pour couvrir des personnes avec des ant√©c√©dents de sant√©, parfois sans surprime selon la situation. De plus, si votre pr√™t est de moins de 200 000 ‚Ç¨ et se termine avant vos 60 ans, la loi r√©cente permet m√™me de ne plus remplir de questionnaire de sant√© du tout ! On trouvera ensemble le meilleur contrat : soit avec des garanties identiques, soit on conclura qu'il vaut mieux garder l'actuel si c'est plus s√ªr pour vous. Dans tous les cas, vous ne prenez pas de risque √† comparer .", "punchline": "Sant√© fragile ne veut pas dire assurance impossible : on cherche pour vous la couverture adapt√©e, sans risque pour votre pr√™t.2. 3. 4. 5 16", "value": "Solutions d'assurance emprunteur inclusives (contrats sp√©cialis√©s et loi Lemoine supprimant le questionnaire m√©dical sous conditions); analyse pr√©alable gratuite de votre dossier m√©dical; garantie de n'op√©rer le changement que si les nouvelles conditions sont b√©n√©fiques et conformes."}, {"product": "Assurance Emprunteur", "situation": "Famille", "objection": "Mon assurance actuelle ne me pose pas de probl√®me, j'ai un peu la flemme de changer .", "response": "C'est justement parce qu'elle ne pose pas de probl√®me que c'est le bon moment pour voir si on peut trouver mieux ! Vous n'attendez pas d'avoir un souci pour agir , vous le faites par opportunit√©. En plus, on a rendu le changement tr√®s simple pour vous. Pensez aux √©conomies ou aux garanties suppl√©mentaires que vous pourriez obtenir sans effort. Vous pourriez, par exemple, payer moins cher tout en √©tant couvert sur une plus longue dur√©e ou avec moins d'exclusions. √áa vaut le coup de regarder , non ?", "punchline": "", "value": ""}, {"product": "Assurance Emprunteur", "situation": "S√©nior", "objection": "J'ai pass√© 60 ans, je pense que c'est trop tard pour changer d'assurance de pr√™t.", "response": "Il existe des assureurs qui couvrent les emprunteurs jusqu'√† un √¢ge avanc√©, parfois m√™me 85 ans en fin de pr√™t. Si votre pr√™t court encore quelques ann√©es, on peut tout √† fait √©tudier une reprise par un nouveau contrat. Souvent, la banque applique des tarifs √©lev√©s aux seniors, alors qu'en face on peut trouver mieux calibr√©. Et si votre sant√© est bonne, il n'y a aucune raison de continuer √† payer le tarif fort. On adapte la couverture √† votre √¢ge et vos besoins r√©els, sans payer des garanties inutiles. Vous pourriez √™tre agr√©ablement surpris des √©conomies r√©alisables m√™me apr√®s 60 ans.", "punchline": "Tant que votre pr√™t court, il n'est jamais trop tard pour assurer moins cher et mieux.", "value": "Contrats disponibles pour emprunteurs seniors (avec couverture d√©c√®s possible jusqu'√† 85 ans); ajustement des garanties (par exemple suppression de l'incapacit√© de travail si vous √™tes retrait√©, ce qui baisse le co√ªt); √©conomies potentielles importantes sur la fin de pr√™t o√π les capitaux restants sont plus faibles."}, {"product": "Assurance Emprunteur", "situation": "S√©nior", "objection": "Il ne reste que quelques ann√©es sur mon pr√™t, ce n'est pas la peine de changer d'assurance maintenant.", "response": "M√™me sur les derni√®res ann√©es, payer moins cher votre assurance, c'est bon √† prendre ! Si, par exemple, il vous reste 5 ans de pr√™t et que vous √©conomisez 15 ‚Ç¨ par mois, √ßa fait quand m√™me pr√®s de 900 ‚Ç¨ d'√©conomies au total. Et la d√©marche de changement ne vous co√ªte rien. Par ailleurs, en fin de pr√™t, les garanties peuvent √™tre adapt√©es : si vous √™tes d√©j√† √† la retraite, on peut retirer la couverture perte d'emploi par exemple, que vous payez peut-√™tre inutilement. Donc oui, √ßa vaut le coup de regarder , surtout qu'en quelques semaines c'est r√©gl√©.", "punchline": "Il n'y a pas de petite √©conomie : en fin de pr√™t aussi, all√©gez vos cotisations et finissez de payer avec le sourire.", "value": "Adaptation des garanties aux derni√®res ann√©es de pr√™t (arr√™t de certaines couvertures non pertinentes, ce qui r√©duit la prime); calcul transparent des gains potentiels sur5. 6. 7. 17 la p√©riode restante; aucune p√©nalit√© de changement en cours de contrat (changement d√©sormais possible √† tout moment)."}, {"product": "Assurance Emprunteur", "situation": "S√©nior", "objection": "J'ai peur qu'en changeant d'assurance, je sois moins bien couvert ou qu'il y ait des clauses cach√©es.", "response": "Votre vigilance est l√©gitime. C'est pour √ßa qu'on ne vous proposera un nouveau contrat que si toutes les garanties indispensables sont au moins √©quivalentes √† votre contrat actuel. On passe en revue point par point (d√©c√®s, invalidit√©, incapacit√©) pour s'assurer que vous ne perdez rien. En fait, on cherche souvent √† vous faire gagner : par exemple, des exclusions en moins ou des options en plus (prise en charge plus longue, couverture des maladies dorsales, etc.). Et bien s√ªr , tout est transparent dans les conditions. Vous aurez en main le d√©tail noir sur blanc avant de d√©cider . Pas de mauvaise surprise, juste de bonnes surprises !", "punchline": "", "value": ""}, {"product": "Assurance Emprunteur", "situation": "Famille", "objection": "Si je change d'assurance, la banque risque de mal le prendre et de compliquer les choses.", "response": "La banque n'a pas le droit de modifier les conditions de votre pr√™t parce que vous changez d'assurance. C'est encadr√© par la loi : aucune augmentation de taux ou frais additionnels ne peuvent √™tre appliqu√©s du fait du changement. Et aujourd'hui, les banques sont habitu√©es, de nombreux clients le font. Au pire, elles vont vous demander un document ou deux, mais nous vous accompagnons pour fournir tout ce qu'il faut. Votre dossier de pr√™t reste inchang√©, vous faites juste jouer la concurrence sur l'assurance, ce qui est votre droit le plus strict.", "punchline": "", "value": ""}, {"product": "Assurance Emprunteur", "situation": "Famille", "objection": "Cette assurance de pr√™t co√ªte cher , j'aimerais m'en passer .", "response": "Je comprends, c'est un co√ªt en plus. Mais il faut la voir comme la protection de votre foyer . Si un coup dur vous arrive (d√©c√®s ou invalidit√©), sans assurance, votre famille devrait payer le cr√©dit √† votre place ou vendre la maison. Avec l'assurance, le pr√™t est rembours√© et vos proches gardent le toit familial sans dette. C'est une s√©curit√© indispensable pour un investissement aussi important qu'une maison. D'ailleurs, la banque l'exige justement pour se prot√©ger ET vous prot√©ger . Mieux vaut payer une cotisation ma√Ætris√©e et √™tre tranquille, plut√¥t que de prendre le risque de tout perdre en cas de malheur .", "punchline": "On assure bien la maison elle-m√™me, pourquoi pas le cr√©dit qui la finance ? Mieux vaut perdre quelques euros que sa maison.", "value": "Protection totale de la famille en cas de d√©c√®s/invalidit√© de l'emprunteur (le bien8. 9. 10. 18 est conserv√© sans dette); tranquillit√© d'esprit pendant toute la dur√©e du pr√™t; contrat ajustable pour optimiser le co√ªt tout en respectant les exigences (choix des garanties adapt√©es √† la situation familiale). Assurance Obs√®ques"}, {"product": "Assurance Obs√®ques", "situation": "Famille", "objection": "Je suis trop jeune pour penser √† mes obs√®ques. On verra plus tard quand je serai vieux.", "response": "On esp√®re tous vivre tr√®s longtemps ! Mais un accident ou une maladie peuvent malheureusement survenir √† tout √¢ge. Souscrire t√¥t, ce n'est pas √™tre pessimiste, c'est justement profiter de sa jeunesse pour payer de toutes petites cotisations et √™tre tranquille pour des d√©cennies. En plus, plus on s'y prend jeune, plus c'est facile √† financer sans s'en apercevoir . Et si, Dieu vous pr√©serve, il arrivait quelque chose, vos proches n'auraient rien √† g√©rer financi√®rement. Vous gagnez en s√©r√©nit√© et vos proches aussi, quoi qu'il arrive.", "punchline": "La tranquillit√© d'esprit n'attend pas le nombre des ann√©es : pr√©voir t√¥t, c'est √™tre serein longtemps.", "value": "Cotisation r√©duite lorsqu'on souscrit jeune; capital garanti d√®s le premier jour (m√™me en cas de d√©c√®s pr√©matur√©, le service est assur√©); soulagement anticip√© pour la famille, sans attendre un √¢ge avanc√© pour se poser la question."}, {"product": "Assurance Obs√®ques", "situation": "Famille", "objection": "J'ai le temps, je penserai √† tout √ßa plus tard. Pour l'instant j'ai d'autres priorit√©s.", "response": "C'est normal d'avoir d'autres priorit√©s. Justement, l'assurance obs√®ques, une fois mise en place, vous n'avez plus √† y penser . C'est une chose de r√©gl√©e, qui ne vous emp√™chera pas de vivre vos priorit√©s actuelles. Et plus tard arrive plus vite qu'on ne croit : pr√©voir maintenant, c'est √©viter √† vos proches de devoir g√©rer cela dans l'urgence ou dans un moment difficile. En faisant ce petit effort maintenant, vous vous lib√©rez l'esprit pour la suite.", "punchline": "Pr√©voir l'in√©vitable aujourd'hui, pour se consacrer pleinement √† la vie d√®s maintenant.", "value": "D√©marche ponctuelle (un contrat et on n'en parle plus); √©vite une organisation pr√©cipit√©e et stressante au dernier moment; assure que tout sera pr√™t quand le moment viendra, sans perturber la vie actuelle."}, {"product": "Assurance Obs√®ques", "situation": "Famille", "objection": "Au lieu de payer une assurance, je peux mettre de l'argent de c√¥t√© sur un livret, √ßa reviendra au m√™me.", "response": "Mettre de l'argent de c√¥t√©, c'est bien, mais en cas de d√©c√®s pr√©matur√©, aurez-vous eu le temps d'√©pargner assez ? L'assurance obs√®ques, elle, garantit d√®s la souscription le capital n√©cessaire, m√™me si vous n'avez pay√© qu'une partie. De plus, cet argent est sp√©cifiquement r√©serv√© aux fun√©railles et disponible imm√©diatement pour vos proches, alors que votre livret pourrait √™tre bloqu√© le temps de la succession. C'est une s√©curit√© en plus : vous √©pargnez sans risque que l'effort ne serve √† rien, et vos proches n'auront aucune d√©marche financi√®re √† faire.", "punchline": "√âpargner soi-m√™me prend du temps, l'assurance obs√®ques prot√®ge vos proches tout de suite.", "value": "Protection imm√©diate (capital vers√© quels que soient les versements effectu√©s); fonds d√©bloqu√©s rapidement pour payer les frais fun√©raires; capital d√©di√© qui ne peut pas √™tre utilis√© √† autre chose ou saisi par l'h√©ritage avant le paiement des obs√®ques.1. 2. 3. 19"}, {"product": "Assurance Obs√®ques", "situation": "Famille", "objection": "J'ai d√©j√† une assurance vie (ou d√©c√®s), √ßa couvrira les frais d'obs√®ques.", "response": "C'est bien d'avoir une assurance vie/d√©c√®s, mais le contrat obs√®ques a l'avantage d'√™tre sp√©cifiquement con√ßu pour ce moment-l√†. D'abord, le capital obs√®ques est vers√© tr√®s rapidement aux pompes fun√®bres ou aux b√©n√©ficiaires pour r√©gler les frais, souvent en 48h, alors qu'une assurance vie peut prendre un peu plus de temps √† se d√©bloquer . Ensuite, avec l'assurance obs√®ques vous pouvez organiser vos volont√©s fun√©raires √† l'avance : choix de cr√©mation ou inhumation, type de c√©r√©monie‚Ä¶ Ce n'est pas possible avec une assurance vie classique. En somme, votre assurance vie aidera financi√®rement vos proches, mais l'assurance obs√®ques les d√©charge de toute pr√©occupation li√©e √† l'organisation et au financement de vos fun√©railles.", "punchline": "Assurance vie pour les leurs, assurance obs√®ques pour le dernier adieu : deux soutiens compl√©mentaires pour vos proches.", "value": "Versement express du capital au moment du d√©c√®s (pas d'attente prolong√©e); services d'assistance et respect des volont√©s fun√©raires int√©gr√©s; √©vite d'entamer le capital destin√© √† la vie courante des proches (l'assurance vie reste pour eux, l'obs√®ques couvre le rite final)."}, {"product": "Assurance Obs√®ques", "situation": "Famille", "objection": "Je n'ai pas besoin de planifier √ßa, ma famille se d√©brouillera bien le moment venu.", "response": "Votre famille fera certainement de son mieux, mais ce sera un moment tr√®s √©prouvant pour eux. En planifiant √† l'avance, vous leur √©vitez de prendre des d√©cisions difficiles sous le choc et de porter le poids financier des fun√©railles. C'est un dernier service que vous leur rendez : ils pourront se consacrer au recueillement sans se demander qui paiera quoi, ni quelles √©taient vos volont√©s. C'est une preuve d'amour de plus que vous leur donnez en facilitant les choses.", "punchline": "√âpargner √† sa famille des soucis le jour venu, c'est l'ultime preuve d'amour .", "value": "Soulagement du fardeau organisationnel et financier pour la famille; assurance que vos volont√©s seront respect√©es (vous pouvez les formuler √† l'avance); √©vite tensions familiales potentielles sur les choix ou les d√©penses."}, {"product": "Assurance Obs√®ques", "situation": "S√©nior", "objection": "J'ai d√©j√† mis de l'argent de c√¥t√© expr√®s pour mes fun√©railles, dans un compte √©pargne.", "response": "C'est une bonne pr√©caution. Toutefois, sachez qu'un compte √©pargne peut √™tre bloqu√© au moment du d√©c√®s, alors que l'assurance obs√®ques garantit un versement imm√©diat pour r√©gler les frais. Par ailleurs, avez-vous pu estimer si l'argent mis de c√¥t√© suffira dans X ann√©es, en tenant compte de l'augmentation des co√ªts fun√©raires ? Notre contrat peut √™tre index√© pour suivre l'inflation des obs√®ques. Et surtout, il apporte un service d'assistance : vos proches n'auront pas √† courir partout, un conseiller les accompagnera pour tout organiser selon vos souhaits. Votre √©pargne est utile, mais l'assurance apporte en plus la simplicit√© et la certitude.", "punchline": "De l'argent de c√¥t√©, c'est bien. Accompagn√© d'un contrat obs√®ques, c'est mieux : vos √©conomies + notre assistance = tranquillit√© totale.", "value": "Capital revaloris√© pour maintenir son pouvoir d'achat face √† l'augmentation du co√ªt des obs√®ques; assistance organisationnelle professionnelle pour les proches; garantie contractuelle que le financement des fun√©railles est op√©rationnel imm√©diatement.4. 5. 6. 20"}, {"product": "Assurance Obs√®ques", "situation": "S√©nior", "objection": "J'ai d√©j√† souscrit un contrat obs√®ques il y a des ann√©es.", "response": "Tr√®s bien, vous avez eu raison. Il peut toutefois √™tre utile de le r√©√©valuer : les co√ªts des fun√©railles augmentent avec le temps. Le capital pr√©vu il y a 15 ans sera-t-il suffisant aujourd'hui ? Nous proposons de v√©rifier gratuitement si votre couverture correspond toujours √† vos volont√©s et aux tarifs actuels. Parfois, on conseille de l'ajuster ou de le compl√©ter l√©g√®rement pour combler l'√©cart. Et puis, les contrats ont √©volu√© : les nouveaux incluent par exemple plus de services d'accompagnement administratif pour la famille. En faisant un point, vous vous assurez que tout est toujours optimal.", "punchline": "Un contrat obs√®ques, √ßa se garde √† jour comme un carnet de sant√© : v√©rifiez, ajustez, et restez serein.", "value": "Audit offert de la solution existante (v√©rification du capital par rapport aux co√ªts actuels); possibilit√© d'am√©liorer la prestation (ajout de services d'assistance modernes, revalorisation du capital); compl√©ment souple si n√©cessaire sans repartir de z√©ro."}, {"product": "Assurance Obs√®ques", "situation": "S√©nior", "objection": "Si je vis tr√®s longtemps, je risque de payer beaucoup plus que le co√ªt de mes obs√®ques au final.", "response": "Avec nos formules, vous pouvez justement √©viter cela. Par exemple, vous pouvez opter pour une cotisation sur 10 ou 15 ans seulement : une fois cette p√©riode pay√©e, vous √™tes couvert √† vie, m√™me si vous vivez jusqu'√† 100 ans, sans cotiser au-del√†. Et si vous pr√©f√©rez cotiser un peu chaque mois √† vie, gardez en t√™te que votre capital est revaloris√©, et que vous payez pour la tranquillit√© d'esprit. Quoi qu'il en soit, on peut adapter le mode de cotisation pour qu'il soit √©quitable. Le but n'est pas de payer ind√©finiment, c'est de garantir la somme voulue au bon moment, au meilleur co√ªt.", "punchline": "Vivez aussi longtemps que le destin vous le donne : vous aurez pay√© le juste prix, ni plus ni moins, pour que tout soit r√©gl√©.", "value": "Choix du mode de cotisation (viag√®re ou temporaire) en fonction de l'√¢ge et des pr√©f√©rences; option de primes temporaires pour ne plus rien payer pass√© un certain √¢ge; revalorisation du capital pour correspondre aux frais r√©els le moment venu."}, {"product": "Assurance Obs√®ques", "situation": "S√©nior", "objection": "Je pr√©f√®re prendre un contrat obs√®ques directement chez un op√©rateur fun√©raire, au moins tout sera planifi√© avec eux.", "response": "Les contrats obs√®ques en prestations chez les pompes fun√®bres sont bien, mais ils vous lient √† un prestataire unique. Avec notre assurance obs√®ques, vous pouvez tout planifier aussi (choix de cr√©mation/inhumation, c√©r√©monie...), et au moment venu vos proches auront la libert√© de choisir l'entreprise de pompes fun√®bres qui convient le mieux (proximit√©, r√©putation). Le capital sera vers√© √† celle qu'ils choisiront. C'est plus flexible : si l'entreprise fun√©raire initiale n'existe plus dans 20 ans ou si vous d√©m√©nagez loin, pas de souci, l'assurance s'adapte. Vous avez la planification ET la libert√©.", "punchline": "Planifiez vos obs√®ques sans vous lier les mains : votre assurance vous suit o√π que vous soyez, avec qui que ce soit.", "value": "Libert√© de choix du prestataire au moment du d√©c√®s (pas de d√©pendance √† un acteur unique); possibilit√© d'exprimer ses volont√©s √† l'avance autant qu'avec un contrat en prestations; garantie financi√®re utilisable par n'importe quelle soci√©t√© de pompes fun√®bres, ce qui prot√®ge contre les al√©as (changement de r√©gion, √©volution du march√© fun√©raire).7. 8. 9. 21"}, {"product": "Assurance Obs√®ques", "situation": "S√©nior", "objection": "Franchement, je ne veux m√™me pas penser √† tout √ßa. C'est trop d√©primant.", "response": "Je comprends tout √† fait. C'est difficile d'aborder ce sujet. Mais dites-vous que faire ce geste maintenant, c'est vous lib√©rer l'esprit ensuite. Une fois l'organisation financi√®re r√©gl√©e, vous n'aurez plus besoin d'y penser du tout, vous pouvez profiter de la vie en √©tant soulag√© de savoir que ce moment, quand il viendra le plus tard possible, ne causera pas de soucis √† vos proches. On fait √ßa une fois, puis on n'en parle plus. Vous pourrez aborder chaque jour avec la tranquillit√© d'esprit que tout est pr√©vu.", "punchline": "Pr√©voir ses obs√®ques, c'est un peu comme √©crire un testament d'amour : on le fait une fois, puis on profite du reste de sa vie l'esprit l√©ger .", "value": "D√©marche unique et ensuite plus besoin d'y revenir; all√®gement du souci moral pour l'assur√© (il sait que tout est pris en charge); accompagnement humain et bienveillant lors de la souscription pour rendre le processus aussi doux que possible. Les raisons de ne pas ouvrir un Plan Epargne Retraite - Meilleurtaux Placement https://placement.meilleurtaux.com/retraite/actualites/2024-octobre/objections-per-les-raisons-de-ne-pas-ouvrir-un-plan- epargne-retraite.html Comment fonctionne l‚Äôassurance vie en cas de d√©c√®s du souscripteur ? | CNP Assurances https://www.cnp.fr/particuliers/le-mag/comment-fonctionne-l-assurance-vie-en-cas-de-deces-du-souscripteur Achat immobilier : pouvez-vous changer d‚Äôassurance emprunteur ? | Minist√®re de l‚Äô√âconomie des Finances et de la Souverainet√© industrielle et num√©rique https://www.economie.gouv.fr/particuliers/emprunter-et-sassurer/achat-immobilier-pouvez-vous-changer-dassurance- emprunteur Assurance emprunteur : questionnaire de sant√©, quand est-ce obligatoire ? | Minist√®re de l‚Äô√âconomie des Finances et de la Souverainet√© industrielle et num√©rique https://www.economie.gouv.fr/particuliers/emprunter-et-sassurer/assurance-emprunteur-questionnaire-de-sante-quand- est-ce10. 1 2 3 4 5 22"}];

  const $ = sel => root.querySelector(sel);
  const els = {
    q: $('.q'),
    prod: $('.prod'),
    sit: $('.sit'),
    add: $('.add'),
    importBtn: $('.import'),
    exportBtn: $('.export'),
    resetBtn: $('.reset'),
    cards: root.querySelector('.cards')
  };

  const STORAGE_KEY = 'arg.cards.v1';
  function loadCards(){
    try{
      const j = localStorage.getItem(STORAGE_KEY);
      if(j){ const arr = JSON.parse(j); if(Array.isArray(arr)) return arr; }
    }catch(e){}
    localStorage.setItem(STORAGE_KEY, JSON.stringify(DATA_FROM_PDF));
    return DATA_FROM_PDF.slice();
  }
  function saveCards(list){ localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }

  let cards = loadCards();

  function fillFilters(){
    const products = Array.from(new Set(cards.map(c=>c.product))).filter(Boolean).sort();
    els.prod.innerHTML = ['<option value="">Tous produits</option>'].concat(products.map(p=>`<option>${p}</option>`)).join('');
    const situations = Array.from(new Set(cards.map(c=>c.situation))).filter(Boolean).sort();
    els.sit.innerHTML = ['<option value="">Toutes situations</option>'].concat(situations.map(s=>`<option>${s}</option>`)).join('');
  }

  function esc(s){ return String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]||c)); }

  function render(){
    const q = (els.q.value||'').toLowerCase();
    const prod = els.prod.value||'';
    const sit = els.sit.value||'';
    const filtered = cards.filter(c=>{
      const hay = (c.product+' '+c.situation+' '+c.objection+' '+c.response+' '+c.punchline+' '+c.value).toLowerCase();
      if(q && !hay.includes(q)) return false;
      if(prod && c.product !== prod) return false;
      if(sit && c.situation !== sit) return false;
      return true;
    });
    els.cards.innerHTML = filtered.map((c,idx)=>`
      <article class="card" data-idx="${idx}" style="display:flex; flex-direction:column; gap:8px">
        <div class="row" style="justify-content:space-between; align-items:center">
          <div style="display:flex; gap:6px; flex-wrap:wrap">
            <span class="badge">${esc(c.product)}</span>
            <span class="badge">${esc(c.situation)}</span>
          </div>
          <div class="actions">
            <button class="btn btn-ghost edit" data-idx="${idx}">‚úèÔ∏è Modifier</button>
            <button class="btn btn-danger del" data-idx="${idx}">üóë Supprimer</button>
          </div>
        </div>
        <div>
          <div class="small" style="opacity:.8; text-transform:uppercase; letter-spacing:.08em">Objection</div>
          <div style="font-weight:700">${esc(c.objection)}</div>
        </div>
        <div>
          <div class="small" style="opacity:.8; text-transform:uppercase; letter-spacing:.08em">R√©ponse</div>
          <div class="details">${esc(c.response)}</div>
        </div>
        <div>
          <div class="small" style="opacity:.8; text-transform:uppercase; letter-spacing:.08em">Punchline</div>
          <div style="font-style:italic">${esc(c.punchline)}</div>
        </div>
        <div>
          <div class="small" style="opacity:.8; text-transform:uppercase; letter-spacing:.08em">Valeur ajout√©e</div>
          <div class="details">${esc(c.value)}</div>
        </div>
      </article>
    `).join('');
  }

  function promptCard(initial){
    const base = Object.assign({product:'', situation:'', objection:'', response:'', punchline:'', value:''}, initial||{});
    const product = prompt('Produit (ex: Sant√©, GAV, D√©c√®s, PER, AV, Obs√®ques, Emprunteur)', base.product); if(product===null) return null;
    const situation = prompt('Situation (ex: Famille, S√©nior, Jeune)', base.situation); if(situation===null) return null;
    const objection = prompt('Objection', base.objection); if(objection===null) return null;
    const response = prompt('R√©ponse', base.response); if(response===null) return null;
    const punchline = prompt('Punchline', base.punchline||''); if(punchline===null) return null;
    const value = prompt('Valeur ajout√©e (points cl√©s)', base.value||''); if(value===null) return null;
    return {product:product.trim(), situation:situation.trim(), objection:objection.trim(), response:response.trim(), punchline:(punchline||'').trim(), value:(value||'').trim()};
  }

  els.cards.addEventListener('click', (e)=>{
    const b = e.target.closest('button'); if(!b) return;
    const idx = Number(b.dataset.idx);
    if(b.classList.contains('del')){
      if(confirm('Supprimer cette carte ?')){ cards.splice(idx,1); saveCards(cards); render(); fillFilters(); }
    }else if(b.classList.contains('edit')){
      const edited = promptCard(cards[idx]);
      if(edited){ cards[idx] = edited; saveCards(cards); render(); fillFilters(); }
    }
  });

  els.add.addEventListener('click', ()=>{
    const c = promptCard({product: els.prod.value||'', situation: els.sit.value||''});
    if(c){ cards.unshift(c); saveCards(cards); render(); fillFilters(); }
  });

  els.exportBtn && els.exportBtn.addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(cards, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'argumentaires_cartes.json'; a.click(); URL.revokeObjectURL(url);
  });

  els.importBtn && els.importBtn.addEventListener('click', ()=>{
    const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
    inp.onchange = async () => {
      const f = inp.files && inp.files[0]; if(!f) return;
      try{ const text = await f.text(); const arr = JSON.parse(text); if(!Array.isArray(arr)) throw new Error('JSON invalide');
        cards = arr.map(x => ({ product:String(x.product||'').trim(), situation:String(x.situation||'').trim(), objection:String(x.objection||'').trim(), response:String(x.response||'').trim(), punchline:String(x.punchline||'').trim(), value:String(x.value||'').trim() }));
        saveCards(cards); fillFilters(); render();
      }catch(err){ alert('Import JSON impossible: ' + err); }
    };
    inp.click();
  });

  els.resetBtn && els.resetBtn.addEventListener('click', ()=>{
    if(confirm('R√©initialiser la biblioth√®que avec les cartes PDF d‚Äôorigine ? Toutes vos modifications locales seront perdues.')){
      cards = DATA_FROM_PDF.slice(); saveCards(cards); fillFilters(); render();
    }
  });

  [els.q, els.prod, els.sit].forEach(el => el && el.addEventListener('input', render));

  fillFilters();
  render();
}


/* ===== Bilan Pr√©voyance (jeu de plateau) ===== */
function buildBilanPanel(){
  const root = document.getElementById('bilan');
  root.innerHTML = `
  <div class="grid">
    <section class="card" style="grid-column: span 12">
      <h3 class="section-title">Bilan Pr√©voyance ‚Äî "ch√¢teau & attaques"</h3>
      <div class="row" style="gap:8px; flex-wrap:wrap">
        <input class="fam" placeholder="Profil famille (ex: mari√©, 2 enfants, revenus 3k‚Ç¨)" style="min-width:320px" />
        <button class="btn btn-ghost capture">Capturer</button>
        <button class="btn btn-ghost export">Export PDF</button>
        <button class="btn btn-ghost reset">Reset</button>
      </div>
      <div class="hr"></div>

      <div class="board" style="display:grid; grid-template-columns: 1fr 1fr; gap:12px">
        <div class="castle card" style="min-height:320px; border:2px dashed var(--border);">
          <h4>Zone Client (int√©rieur du ch√¢teau)</h4>
          <div class="drop inside" style="min-height:220px; display:flex; flex-wrap:wrap; gap:8px; align-content:flex-start"></div>
        </div>
        <div class="field card" style="min-height:320px;">
          <h4>Attaques de la vie (ext√©rieur)</h4>
          <div class="threats" style="display:flex; flex-wrap:wrap; gap:8px"></div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="row" style="gap:8px; flex-wrap:wrap">
        <div class="card" style="flex:1">
          <h4>D√©fenses disponibles</h4>
          <div class="defenses" style="display:flex; flex-wrap:wrap; gap:8px"></div>
        </div>
        <div class="card" style="flex:1">
          <h4>R√©sum√© des gaps</h4>
          <div class="gaps"></div>
        </div>
      </div>
    </section>
  </div>`;

  const threats = [
    {id:'accident', label:'Accident'},
    {id:'maladie', label:'Maladie grave'},
    {id:'deces', label:'D√©c√®s'},
    {id:'invalidite', label:'Invalidit√©'},
    {id:'dependance', label:'Perte d‚Äôautonomie'},
    {id:'hospitalisation', label:'Hospitalisation co√ªteuse'}
  ];

  const defenses = [
    {id:'sante', label:'Compl√©mentaire Sant√©'},
    {id:'gav', label:'GAV'},
    {id:'deces', label:'Assurance D√©c√®s'},
    {id:'obs', label:'Obs√®ques'},
    {id:'av', label:'Assurance Vie'},
    {id:'per', label:'PER'},
    {id:'epargne', label:'√âpargne dispo'},
    {id:'revenu', label:'Revenus du foyer'}
  ];

  const dropInside = root.querySelector('.drop.inside');
  const elThreats = root.querySelector('.threats');
  const elDefs = root.querySelector('.defenses');
  const elGaps = root.querySelector('.gaps');

  function pill(text, cls){
    const d = document.createElement('div');
    d.textContent = text;
    d.className = 'pill ' + (cls||'');
    d.draggable = true;
    d.style.cssText = 'border:1px solid var(--border); border-radius:9999px; padding:6px 10px; cursor:grab; user-select:none;';
    d.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', text); e.dataTransfer.setData('type', cls||''); });
    return d;
  }

  // Render threats & defenses
  threats.forEach(t => elThreats.appendChild(pill(t.label, 'threat '+t.id)));
  defenses.forEach(d => elDefs.appendChild(pill(d.label, 'def '+d.id)));

  // Drag & drop support
  ;[dropInside, elDefs, elThreats].forEach(zone => {
    zone.addEventListener('dragover', e => { e.preventDefault(); zone.style.background='rgba(0,0,0,0.03)'; });
    zone.addEventListener('dragleave', ()=> zone.style.background='');
    zone.addEventListener('drop', e => {
      e.preventDefault(); zone.style.background='';
      const txt = e.dataTransfer.getData('text/plain');
      const node = pill(txt, e.dataTransfer.getData('type'));
      zone.appendChild(node);
      updateGaps();
    });
  });

  // Simple coverage rules
  function has(label){
    return Array.from(dropInside.querySelectorAll('.pill')).some(p => p.textContent===label);
  }

  function updateGaps(){
    const cov = {
      accident: has('GAV'),
      maladie: has('Compl√©mentaire Sant√©'),
      deces: has('Assurance D√©c√®s') || has('Assurance Vie'),
      invalidite: has('GAV') || has('Assurance D√©c√®s'),
      dependance: has('Assurance D√©c√®s') || has('√âpargne dispo'),
      hospitalisation: has('Compl√©mentaire Sant√©') && has('√âpargne dispo')
    };
    const items = threats.map(t => {
      const ok = cov[t.id];
      return `<div class="row" style="justify-content:space-between">
        <div>${t.label}</div>
        <div class="badge" style="background:${ok?'var(--ok)':'var(--warn)'}">${ok?'Couvert':'Gap'}</div>
      </div>`;
    }).join('');
    elGaps.innerHTML = items + `<div class="small" style="margin-top:8px;opacity:.7">R√®gles simplifi√©es. √Ä affiner avec l‚Äôargumentaire.</div>`;
  }

  // Capture & export (via html2canvas + jsPDF si dispo)
  root.querySelector('.capture').addEventListener('click', async ()=>{
    if(window.html2canvas){
      const shotTarget = root.querySelector('.board');
      const canvas = await html2canvas(shotTarget);
      const img = canvas.toDataURL('image/png');
      const w = window.open(''); w.document.write('<img src="'+img+'" style="width:100%">');
    }else{
      alert('html2canvas non charg√© (capture non disponible hors-ligne).');
    }
  });

  root.querySelector('.export').addEventListener('click', async ()=>{
    if(window.jspdf && window.html2canvas){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:'pt', format:'a4'});
      const board = root.querySelector('.board');
      const canvas = await html2canvas(board);
      const img = canvas.toDataURL('image/png');
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      const aspect = canvas.width / canvas.height;
      const imgW = pageW - 40, imgH = imgW / aspect;
      doc.text('Bilan Pr√©voyance ‚Äî Avant/Apr√®s', 40, 40);
      doc.addImage(img, 'PNG', 20, 60, imgW, imgH);
      doc.save('bilan_prevoyance.pdf');
    }else{
      alert('jsPDF/html2canvas non charg√©s (export indisponible hors connexion CDN).');
    }
  });

  root.querySelector('.reset').addEventListener('click', ()=>{
    dropInside.innerHTML=''; updateGaps();
  });

  updateGaps();
}




/* ===== PER ‚Äî Simulateur (int√©gr√©) ===== */
function buildPERPanel(){
  const root = document.getElementById('per');
  if(!root) return;
  root.innerHTML = `
    <div class="grid">
      <section class="card" style="grid-column: span 12">
        <div class="row" style="justify-content:space-between; align-items:center">
          <h3 class="section-title">Simulateur PER ‚Äî Pro+</h3>
          <span class="small">Charg√© via fichier externe (m√™me dossier) ‚Ä¢ recommand√© pour l'h√©bergement en ligne</span>
        </div>
        <div class="small" id="per-status" style="opacity:.8;margin-bottom:8px">V√©rification du fichier‚Ä¶</div>
        <div style="height:1600px; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#0b1020">
          <iframe id="per-sim" title="Simulateur PER" style="width:100%; height:100%; border:0; background:#0b1020"></iframe>
        </div>
        <div class="row" style="margin-top:10px">
          <a id="per-direct-link" class="btn" href="#" target="_blank" rel="noopener">Ouvrir le simulateur PER dans un nouvel onglet</a>
        </div>
      </section>
    </div>`;
  const perPath = './Simulateur_PER_ProPlus_v5_4_topoUnder_fixSortie.html';
  const statusEl = document.getElementById('per-status');
  const linkEl = document.getElementById('per-direct-link');
  linkEl.href = perPath;
  const fram = document.getElementById('per-sim');
  (async () => {
    try {
      const r = await fetch(perPath, { method: 'HEAD' });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      statusEl.textContent = 'Chargement du simulateur‚Ä¶';
      fram.src = perPath;
    } catch (err) {
      statusEl.innerHTML = 'Impossible de charger le simulateur PER. ' +
        'V√©rifiez que le fichier <code>Simulateur_PER_ProPlus_v5_4_topoUnder_fixSortie.html</code> ' +
        'se trouve au <b>m√™me niveau</b> que <code>index.html</code> et que le nom est <b>exact</b>.' +
        '<br>Erreur : ' + String(err);
      const tips = document.createElement('div');
      tips.className = 'small';
      tips.style.marginTop = '8px';
      tips.innerHTML = '<ul>' +
        '<li>Dans GitHub ‚Üí Code, v√©rifiez que vous voyez bien les 2 fichiers c√¥te √† c√¥te.</li>' +
        '<li>Sur la page, essayez d‚Äôouvrir le lien ci-dessus ‚ÄúOuvrir le simulateur PER‚Ä¶‚Äù : si 404, le fichier manque ou le nom diff√®re.</li>' +
        '<li>Si vous venez de l‚Äôajouter, attendez 30‚Äì60 s que GitHub Pages se mette √† jour.</li>' +
        '</ul>';
      root.querySelector('section.card').appendChild(tips);
      console.error(err);
    }
  })();
}
/* ===== Assurance Vie ‚Äî Simulateur (int√©gr√©) ===== */
function buildAVPanel(){
  const root = document.getElementById('av');
  root.innerHTML = `
    <div class="grid">
      <section class="card" style="grid-column: span 12">
        <h3 class="section-title">Simulateur Assurance Vie ‚Äî Comparatif & Trajectoire</h3>
        <div class="small" style="opacity:.8;margin-bottom:8px">Chargement du simulateur (fichier externe)‚Ä¶</div>
        <div style="height:820px; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#0b1020">
          <iframe id="av-sim" title="Simulateur AV" style="width:100%; height:100%; border:0; background:#0b1020"></iframe>
        </div>
        <div style="margin-top:10px; display:flex; justify-content:flex-end;">
          <a href="simulateur_assurance_vie_standalone.html" target="_blank" style="text-decoration:none;">
            <button class="btn">Ouvrir le simulateur Assurance Vie en plein √©cran</button>
          </a>
        </div>
      </section>
    </div>`;
  try {
    const doc = document.getElementById('av-sim');
    // Use data URL to keep single-file packaging
    doc.src = 'simulateur_assurance_vie_standalone.html';
  } catch(e) {
    root.querySelector('.small').textContent = '√âchec du chargement : ' + (e && e.message ? e.message : e);
  }
}

window.addEventListener('beforeunload', ()=>{
  try {
    const per = document.getElementById('per');
    if(per && per.__perCleanup) per.__perCleanup();
  } catch(e){}
});
</script>
<script>
try{
  window.CASES = (window.CASES||[]).concat([{"id": "A1", "cible": "Ado", "titre": "Ado ‚Äì rupture LCA (sport)", "types": ["Sport", "Ado", "Genou"], "resume": "Rupture du ligament crois√© ant√©rieur, chirurgie + r√©√©ducation longue.", "sans": {"resteMedical": 0, "pertesRevenus": 0, "annexes": 1000}, "gav": {"ip": {"taux": 8, "montant": 29440}, "souff": 4000, "esthet": 0, "hosp": 200, "pertesRevenus": 0, "prothese": 0, "logement": 0, "fauteuil": 0, "autres": 0}, "tags": ["Chirurgie du genou", "R√©√©duc 6‚Äì9 mois", "Hospi 4 j"]}, {"id": "A2", "cible": "Ado", "titre": "Ado ‚Äì entorse s√©v√®re cheville", "types": ["Sport", "Ado", "Cheville"], "resume": "Entorse grave avec ligaments d√©chir√©s, immobilisation et r√©√©ducation.", "sans": {"resteMedical": 0, "pertesRevenus": 0, "annexes": 100}, "gav": {"ip": {"taux": 3, "montant": 0}, "souff": 0, "esthet": 0, "hosp": 0, "pertesRevenus": 0, "prothese": 0, "logement": 0, "fauteuil": 0, "autres": 0}, "tags": ["Pl√¢tre 6 sem.", "R√©√©duc 2 mois"]}, {"id": "A3", "cible": "Ado", "titre": "Ado ‚Äì fracture du poignet (roller)", "types": ["Ado", "Bras", "Sport"], "resume": "Fracture du poignet droit, broches et r√©√©ducation.", "sans": {"resteMedical": 0, "pertesRevenus": 0, "annexes": 200}, "gav": {"ip": {"taux": 4, "montant": 0}, "souff": 0, "esthet": 0, "hosp": 0, "pertesRevenus": 0, "prothese": 0, "logement": 0, "fauteuil": 0, "autres": 0}, "tags": ["Chirurgie", "Cicatrice poignet", "Pl√¢tre 8 sem."]}, {"id": "A4", "cible": "Ado", "titre": "Ado ‚Äì dent cass√©e (match)", "types": ["Ado", "Dentaire", "Sport"], "resume": "Choc au visage, 1 incisive permanente cass√©e.", "sans": {"resteMedical": 0, "pertesRevenus": 0, "annexes": 400}, "gav": {"ip": {"taux": 2, "montant": 0}, "souff": 0, "esthet": 0, "hosp": 0, "pertesRevenus": 0, "prothese": 0, "logement": 0, "fauteuil": 0, "autres": 0}, "tags": ["Couronne dentaire"]}, {"id": "A5", "cible": "Ado", "titre": "Ado ‚Äì fracture de la clavicule (VTT)", "types": ["Ado", "Sport", "√âpaule"], "resume": "Chute en VTT, fracture de la clavicule, cicatrice l√©g√®re.", "sans": {"resteMedical": 0, "pertesRevenus": 0, "annexes": 200}, "gav": {"ip": {"taux": 5, "montant": 18400}, "souff": 3000, "esthet": 1000, "hosp": 0, "pertesRevenus": 0, "prothese": 0, "logement": 0, "fauteuil": 0, "autres": 0}, "tags": ["Cicatrice √©paule", "Convalescence 2 mois"]}, {"id": "P1", "cible": "Adulte", "titre": "Parent ‚Äì chute d‚Äô√©chelle (bricolage)", "types": ["Adulte", "Chute", "Polytrauma"], "resume": "Fracture lombaire + jambe, s√©quelles dos, arr√™t 6 mois.", "sans": {"resteMedical": 0, "pertesRevenus": 4000, "annexes": 0}, "gav": {"ip": {"taux": 20, "montant": 73600}, "souff": 6500, "esthet": 0, "hosp": 500, "pertesRevenus": 4000, "prothese": 0, "logement": 0, "fauteuil": 0, "autres": 0}, "tags": ["Arr√™t 6 mois", "R√©√©duc lourde", "Hospi 10 j"]}, {"id": "P2", "cible": "Adulte", "titre": "Parent ‚Äì fracture d‚Äôun corps vert√©bral", "types": ["Adulte", "Dos", "Chute"], "resume": "Fracture vert√©brale suite au port d‚Äôune charge, chirurgie et r√©√©ducation.", "sans": {"resteMedical": 0, "pertesRevenus": 3000, "annexes": 0}, "gav": {"ip": {"taux": 10, "montant": 36800}, "souff": 5000, "esthet": 0, "hosp": 250, "pertesRevenus": 3000, "prothese": 0, "logement": 0, "fauteuil": 0, "autres": 0}, "tags": ["Chirurgie du dos", "Arr√™t 3 mois", "Hospi 5 j"]}, {"id": "P3", "cible": "Adulte", "titre": "Parent ‚Äì fracture du 5e m√©tacarpien", "types": ["Adulte", "Main", "Chute"], "resume": "Fracture main dominante, immobilisation et r√©√©ducation, baisse de force.", "sans": {"resteMedical": 0, "pertesRevenus": 1500, "annexes": 0}, "gav": {"ip": {"taux": 5, "montant": 18400}, "souff": 2000, "esthet": 0, "hosp": 0, "pertesRevenus": 1500, "prothese": 0, "logement": 0, "fauteuil": 0, "autres": 0}, "tags": ["Main dominante", "R√©√©duc 2 mois"]}, {"id": "P4", "cible": "Adulte", "titre": "Parent ‚Äì luxation de l‚Äô√©paule (sport)", "types": ["Adulte", "Sport", "√âpaule"], "resume": "Luxation avec atteinte capsulo-ligamentaire, instabilit√© r√©siduelle.", "sans": {"resteMedical": 0, "pertesRevenus": 2000, "annexes": 0}, "gav": {"ip": {"taux": 6, "montant": 22080}, "souff": 2500, "esthet": 0, "hosp": 150, "pertesRevenus": 2000, "prothese": 0, "logement": 0, "fauteuil": 0, "autres": 0}, "tags": ["Instabilit√© √©paule", "R√©√©duc 3 mois", "Hospi 3 j"]}, {"id": "P5", "cible": "Adulte", "titre": "Parent ‚Äì chute en trottinette (EDP)", "types": ["Adulte", "EDP", "Dentaire", "Visage"], "resume": "Chute sans tiers, 4 incisives cass√©es, soins dentaires lourds.", "sans": {"resteMedical": 0, "pertesRevenus": 0, "annexes": 1970}, "gav": {"ip": {"taux": 6, "montant": 22080}, "souff": 2000, "esthet": 0, "hosp": 0, "pertesRevenus": 0, "prothese": 0, "logement": 0, "fauteuil": 0, "autres": 1970}, "tags": ["Couronnes dentaires", "Chute sans tiers"]}]);
  document.querySelectorAll('#gav-cible').forEach(function(sel){
    var existAdo = Array.from(sel.options).some(o=>o.value==='Ado');
    if(!existAdo){ sel.insertAdjacentHTML('beforeend','<option value=\"Ado\">Ado</option><option value=\"Adulte\">Adulte</option>'); }
  });
  if(window.PriseGAV && typeof window.PriseGAV.force==='function'){ window.PriseGAV.force(); }
}catch(e){ console.warn('Injection MORE_CASES √©chou√©e:', e); }
</script>
</body>
</html>