<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Onglet Courrier ‚Äì G√©n√©rateur de lettres (v8 ‚Äì assureurs + recherche)</title>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" />
<style>
  :root { --bg:#0b1020; --fg:#e9eef7; --muted:#a9b4c4; --card:#121a33; --accent:#4da3ff; --border:#223156; }
  html,body {height:100%;}
  body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Helvetica Neue",sans-serif; background:var(--bg); color:var(--fg); }
  .wrap {max-width:1200px; margin:auto; padding:24px;}
  h1 {font-size:20px; margin:0 0 16px;}
  .grid {display:grid; gap:16px; grid-template-columns:380px 1fr;}
  .card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; }
  .card h2 {font-size:16px; margin:0 0 12px; color:var(--fg);}
  label {display:block; font-size:12px; color:var(--muted); margin:10px 0 6px;}
  input,select,textarea { width:100%; box-sizing:border-box; background:#0e1630; color:#fff; border:1px solid var(--border); border-radius:10px; padding:10px; font:inherit; }
  textarea {min-height:84px; resize:vertical;}
  .row {display:grid; gap:10px; grid-template-columns:1fr 1fr;}
  .btns {display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
  button { border:1px solid var(--border); background:#122043; color:var(--fg); border-radius:999px; padding:10px 14px; cursor:pointer; }
  button.primary { background:var(--accent); color:#04162b; border-color:#3d7fcc; font-weight:600; }
  .muted {color:var(--muted); font-size:12px;}
  .preview { background:#fff; color:#111; border-radius:12px; overflow:hidden; border:1px solid #e6e6e6; }
  .sheet { width:210mm; min-height:297mm; padding:20mm; box-sizing:border-box; margin:auto; background:#ffffff; color:#111; font-family: Arial, Helvetica, sans-serif; font-size:12px; line-height:1.55; }
  .letterhead {display:flex; justify-content:space-between; font-size:12px; color:#333;}
  .letterhead strong {font-weight:700;}
  .block {margin-top:12px;}
  .subject {margin-top:12px; font-weight:700; font-size:14px;}
  .body p {margin:0 0 10px; line-height:1.5;}
  .addr { font-size:12px; }
  .footer {margin-top:24px; font-size:12px; color:#555;}
  .chips {display:flex; flex-wrap:wrap; gap:6px; margin: 8px 0 0;}
  .chip {font-size:11px; padding:6px 10px; border-radius:999px; background:#eef3ff; color:#0a1d3b; border:1px solid #cddfff;}
  .sticky {position:sticky; top:16px;}
  .row-3 {display:grid; gap:10px; grid-template-columns:1fr 1fr 1fr;}
  .kbd {font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; font-size:12px;}
  .note {background:#0e1630; border:1px dashed var(--border); border-radius:12px; padding:10px; color:#a9b4c4;}
  .pill-danger{background:#4b1e1e; border-color:#7a2b2b;}
  @media (max-width:980px){ .grid{grid-template-columns:1fr;} .sticky{position:static;} }
  @media print { body{background:#fff; color:#000;} .wrap,.card{padding:0; border:none; background:#fff;} .grid{display:block;} .no-print{display:none !important;} .sheet{width:auto; min-height:auto; padding:0; margin:0;} }
</style>
</head>
<body>
<div class="wrap">
  <h1>‚úâÔ∏è G√©n√©rateur de courriers ‚Äì Harmonie (v8)</h1>
  <div class="grid">
    <div class="card sticky">
      <h2>Mod√®le & variables</h2>
      <label for="templateSelect">Mod√®le de courrier</label>
      <select id="templateSelect"></select>
      <label for="tagFilter" style="margin-top:12px;">Filtrer par tag</label>
      <select id="tagFilter"></select>
      <div id="templateInfo" class="muted" style="margin-top:6px;"></div>
      <div class="chips" id="chips"></div>

      <div class="btns" style="margin-top:8px;">
        <button id="btnNew">Nouveau mod√®le</button>
        <button id="btnEdit">√âditer</button>
        <button id="btnClone">Cloner ‚Üí perso</button>
      </div>
      <div class="btns" style="margin-top:6px;">
        <button id="btnRemove" class="pill-danger">üóëÔ∏è Supprimer ce mod√®le (d√©finitif)</button>
      </div>
      <div class="btns" style="margin-top:6px;">
        <button id="btnExport">Exporter mes mod√®les</button>
        <button id="btnImport">Importer</button>
      </div>

      <div class="help">Variables entre {{‚Ä¶}} (ex. <span class="kbd">{{Contrat_Numero}}</span>).</div>

      <div class="row" style="margin-top:12px;">
        <div><label for="ville">Ville</label><input id="ville" placeholder="ex. Nantes" /></div>
        <div><label for="dateAuto">Date</label><input id="dateAuto" /></div>
      </div>

      <h2 style="margin-top:18px;">Exp√©diteur</h2>
      <label for="expNom">Nom & fonction</label><input id="expNom" placeholder="Pr√©nom NOM ‚Äì Fonction" />
      <label for="expOrg">Organisation</label><input id="expOrg" placeholder="Harmonie Mutuelle" />
      <label for="expAdr">Adresse</label><textarea id="expAdr" placeholder="Adresse (lignes)"></textarea>
      <div class="row">
        <div><label for="expTel">T√©l√©phone</label><input id="expTel" placeholder="+33 ..." /></div>
        <div><label for="expMail">E-mail</label><input id="expMail" placeholder="prenom.nom@..." /></div>
      </div>

      <label for="assureurSelect" style="margin-top:12px;">Assureur (optionnel)</label>
<select id="assureurSelect"></select>
<input id="assureurSearch" placeholder="Rechercher un assureur..." style="margin-top:8px;" />
<h2 style="margin-top:18px;">Destinataire</h2>
      <label for="destNom">Soci√©t√© / Service</label><input id="destNom" placeholder="Pacifica / Service r√©siliation" />
      <label for="destAttention">√Ä l‚Äôattention de</label><input id="destAttention" placeholder="Madame / Monsieur ..." />
      <label for="destAdr">Adresse</label><textarea id="destAdr" placeholder="Adresse (lignes)"></textarea>
<div id="dynamicFields"></div>

      <div class="btns">
        <button class="primary" id="btnPreview">Mettre √† jour l‚Äôaper√ßu</button>
        <button id="btnCopy">Copier le texte</button>
        <button id="btnPDF">T√©l√©charger en PDF</button>
        <button id="btnReset" class="no-print">R√©initialiser</button>
      </div>
      <div class="muted" style="margin-top:6px;">Les donn√©es sont stock√©es en local (localStorage).</div>
    </div>

    <div class="card">
      <h2>Aper√ßu</h2>
      <div class="preview" id="preview"><div class="sheet" id="sheet"></div></div>

      <div class="card" id="editorCard" style="margin-top:16px; display:none;">
        <h2>√âditeur de mod√®le</h2>
        <div class="note">Cr√©ez vos mod√®les avec variables <span class="kbd">{{Nom_Variable}}</span>.</div>
        <div class="row-3" style="margin-top:12px;">
          <div><label for="mdl_name">Nom du mod√®le</label><input id="mdl_name" placeholder="ex. Relance J+7 Devis sant√©"/></div>
          <div><label for="mdl_tags">Tags (virgules)</label><input id="mdl_tags" placeholder="sant√©, relance, devis"/></div>
          <div><label for="mdl_id">ID</label><input id="mdl_id" placeholder="auto" disabled /></div>
        </div>
        <label for="mdl_desc">Description</label><textarea id="mdl_desc" placeholder="Courte description du mod√®le"></textarea>
        <label for="mdl_subject">Sujet (objet du courrier)</label><input id="mdl_subject" placeholder="Objet : ..." />
        <label for="mdl_body">Corps</label><textarea id="mdl_body" style="min-height:160px;" placeholder="Texte du courrier..."></textarea>
        <div class="btns">
          <button id="mdl_save" class="primary">Enregistrer</button>
          <button id="mdl_cancel">Annuler</button>
          <button id="mdl_delete" style="display:none;">Supprimer</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- PDF libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ===== Mod√®les int√©gr√©s (liste r√©duite valid√©e) ===== */
const BUILTIN_TEMPLATES = [
  { id:"resiliation_etranger", label:"R√©siliation ‚Äì D√©part √† l‚Äô√©tranger (compl√©mentaire sant√©)", tags:["sant√©","r√©siliation"], description:"R√©siliation pour d√©part durable √† l‚Äô√©tranger.", subject:"Demande de r√©siliation ‚Äì D√©part √† l‚Äô√©tranger ‚Äì Contrat n¬∞ {{Contrat_Numero}}", body:`Madame, Monsieur,

Je vous informe de mon d√©part √† l‚Äô√©tranger √† compter du {{Date_Depart}} (pays : {{Pays}}), situation entra√Ænant un changement durable de ma situation.
Je vous demande en cons√©quence la r√©siliation de mon contrat de compl√©mentaire sant√© n¬∞ {{Contrat_Numero}}, au plus t√¥t √† compter de la r√©ception de ce courrier.

Je joins un justificatif (billet / attestation d‚Äôinstallation) et vous remercie de me confirmer par √©crit la date de r√©siliation et l‚Äôarr√™t des pr√©l√®vements.

Veuillez agr√©er, Madame, Monsieur, mes salutations distingu√©es.` },

  { id:"resiliation_echeance", label:"R√©siliation √† l‚Äô√©ch√©ance (compl√©mentaire sant√©)", tags:["sant√©","r√©siliation","√©ch√©ance"], description:"Non-reconduction √† la date anniversaire.", subject:"R√©siliation √† l‚Äô√©ch√©ance ‚Äì Contrat n¬∞ {{Contrat_Numero}} ‚Äì √âch√©ance du {{Date_Echeance}}", body:`Madame, Monsieur,

Je vous informe de ma volont√© de ne pas reconduire mon contrat de compl√©mentaire sant√© n¬∞ {{Contrat_Numero}} √† son √©ch√©ance du {{Date_Echeance}}.
Merci de m‚Äôadresser un √©crit confirmant la date de r√©siliation et l‚Äôarr√™t des pr√©l√®vements √† compter de cette √©ch√©ance.

Veuillez agr√©er, Madame, Monsieur, mes salutations distingu√©es.` },

  { id:"renonciation_gav", label:"Renonciation ‚Äì Garantie Accidents de la Vie (GAV)", tags:["GAV","renonciation"], description:"Droit de renonciation dans le d√©lai l√©gal apr√®s souscription.", subject:"Renonciation au contrat GAV n¬∞ {{Contrat_Numero}} (souscrit le {{Date_Souscription}})", body:`Madame, Monsieur,

J‚Äôexerce mon droit de renonciation au contrat Garantie Accidents de la Vie n¬∞ {{Contrat_Numero}}, souscrit le {{Date_Souscription}}.
Merci d‚Äôannuler le contrat et, le cas √©ch√©ant, de rembourser les sommes per√ßues. Je vous remercie de m‚Äôadresser une confirmation √©crite.

Veuillez agr√©er, Madame, Monsieur, mes salutations distingu√©es.` },

  { id:"resiliation_collectif_obligatoire", label:"R√©siliation ‚Äì Contrat collectif d‚Äôentreprise obligatoire", tags:["sant√©","r√©siliation","collectif"], description:"R√©siliation d‚Äôun contrat individuel apr√®s adh√©sion √† une mutuelle d‚Äôentreprise obligatoire.", subject:"R√©siliation pour adh√©sion √† une mutuelle d‚Äôentreprise ‚Äì Contrat n¬∞ {{Contrat_Numero}}", body:`Madame, Monsieur,

Je vous informe de mon adh√©sion au contrat collectif obligatoire de mon employeur {{Employeur}} √† compter du {{Date_Adhesion_Collectif}}.
Je vous demande en cons√©quence la r√©siliation de mon contrat sant√© individuel n¬∞ {{Contrat_Numero}}, √† effet du {{Date_Effet_Resiliation}} ou, √† d√©faut, √† la date de r√©ception du pr√©sent courrier.

Veuillez agr√©er, Madame, Monsieur, mes salutations distingu√©es.` },

  { id:"rachat_partiel_assurance_vie", label:"Demande de rachat partiel ‚Äì Assurance vie", tags:["assurance vie","rachat"], description:"Rachat partiel avec versement et option fiscale.", subject:"Demande de rachat partiel ‚Äì Contrat n¬∞ {{Contrat_Numero}} ‚Äì {{Montant}} ‚Ç¨", body:`Madame, Monsieur,

Je vous prie d‚Äôeffectuer un rachat partiel de {{Montant}} ‚Ç¨ (en lettres : {{Montant_En_Lettres}}) sur mon contrat n¬∞ {{Contrat_Numero}}.
Je souhaite un versement par virement sur l‚ÄôIBAN : {{IBAN}} (titulaire : {{Titulaire_Compte}}). Option fiscale souhait√©e : {{Option_Fiscale}}.
Merci de me transmettre un d√©compte pr√©alable et la confirmation d‚Äôex√©cution.

Veuillez agr√©er, Madame, Monsieur, mes salutations distingu√©es.` },

  { id:"versement_libre_exceptionnel", label:"Versement libre (AV ou PER) + instruction d‚Äôarbitrage", tags:["versement","√©pargne"], description:"Virement accompagn√© d‚Äôune r√©partition des supports.", subject:"Versement libre de {{Montant}} ‚Ç¨ sur contrat n¬∞ {{Contrat_Numero}}", body:`Madame, Monsieur,

Je vous informe avoir proc√©d√© √† un versement de {{Montant}} ‚Ç¨ en date du {{Date_Versement}} sur le contrat n¬∞ {{Contrat_Numero}} (r√©f√©rence : {{Reference_Virement}}).
Arbitrage souhait√© : {{Arbitrage_Souhaite}}. Merci de me transmettre la confirmation d‚Äôop√©ration.

Veuillez agr√©er, Madame, Monsieur, mes salutations distingu√©es.` },

  { id:"changement_rib_sepa", label:"Changement de RIB / mandat SEPA", tags:["SEPA","administratif"], description:"Mise √† jour des coordonn√©es bancaires et du mandat.", subject:"Mise √† jour RIB et mandat SEPA ‚Äì Contrat n¬∞ {{Contrat_Numero}}", body:`Madame, Monsieur,

Merci de mettre √† jour mes coordonn√©es bancaires pour les pr√©l√®vements du contrat n¬∞ {{Contrat_Numero}} √† compter du {{Date_Effet}}.
Nouveau RIB (IBAN) : {{IBAN}} ‚Äì Titulaire : {{Titulaire_Compte}}. Merci d‚Äô√©tablir le mandat SEPA correspondant.

Veuillez agr√©er, Madame, Monsieur, mes salutations distingu√©es.` },

  { id:"supp_ayant_droit_sante", label:"Suppression d‚Äôayant droit ‚Äì Contrat sant√©", tags:["sant√©","ayant droit"], description:"Retrait d‚Äôun ayant droit du contrat.", subject:"Suppression d‚Äôayant droit ‚Äì Contrat n¬∞ {{Contrat_Numero}} ‚Äì {{Nom_Ayant_Droit}}", body:`Madame, Monsieur,

Je vous demande la suppression de l‚Äôayant droit suivant sur mon contrat n¬∞ {{Contrat_Numero}} : {{Nom_Ayant_Droit}} (n√©(e) le {{Date_Naissance}} ‚Äì lien : {{Lien_Parente}}).
√âv√©nement d√©clencheur : {{Evenement}} (date : {{Date_Evenement}}). Je joins les justificatifs utiles.

Veuillez agr√©er, Madame, Monsieur, mes salutations distingu√©es.` },

  { id:"renonciation_per", label:"Renonciation ‚Äì PER (d√©lai l√©gal de 30 jours)", tags:["PER","renonciation"], description:"Droit de renonciation dans les 30 jours apr√®s souscription.", subject:"Renonciation au PER n¬∞ {{PER_Numero}} (souscrit le {{Date_Souscription}})", body:`Madame, Monsieur,

J‚Äôexerce mon droit de renonciation au PER n¬∞ {{PER_Numero}}, souscrit le {{Date_Souscription}}.
Merci d‚Äôannuler le contrat et de rembourser les sommes vers√©es, le cas √©ch√©ant, sur l‚ÄôIBAN : {{IBAN}}. Merci de m‚Äôadresser une confirmation √©crite.

Veuillez agr√©er, Madame, Monsieur, mes salutations distingu√©es.` },

  { id:"renonciation_neobsia", label:"Renonciation ‚Äì NEOBSIA", tags:["obs√®ques","renonciation"], description:"Droit de renonciation suite √† souscription NEOBSIA.", subject:"Renonciation ‚Äì Contrat NEOBSIA n¬∞ {{Contrat_Numero}} (souscrit le {{Date_Souscription}})", body:`Madame, Monsieur,

J‚Äôexerce mon droit de renonciation au contrat NEOBSIA n¬∞ {{Contrat_Numero}}, souscrit le {{Date_Souscription}}.
Je vous remercie d‚Äôannuler le contrat et de rembourser les sommes √©ventuellement per√ßues. Merci de me confirmer la prise en compte par √©crit.

Veuillez agr√©er, Madame, Monsieur, mes salutations distingu√©es.` },

  { id:"resiliation_gav", label:"R√©siliation GAV", tags:["GAV","r√©siliation"], description:"R√©siliation √† l‚Äô√©ch√©ance du contrat GAV.", subject:"R√©siliation du contrat GAV n¬∞ {{Contrat_Numero}} ‚Äì √âch√©ance du {{Date_Echeance}}", body:`Madame, Monsieur,

Je vous informe de ma volont√© de r√©silier mon contrat GAV n¬∞ {{Contrat_Numero}} √† son √©ch√©ance du {{Date_Echeance}}.
Merci de m‚Äôadresser une confirmation √©crite mentionnant la date de fin du contrat et l‚Äôarr√™t des pr√©l√®vements.

Veuillez agr√©er, Madame, Monsieur, mes salutations distingu√©es.` }
];

/* ===== Stockage ===== */
const STORAGE_DEFAULTS = 'courrier.defaults';
const STORAGE_USER_TEMPLATES = 'courrier.userTemplates';
const STORAGE_REMOVED_BUILTINS = 'courrier.removedBuiltins';
const STORAGE_LAST_INSURER = 'courrier.lastInsurer';

/* ===== Utils ===== */
const qs = (s, el=document) => el.querySelector(s);
const qsa = (s, el=document) => Array.from(el.querySelectorAll(s));
const slugify = s => String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
const frLongDate = (d=new Date()) => new Intl.DateTimeFormat('fr-FR', { dateStyle: 'long' }).format(d);
function extractPlaceholders(text){ const set=new Set(); const re=/{{\s*([A-Za-z0-9_]+)\s*}}/g; let m; while((m=re.exec(text||''))){ set.add(m[1]); } return Array.from(set); }
function uniquePlaceholders(tpl){ return Array.from(new Set([ ...extractPlaceholders(tpl.subject), ...extractPlaceholders(tpl.body) ])); }
function substitute(str, vars){ return (str||'').replace(/{{\s*([A-Za-z0-9_]+)\s*}}/g,(_,k)=>(vars[k]??`{{${k}}}`)); }
function dedupeById(arr){ const map=new Map(); (arr||[]).forEach(x=>{ if(x && x.id) map.set(x.id, x); }); return Array.from(map.values()); }

/* ===== State ===== */
let userTemplates = [];
let removedBuiltins = [];
let selectedTag = '__all__';
let lastInsurer = '';

/* ===== Defaults (coords) ===== */
function saveDefaults(){
  const data = { expNom:qs('#expNom').value, expOrg:qs('#expOrg').value, expAdr:qs('#expAdr').value, expTel:qs('#expTel').value, expMail:qs('#expMail').value, ville:qs('#ville').value };
  localStorage.setItem(STORAGE_DEFAULTS, JSON.stringify(data));
}
function loadDefaults(){
  const raw = localStorage.getItem(STORAGE_DEFAULTS);
  if(!raw){
    qs('#expNom').value = "Damien Richard ‚Äì Conseiller commercial";
    qs('#expOrg').value = "Harmonie Mutuelle";
    qs('#expAdr').value = "Agence de Nantes\n9 Rue Julien Videment\n44200 Nantes";
    qs('#expTel').value = "";
    qs('#expMail').value = "";
    qs('#ville').value = "Nantes";
    qs('#dateAuto').value = frLongDate();
    return;
  }
  try{ const d=JSON.parse(raw);
    qs('#expNom').value=d.expNom||""; qs('#expOrg').value=d.expOrg||""; qs('#expAdr').value=d.expAdr||"";
    qs('#expTel').value=d.expTel||""; qs('#expMail').value=d.expMail||""; qs('#ville').value=d.ville||""; qs('#dateAuto').value=frLongDate();
  }catch{}
}

/* ===== Templates ===== */
function loadUserTemplates(){ try{ userTemplates = JSON.parse(localStorage.getItem(STORAGE_USER_TEMPLATES)) || []; }catch{ userTemplates=[]; } userTemplates = dedupeById(userTemplates); }
function saveUserTemplates(){ localStorage.setItem(STORAGE_USER_TEMPLATES, JSON.stringify(userTemplates)); }
function loadRemoved(){ try{ removedBuiltins = JSON.parse(localStorage.getItem(STORAGE_REMOVED_BUILTINS)) || []; }catch{ removedBuiltins=[]; } }
function saveRemoved(){ localStorage.setItem(STORAGE_REMOVED_BUILTINS, JSON.stringify(removedBuiltins)); }

function allTemplates(){
  const built = BUILTIN_TEMPLATES.filter(t => !removedBuiltins.includes(t.id)).map(t=>({...t,_isUser:false}));
  const usr = dedupeById(userTemplates).map(t=>({...t,_isUser:true}));
  return dedupeById([...built, ...usr]);
}

/* ===== Tag filter ===== */
function getAllTags(){
  const tagset = new Set();
  allTemplates().forEach(t => (t.tags||[]).forEach(tag => tagset.add(tag)));
  return Array.from(tagset).sort((a,b)=>a.localeCompare(b,'fr',{sensitivity:'base'}));
}
function renderTagFilter(preserve=true){
  const sel = document.getElementById('tagFilter');
  const current = preserve ? selectedTag : '__all__';
  sel.innerHTML = '';
  const optAll = document.createElement('option'); optAll.value='__all__'; optAll.textContent='‚≠ê Tous les tags'; sel.appendChild(optAll);
  getAllTags().forEach(tag => { const o=document.createElement('option'); o.value=tag; o.textContent='‚≠ê '+tag; sel.appendChild(o); });
  sel.value = current || '__all__';
}

/* ===== UI ===== */
function populateTemplates(preserve=true){
  const sel = qs('#templateSelect'); const current = sel.value; sel.innerHTML="";
  let list = allTemplates();
  if(selectedTag && selectedTag !== '__all__'){ list = list.filter(t => (t.tags||[]).includes(selectedTag)); }
  list.sort((a,b)=> a.label.localeCompare(b.label,'fr',{sensitivity:'base'}));
  const seen = new Set();
  list.forEach(t=>{
    if(!t || !t.id || seen.has(t.id)) return; seen.add(t.id);
    const o=document.createElement('option');
    o.value=t.id;
    const label = t.label?.replace(/^‚≠ê\s*/, '') || t.id;
    o.textContent = '‚≠ê ' + label;
    sel.appendChild(o);
  });
  if(preserve && current){ sel.value=current; if(!sel.value) sel.selectedIndex=0; }
  if(!sel.value && sel.options.length>0){ sel.selectedIndex=0; }
  onTemplateChange();
  renderTagFilter(true);
}

function onTemplateChange(){
  const id = qs('#templateSelect').value;
  const tpl = allTemplates().find(t=>t.id===id); if(!tpl) return;
  qs('#templateInfo').textContent = tpl.description||"";
  const chips = qs('#chips'); chips.innerHTML="";
  (tpl.tags||[]).forEach(tag=>{ const s=document.createElement('span'); s.className='chip'; s.textContent=tag; chips.appendChild(s); });
  const ph = uniquePlaceholders(tpl); const dyn = qs('#dynamicFields'); dyn.innerHTML="";
  if(ph.length){ const h=document.createElement('h2'); h.textContent="Champs du mod√®le"; h.style.marginTop="18px"; dyn.appendChild(h); }
  ph.forEach(name=>{ const id='ph_'+name; const lab=document.createElement('label'); lab.htmlFor=id; lab.textContent=name.replaceAll('_',' ');
    const inp=document.createElement('input'); inp.id=id; inp.placeholder=name; dyn.appendChild(lab); dyn.appendChild(inp); });
  renderPreview();
}

function collectVars(){
  const v={ Date:qs('#dateAuto').value||frLongDate(), Ville:qs('#ville').value||"", Dest_Nom:qs('#destNom').value||"", Dest_Attention:qs('#destAttention').value||"", Dest_Adresse:qs('#destAdr').value||"", Exp_Nom:qs('#expNom').value||"", Exp_Org:qs('#expOrg').value||"", Exp_Adr:qs('#expAdr').value||"", Exp_Tel:qs('#expTel').value||"", Exp_Mail:qs('#expMail').value||"" };
  const id = qs('#templateSelect').value; const tpl = allTemplates().find(t=>t.id===id);
  if(tpl){ uniquePlaceholders(tpl).forEach(name=>{ v[name]=qs('#ph_'+name)?.value||""; }); }
  return v;
}
function renderPreview(){
  saveDefaults();
  const id = qs('#templateSelect').value; const tpl = allTemplates().find(t=>t.id===id); if(!tpl) return;
  const v = collectVars();
  const subject = substitute(tpl.subject, v);
  const body = substitute(tpl.body, v).split("\n").map(l=>`<p>${l||"&nbsp;"}</p>`).join("");
  const topRightAddr = (v.Dest_Nom||v.Dest_Attention||v.Dest_Adresse)?`
    <div class="block addr" style="white-space: pre-line; text-align:right;">
      <strong>${v.Dest_Nom||""}</strong>
      ${v.Dest_Attention?`\n${v.Dest_Attention}`:""}
      ${v.Dest_Adresse?`\n${v.Dest_Adresse}`:""}
    </div>`:"";
  qs('#sheet').innerHTML = `
    <div class="letterhead">
      <div style="white-space: pre-line;">
        <strong>${v.Exp_Nom||""}</strong>
        ${v.Exp_Org?`\n${v.Exp_Org}`:""}
        ${v.Exp_Adr?`\n${v.Exp_Adr}`:""}
        ${v.Exp_Tel?`\nT√©l. ${v.Exp_Tel}`:""}
        ${v.Exp_Mail?`\n${v.Exp_Mail}`:""}
      </div>
      <div style="text-align:right;">
        ${v.Ville?`Fait √† ${v.Ville},`:""} le ${v.Date||frLongDate()}
      </div>
    </div>
    ${topRightAddr}
    <div class="subject">Objet : ${subject}</div>
    <div class="body block">${body}</div>
    <div class="footer">
      <div>Cordialement,</div>
      <div style="margin-top: 18px;"><strong>${v.Exp_Nom||""}</strong></div>
      ${v.Exp_Org?`<div>${v.Exp_Org}</div>`:""}
    </div>`;
}

/* ===== Copier & PDF ===== */
async function copyText(){
  const sheet = qs('#sheet').cloneNode(true);
  const text = sheet.innerText.replace(/\n{3,}/g, "\n\n");
  try{ await navigator.clipboard.writeText(text); alert("Copi√© dans le presse-papiers ‚úÖ"); }
  catch{ alert("Impossible de copier automatiquement. S√©lectionnez le texte puis Ctrl/Cmd+C."); }
}
async function downloadPDF(){
  const el = qs('#sheet'); if(!el){ alert("Aper√ßu introuvable."); return; }
  try{
    if(document.fonts && document.fonts.ready){ await document.fonts.ready; }
    const scale = Math.max(2, Math.min(3, (window.devicePixelRatio||2)));
    const canvas = await html2canvas(el, { scale, backgroundColor:'#ffffff', useCORS:true });
    const imgData = canvas.toDataURL('image/jpeg', 0.98);
    const { jsPDF } = window.jspdf || {}; if(!jsPDF) throw new Error('jsPDF non charg√©');
    const pdf = new jsPDF('p','mm','a4'); const pageW = pdf.internal.pageSize.getWidth(); const pageH = pdf.internal.pageSize.getHeight();
    pdf.addImage(imgData, 'JPEG', 0, 0, pageW, pageH); pdf.save('courrier.pdf');
  }catch(e){ console.error(e); alert("PDF indisponible : impression en secours."); window.print(); }
}

/* ===== √âditeur mod√®les perso ===== */
let editorState = { mode:'new', id:null };
function openEditor(mode='new', template=null){
  editorState.mode = mode;
  const isUser = template?._isUser === true;
  qs('#editorCard').style.display = 'block';
  qs('#mdl_name').value = template?.label || '';
  qs('#mdl_tags').value = (template?.tags||[]).join(', ');
  qs('#mdl_desc').value = template?.description || '';
  qs('#mdl_subject').value = template?.subject || '';
  qs('#mdl_body').value = template?.body || '';
  if(mode==='edit' && isUser){
    qs('#mdl_id').value = template.id; qs('#mdl_id').disabled = true; editorState.id = template.id; qs('#mdl_delete').style.display = '';
  } else {
    qs('#mdl_id').value = 'auto'; qs('#mdl_id').disabled = true; editorState.id = null; qs('#mdl_delete').style.display = 'none';
  }
  qs('#editorCard').scrollIntoView({behavior:'smooth', block:'start'});
}
function closeEditor(){ qs('#editorCard').style.display='none'; editorState={mode:'new',id:null}; }
function collectEditor(){
  const name=qs('#mdl_name').value.trim(); const tags=qs('#mdl_tags').value.split(',').map(t=>t.trim()).filter(Boolean);
  const desc=qs('#mdl_desc').value.trim(); const subject=qs('#mdl_subject').value; const body=qs('#mdl_body').value;
  if(!name){ alert("Donnez un nom au mod√®le."); return null; }
  if(!subject){ alert("Renseignez un sujet."); return null; }
  if(!body){ alert("Renseignez un corps de texte."); return null; }
  return {name,tags,desc,subject,body};
}
function saveEditor(){
  const data = collectEditor(); if(!data) return;
  const tpl = { id: editorState.id || `usr_${slugify(data.name)}_${Date.now()}`, label:data.name, tags:data.tags, description:data.desc, subject:data.subject, body:data.body };
  if(editorState.mode==='edit' && editorState.id){
    const idx = userTemplates.findIndex(t=>t.id===editorState.id);
    if(idx>=0) userTemplates[idx]=tpl; else userTemplates.push(tpl);
  } else { userTemplates.push(tpl); }
  saveUserTemplates(); populateTemplates(); renderTagFilter(); qs('#templateSelect').value = tpl.id; onTemplateChange(); alert("Mod√®le enregistr√© ‚úÖ"); closeEditor();
}
function deleteEditor(){
  if(!editorState.id) return; if(!confirm("Supprimer ce mod√®le personnalis√© ?")) return;
  userTemplates = userTemplates.filter(t=>t.id!==editorState.id);
  saveUserTemplates(); populateTemplates(false); renderTagFilter(); alert("Mod√®le supprim√©."); closeEditor();
}

/* ===== Suppression d√©finitive (hard delete) ===== */
function removeCurrentTemplate(){
  const id = qs('#templateSelect').value;
  const tpl = allTemplates().find(t=>t.id===id);
  if(!tpl) return;
  if(!confirm(`Supprimer d√©finitivement le mod√®le : "${tpl.label}" ?`)) return;

  if(tpl._isUser){
    userTemplates = userTemplates.filter(t=>t.id!==id);
    saveUserTemplates();
  } else {
    if(!removedBuiltins.includes(id)) removedBuiltins.push(id);
    saveRemoved();
  }
  populateTemplates(false); renderTagFilter(); alert("Mod√®le supprim√©.");
}

/* ===== Assureurs (pr√©remplissage) ===== */
const INSURERS = [
  { id:'axa', name:'AXA France IARD', attention:'Service R√©siliation', address:['313, Terrasses de l‚ÄôArche','92727 Nanterre Cedex'] },
  { id:'allianz', name:'Allianz', attention:'Service R√©siliation', address:['1 cours Michelet ‚Äì CS 30051','92076 Paris La D√©fense Cedex'] },
  { id:'generali_iard', name:'GENERALI', attention:'Service R√©siliation', address:['GENERALI','75447 Paris Cedex 09'] },
  { id:'generali_vie', name:'GENERALI VIE', attention:'Service R√©siliation', address:['TSA 60006','75446 Paris Cedex 09'] },
  { id:'groupama', name:'Groupama', attention:'Service R√©siliation', address:['8‚Äì10, rue d‚ÄôAstorg','75383 Paris Cedex 08'] },
  { id:'maif', name:'MAIF', attention:'Service R√©siliation', address:['200, avenue Salvador Allende ‚Äì CS 90000','79038 Niort Cedex 9'] },
  { id:'macif', name:'MACIF', attention:'Service R√©siliation', address:['MACIF','79017 Niort Cedex 9'] },
  { id:'maaf', name:'MAAF', attention:'Service R√©siliation', address:['Chauray','79036 Niort Cedex 09'] },
  { id:'gmf', name:'GMF', attention:'Service R√©siliation', address:['148, rue Anatole France','92597 Levallois-Perret Cedex'] },
  { id:'mma', name:'MMA', attention:'Service R√©siliation', address:['160, rue Henri Champion','72030 Le Mans Cedex 9'] },
  { id:'pacifica', name:'Pacifica (Cr√©dit Agricole Assurances)', attention:'Service R√©siliation', address:['8‚Äì10, bd de Vaugirard','75724 Paris Cedex 15'] },
  { id:'predica', name:'Predica (Cr√©dit Agricole Assurances)', attention:'Service R√©siliation', address:['16‚Äì18, bd de Vaugirard','75724 Paris Cedex 15'] },
  { id:'harmonie', name:'Harmonie Mutuelle', attention:'Service R√©siliation', address:['TSA 90130','37049 Tours Cedex 1'] },
  // Nouveaux
  { id:'matmut', name:'Matmut', attention:'Service R√©siliation', address:['66, rue de Sotteville','76030 Rouen Cedex 1'] },
  { id:'april', name:'APRIL (Groupe)', attention:'Service R√©siliation', address:['12 rue Juliette R√©camier ‚Äì CS 15555','69452 Lyon Cedex 06'] },
  { id:'swisslife', name:'Swiss Life France', attention:'Service R√©siliation', address:['1, rue Bellini','92800 Puteaux'] },
  { id:'cardif', name:'BNP Paribas Cardif / Cardif IARD', attention:'Service R√©siliation', address:['1, boulevard Haussmann ‚Äì TSA 93000','75318 Paris Cedex 09'] },
  { id:'abeille', name:'Abeille Assurances (ex Aviva)', attention:'Service R√©siliation', address:['80, avenue de l‚ÄôEurope','92270 Bois-Colombes Cedex'] },
  { id:'cnp', name:'CNP Assurances', attention:'Service R√©clamations / Contrats', address:['TSA 93847','92894 Nanterre Cedex 09'] },
  { id:'malakoff', name:'Malakoff Humanis', attention:'Service R√©siliation', address:['21, rue Laffitte','75009 Paris'] },
  { id:'mgen', name:'MGEN', attention:'Service R√©siliation', address:['3, square Max Hymans','75748 Paris Cedex 15'] },
  { id:'lmg', name:'La Mutuelle G√©n√©rale', attention:'Service R√©siliation', address:['1-11, rue Brillat Savarin ‚Äì CS 21363','75634 Paris Cedex 13'] }
];

function populateInsurers(){
  const sel = qs('#assureurSelect'); if(!sel) return;
  const q = (qs('#assureurSearch')?.value || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  lastInsurer = localStorage.getItem(STORAGE_LAST_INSURER) || '';
  sel.innerHTML = '';
  const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent='‚Äî Saisie manuelle ‚Äî'; sel.appendChild(opt0);
  INSURERS
    .filter(ins => !q || ins.name.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').includes(q))
    .sort((a,b)=>a.name.localeCompare(b.name,'fr',{sensitivity:'base'}))
    .forEach(ins=>{
      const o=document.createElement('option');
      o.value=ins.id; o.textContent='‚≠ê ' + ins.name;
      sel.appendChild(o);
    });
  sel.value = lastInsurer || '';
}
function onInsurerChange(){
  const sel = qs('#assureurSelect'); if(!sel) return;
  const id = sel.value;
  localStorage.setItem(STORAGE_LAST_INSURER, id);
  if(!id){ return; }
  const ins = INSURERS.find(i=>i.id===id); if(!ins) return;
  qs('#destNom').value = ins.name;
  qs('#destAttention').value = ins.attention || '';
  qs('#destAdr').value = (ins.address||[]).join('\n');
  renderPreview();
}

/* ===== Export / Import ===== */
function exportTemplates(){
  const blob = new Blob([JSON.stringify(userTemplates, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='modeles_courrier_perso.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000);
}
function importTemplates(){
  const input=document.createElement('input'); input.type='file'; input.accept='application/json';
  input.addEventListener('change',()=>{
    const file=input.files?.[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=()=>{
      try{ const arr=JSON.parse(reader.result); if(!Array.isArray(arr)) throw new Error('Format invalide');
        const map=new Map(userTemplates.map(t=>[t.id,t])); arr.forEach(t=>{ if(t && t.id) map.set(t.id,t); });
        userTemplates=Array.from(map.values()); saveUserTemplates(); populateTemplates(); renderTagFilter(); alert("Mod√®les import√©s ‚úÖ");
      }catch(e){ alert("Import impossible : "+e.message); }
    };
    reader.readAsText(file);
  });
  input.click();
}

/* ===== Wiring ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  loadUserTemplates(); loadRemoved(); loadDefaults();
  populateTemplates(); renderTagFilter();
  qs('#templateSelect').addEventListener('change', onTemplateChange);
  const tagSel = document.getElementById('tagFilter'); tagSel.addEventListener('change', ()=>{ selectedTag = tagSel.value; populateTemplates(false); });
  populateInsurers();
  const insurerSel = document.getElementById('assureurSelect'); insurerSel && insurerSel.addEventListener('change', onInsurerChange);
  const insurerSearch = document.getElementById('assureurSearch'); insurerSearch && insurerSearch.addEventListener('input', ()=>{ populateInsurers(); });
  qsa('#ville,#dateAuto,#expNom,#expOrg,#expAdr,#expTel,#expMail,#destNom,#destAttention,#destAdr').forEach(el=>el.addEventListener('input', renderPreview));
  qs('#btnPreview').addEventListener('click', renderPreview);
  qs('#btnCopy').addEventListener('click', copyText);
  qs('#btnPDF').addEventListener('click', downloadPDF);
  qs('#btnReset').addEventListener('click', ()=>{ localStorage.removeItem(STORAGE_DEFAULTS); qsa('input, textarea').forEach(i=>{ if(!['templateSelect','dateAuto'].includes(i.id)) i.value=''; }); qs('#dateAuto').value = frLongDate(); renderPreview(); });
  qs('#btnNew').addEventListener('click', ()=>openEditor('new', null));
  qs('#btnEdit').addEventListener('click', ()=>{ const id=qs('#templateSelect').value; const tpl=allTemplates().find(t=>t.id===id); if(!tpl) return; openEditor(tpl._isUser?'edit':'new', tpl); });
  qs('#btnClone').addEventListener('click', ()=>{ const id=qs('#templateSelect').value; const tpl=allTemplates().find(t=>t.id===id); if(!tpl) return; openEditor('new', {...tpl, label: tpl.label + ' (copie)'}); });
  qs('#mdl_save').addEventListener('click', saveEditor);
  qs('#mdl_cancel').addEventListener('click', closeEditor);
  qs('#mdl_delete').addEventListener('click', deleteEditor);
  qs('#btnRemove').addEventListener('click', removeCurrentTemplate);
  qs('#btnExport').addEventListener('click', exportTemplates);
  qs('#btnImport').addEventListener('click', importTemplates);
});
</script>
</body>
</html>
